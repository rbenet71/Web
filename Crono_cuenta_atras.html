<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crono Cuenta Atrás - Control de Salidas para Carreras</title>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CV925PMBQV"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-CV925PMBQV');
    </script>

    <!-- Iconos -->
    <link rel="icon" type="image/png" href="https://rbenet71.github.io/Web/Crono_cuenta_atras_192_192.png">
    <link rel="apple-touch-icon" href="https://rbenet71.github.io/Web/Crono_cuenta_atras_192_192.png">
    
    <!-- PWA -->
    <meta name="theme-color" content="#FF0000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Crono Cuenta Atrás">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #FF0000;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
            --light-gray: #f8f9fa;
            --border-radius: 8px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.15);
            --red-bg: #FF0000;
            --orange-bg: #FFFF00;
            --green-bg: #00FF00;
            --black-transparent: rgba(0, 0, 0, 0.7);
            --white: #FFFFFF;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            transition: background-color 0.5s ease;
        }

        /* Estados de cuenta atrás con colores PUROS y fondo uniforme */
        body.countdown-normal {
            background-color: var(--red-bg) !important;
            background: var(--red-bg) !important;
        }

        body.countdown-warning {
            background-color: var(--orange-bg) !important;
            background: var(--orange-bg) !important;
        }

        body.countdown-critical {
            background-color: var(--orange-bg) !important;
            background: var(--orange-bg) !important;
            animation: pulse-orange 1s infinite;
        }

        body.countdown-salida {
            background-color: var(--green-bg) !important;
            background: var(--green-bg) !important;
        }

        @keyframes pulse-orange {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* ANIMACIÓN AGRESIVA para últimos 5 segundos - VERSIÓN ORIGINAL */
        @keyframes aggressive-pulse {
            0%, 100% { 
                transform: scale(1);
                text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
            }
            25% { 
                transform: scale(1.1);
                text-shadow: 0 0 30px rgba(255, 255, 255, 1);
            }
            50% { 
                transform: scale(1.05);
                text-shadow: 0 0 40px rgba(255, 255, 255, 1);
            }
            75% { 
                transform: scale(1.15);
                text-shadow: 0 0 50px rgba(255, 0, 0, 1);
            }
        }

        /* Clase para números agresivos en últimos 5 segundos - VERSIÓN ORIGINAL */
        .aggressive-numbers .countdown-display {
            animation: aggressive-pulse 0.5s infinite ;
            font-size: 35vw !important;
            color: #ff0000 !important;
            text-shadow: 0 0 30px rgba(255, 0, 0, 0.9);
            transition: all 0.3s ease !important;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* =========================================== */
        /* HEADER REDISEÑADO - MÁS ELEGANTE */
        /* =========================================== */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, #1a2530 100%);
            color: white;
            padding: 20px 0;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--secondary), var(--success), var(--warning), var(--danger));
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 0;
        }

        .app-logo {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            object-fit: cover;
            border: 3px solid var(--secondary);
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.4);
            transition: transform 0.3s ease;
        }

        .app-logo:hover {
            transform: rotate(10deg);
        }

        .app-title h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(90deg, #fff, var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .language-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .languages-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .flag {
            width: 32px;
            height: 22px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s;
            border: 2px solid transparent;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .flag:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .flag.active {
            opacity: 1;
            border: 2px solid var(--secondary);
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.6);
        }

        .flag-catalunya {
            background: linear-gradient(
                to bottom,
                #ffcd00 0%, #ffcd00 10%,
                #da121a 10%, #da121a 20%,
                #ffcd00 20%, #ffcd00 30%,
                #da121a 30%, #da121a 40%,
                #ffcd00 40%, #ffcd00 50%,
                #da121a 50%, #da121a 60%,
                #ffcd00 60%, #ffcd00 70%,
                #da121a 70%, #da121a 80%,
                #ffcd00 80%, #ffcd00 90%,
                #da121a 90%, #da121a 100%
            );
        }

        .help-icon {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.3s;
            padding: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
        }

        .help-icon:hover {
            color: var(--secondary);
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(15deg);
        }

        /* =========================================== */
        /* CONTENIDO PRINCIPAL - REDISEÑADO COMPLETO */
        /* =========================================== */
        .main-content {
            padding: 30px 0;
            min-height: calc(100vh - 200px);
        }

        .app-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .app-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-5px);
        }

        .card-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #e9ecef;
        }

        .card-header h2 {
            color: var(--primary);
            font-size: 1.6rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
        }

        .card-header h2 i {
            color: var(--secondary);
            font-size: 1.4rem;
        }

        .card-body {
            padding: 30px;
        }

        /* =========================================== */
        /* SECCIONES DE CONFIGURACIÓN - ORGANIZADAS */
        /* =========================================== */
        .config-section {
            margin-bottom: 35px;
        }

        .section-title {
            font-size: 1.2rem;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .section-title i {
            color: var(--secondary);
        }

        /* Formularios mejorados */
        .form-group {
            margin-bottom: 25px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 1rem;
            min-width: 180px;
        }

        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #fff;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .form-control-sm {
            padding: 10px 14px;
            font-size: 0.95rem;
        }

        .form-inline-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-with-unit {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .input-with-unit input {
            width: 80px;
            text-align: center;
        }

        .unit {
            color: var(--gray);
            font-weight: 500;
            min-width: 70px;
        }

        /* =========================================== */
        /* BOTONES REDISEÑADOS - CONSISTENTES */
        /* =========================================== */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            font-size: 1rem;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            min-height: 50px;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }

        .btn-sm {
            padding: 10px 20px;
            font-size: 0.9rem;
            min-height: 42px;
        }

        .btn-lg {
            padding: 18px 40px;
            font-size: 1.2rem;
            min-height: 60px;
        }

        .btn-block {
            width: 100%;
            display: flex;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary) 0%, #2980b9 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2980b9 0%, #1c5a7a 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #27ae60 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(46, 204, 113, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d68910 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #d68910 0%, #a8640a 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(243, 156, 18, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b 0%, #922b21 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(231, 76, 60, 0.4);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #e0e0e0;
            color: var(--dark);
        }

        .btn-outline:hover {
            background: #f8f9fa;
            border-color: var(--secondary);
            color: var(--secondary);
        }

        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn-group-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* =========================================== */
        /* TARJETA DE GESTIÓN DE CARRERA */
        /* =========================================== */
        .race-management-card {
            border-left: 5px solid var(--secondary);
        }

        .race-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            width: 100%;
        align-items: stretch;
        }

        .race-selector select {
            flex: 1 1 300px; /* Crece, encoge, mínimo 300px */
            min-width: 200px; /* Ancho mínimo */
            max-width: 100%; /* Nunca más ancho que el contenedor */
        }

        .race-selector .btn {
            flex: 0 0 auto; /* Tamaño fijo según contenido */
            white-space: nowrap; /* Texto en una línea */
            min-width: 100px; /* Ancho mínimo para botones */
            width: 100%;
        }

        /* =========================================== */
        /* TARJETA DE CONFIGURACIÓN DE TIEMPOS */
        /* =========================================== */
        .time-config-card {
            border-left: 5px solid var(--success); 
        }

        .time-mode-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .mode-btn {
            flex: 1;
            min-width: 200px;
        }

        .time-inputs {
            background: #f8f9fa;
            padding: 25px;
            border-radius: var(--border-radius);
            border: 1px dashed #dee2e6;
        }

        .interval-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: 12px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .interval-row:hover {
            border-color: var(--secondary);
            background: #f8fafc;
        }

        .interval-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .interval-range {
            font-weight: 600;
            color: var(--primary);
            min-width: 140px;
        }

        .interval-time {
            color: var(--secondary);
            font-weight: 600;
        }

        /* =========================================== */
        /* TARJETA DE PUNTO DE INICIO */
        /* =========================================== */
        .start-point-card {
            border-left: 5px solid var(--warning);
        }

        .start-options {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* =========================================== */
        /* BOTÓN DE INICIO PRINCIPAL - DESTACADO */
        /* =========================================== */
        .start-main-btn-container {
            text-align: center;
            margin: 40px 0;
            padding: 30px;
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.1) 0%, rgba(52, 152, 219, 0.1) 100%);
            border-radius: var(--border-radius);
            border: 2px dashed var(--success);
        }

        .start-main-btn {
            min-width: 300px;
            padding: 22px 50px;
            font-size: 1.3rem;
            background: linear-gradient(135deg, var(--success) 0%, var(--secondary) 100%);
            position: relative;
            overflow: hidden;
        }

        .start-main-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.7s ease;
        }

        .start-main-btn:hover::before {
            left: 100%;
        }

        /* =========================================== */
        /* TARJETA DE SALIDAS REGISTRADAS */
        /* =========================================== */
        .departures-card {
            border-left: 5px solid var(--danger);
        }

        .departures-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .departure-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
        }

        .departure-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f1f1f1;
            font-variant-numeric: tabular-nums;
            transition: background 0.2s ease;
        }

        .departure-item:last-child {
            border-bottom: none;
        }

        .departure-item:hover {
            background: #f8fafc;
        }

        .departure-number {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .departure-time {
            color: var(--gray);
            font-size: 0.95rem;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* ================================================ */
        /* PANTALLA DE EJECUCIÓN - CON ELEMENTOS PEGADOS A ESQUINAS */
        /* ================================================ */

        .countdown-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1000;
            transition: background-color 0.5s ease;
        }

        .countdown-screen.active {
            display: block;
        }

        /* Contenedor principal que centra el número */
        .countdown-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            position: relative;
        }

        /* Display principal de cuenta atrás - CENTRADO VERTICALMENTE */
        .countdown-display {
            font-size: 30vw;
            font-weight: 900;
            color: white;
            text-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            font-variant-numeric: tabular-nums;
            margin: 0;
            line-height: 1;
            text-align: center;
            transition: all 0.3s ease;
        }

        /* Texto "Próxima salida en" - CENTRADO EN ESPACIO DISPONIBLE */
        .countdown-label {
            color: white;
            text-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
            text-align: center;
            font-weight: 600;
            box-sizing: border-box;
            transition: opacity 0.3s ease;
            position: absolute;
            top: 10px; /* PEGADO AL EXTREMO SUPERIOR */
            left: 0;
            right: 0;
            z-index: 10;
            margin: 0;
            padding: 0 120px; /* ESPACIO REDUCIDO para esquinas pegadas */
            line-height: 50px; 
            height: 50px; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4vw;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        /* Elementos de información en pantalla - PEGADOS A ESQUINAS */
        .info-corner {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 8px 12px;
            border-radius: 0; /* SIN BORDES REDONDEADOS para esquinas */
            text-align: center;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid rgba(255, 255, 255, 0.2);
            min-width: 160px;
            height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .info-corner:hover {
            background-color: rgba(0, 0, 0, 0.8);
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.4);
        }

        /* ESQUINA SUPERIOR IZQUIERDA - PEGADA AL EXTREMO */
        .top-left {
            top: 0;
            left: 0;
            border-top-left-radius: 0;
            border-bottom-right-radius: 10px;
        }

        /* ESQUINA INFERIOR IZQUIERDA - PEGADA AL EXTREMO */
        .bottom-left {
            bottom: 0;
            left: 0;
            border-bottom-left-radius: 0;
            border-top-right-radius: 10px;
        }

        /* ESQUINA INFERIOR DERECHA - PEGADA AL EXTREMO */
        .bottom-right {
            bottom: 0;
            right: 0;
            border-bottom-right-radius: 0;
            border-top-left-radius: 10px;

        }

        .info-label {
            font-size: 0.9vw;
            opacity: 0.8;
            margin-bottom: 2px;
            display: block;
            line-height: 1.1;

            margin-bottom: 0; 
        }

        .info-value {
            font-size: 1.8vw;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            line-height: 1.2;
        }

        /* Icono de configuración - ESQUINA SUPERIOR DERECHA PEGADA */
        .config-toggle {
            position: absolute;
            top: 0; /* PEGADO AL EXTREMO SUPERIOR */
            right: 0; /* PEGADO AL EXTREMO DERECHO */
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 0; /* SIN BORDES REDONDEADOS */
            border-bottom-left-radius: 10px; /* Solo esquina inferior izquierda redondeada */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            z-index: 1002;
        }

        .config-toggle:hover {
            background-color: rgba(0, 0, 0, 0.8);
            transform: scale(1.1) rotate(90deg);
            border-color: rgba(255, 255, 255, 0.4);
        }

        /* Display de SALIDA - AJUSTADO AUTOMÁTICAMENTE A LA PANTALLA */
        .salida-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: 900;
            color: white;
            text-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1003;
            animation: salida-pulse 0.5s infinite alternate;
            text-align: center;
            line-height: 1.1;
            margin: 0;
            padding: 0;
            /* TAMAÑO DINÁMICO que se ajusta automáticamente */
            font-size: 20vw; /* Tamaño base */
            max-width: 90%; /* Nunca más del 90% del ancho */
            max-height: 90%; /* Nunca más del 90% del alto */
            overflow: hidden;
            word-wrap: break-word;
            white-space: normal;
            display: flex;
            align-items: center;
            justify-content: center;
            width: auto;
        }

        /* Clase para calcular tamaño óptimo - se añadirá con JavaScript */
        .salida-display.auto-size {
            font-size: min(20vw, 20vh); /* Usa el menor entre ancho y alto */
            padding: 0 5%;
        }

        @keyframes salida-pulse {
            from {
                transform: translate(-50%, -50%) scale(1);
                text-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
            }
            to {
                transform: translate(-50%, -50%) scale(1.1);
                text-shadow: 0 0 60px rgba(255, 255, 255, 1);
            }
        }

        .salida-display.show {
            opacity: 1;
        }

        /* Ajuste para cuando se muestra SALIDA */
        .countdown-screen.countdown-salida-active .countdown-container {
            justify-content: center; /* Mantiene centrado verticalmente */
        }

        .countdown-screen.countdown-salida-active .countdown-label {
            opacity: 0 !important;
            visibility: hidden !important;
        }

        /* CORRECCIÓN: Ocultar número detrás de SALIDA */
        .countdown-screen.countdown-salida-active .countdown-display {
            display: none !important;
        }

        .countdown-screen.countdown-salida-active .salida-display.show {
            display: flex !important;
            opacity: 1 !important;
        }

        /* =========================================== */
        /* FOOTER REDISEÑADO */
        /* =========================================== */
        .app-footer {
            background: linear-gradient(135deg, var(--primary) 0%, #1a2530 100%);
            color: white;
            padding: 30px 0;
            margin-top: 40px;
            border-top: 4px solid var(--secondary);
        }

        .footer-content {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 25px;
        }

        .footer-left {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Ajusta automáticamente */
            gap: 10px;
            width: 100%;
        }

        /* =========================================== */
        /* BOTONES DEL FOOTER - ESTILO UNIFICADO */
        /* =========================================== */
        .footer-btn {
            width: 100%;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            white-space: nowrap;
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); /* Color morado elegante */
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(155, 89, 182, 0.3);
        }

        .footer-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        .footer-btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }

        .footer-btn:hover {
            background: linear-gradient(135deg, #8e44ad 0%, #732d91 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(155, 89, 182, 0.4);
        }

        .footer-btn:active {
            transform: translateY(-1px);
        }

        .footer-btn i {
            font-size: 1.1rem;
        }

        /* Para mantener la disposición grid del footer */
        .footer-left {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            width: 100%;
        }

        /* Versión para móviles */
        @media (max-width: 768px) {
            .footer-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
                min-height: 44px;
            }
            
            .footer-left {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .footer-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
                min-height: 40px;
            }
            
            .footer-left {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }

        .copyright {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            text-align: right;
        }

        .copyright a {
            color: var(--secondary);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .copyright a:hover {
            color: white;
            text-decoration: underline;
        }

        /* =========================================== */
        /* MODALES (ESTILOS MEJORADOS) */
        /* =========================================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary) 0%, #1a2530 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h3 {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: white;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            background: #f8f9fa;
            border-radius: 0 0 15px 15px;
        }

        /* Config modal durante cuenta atrás */
        .config-modal-during-countdown {
            background-color: rgba(0, 0, 0, 0.85) !important;
        }

        .config-modal-during-countdown .modal-content {
            background: var(--primary) !important;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        /* CONTENEDOR */
        .modal-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        /* BOTONES */
        .modal-buttons-container .btn {
            width: 100% !important; /* Ocupa todo el ancho */
            min-height: 55px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Texto a la izquierda */
            text-align: left;
            font-size: 1rem;
            border-radius: 8px;
        }

        /* ÍCONOS */
        .modal-buttons-container .btn i {
            margin-right: 12px;
            min-width: 24px;
            font-size: 1.1rem;
        }






        /* =========================================== */
        /* MENSAJES DE ESTADO */
        /* =========================================== */
        .message {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 18px 24px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: none;
            z-index: 3000;
            max-width: 400px;
            animation: slideIn 0.3s ease;
            backdrop-filter: blur(10px);
            border-left: 5px solid;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .message.success {
            background: rgba(46, 204, 113, 0.95);
            border-left-color: #27ae60;
        }

        .message.error {
            background: rgba(231, 76, 60, 0.95);
            border-left-color: #c0392b;
        }

        .message.warning {
            background: rgba(243, 156, 18, 0.95);
            border-left-color: #d68910;
            color: #333;
        }

        .message.info {
            background: rgba(52, 152, 219, 0.95);
            border-left-color: #2980b9;
        }

        /* =========================================== */
        /* EDITORES INLINE */
        /* =========================================== */
        .inline-edit {
            cursor: pointer;
            padding: 0px;
            border-radius: 6px;
            transition: background-color 0.3s;
        }

        .inline-edit:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .inline-edit-input {
            background: transparent;
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: inherit;
            font-weight: inherit;
            text-align: center;
            width: 100%;
            padding: 8px;
            border-radius: 6px;
        }

        /* =========================================== */
        /* OCULTAR ELEMENTOS EN EJECUCIÓN */
        /* =========================================== */
        .hide-on-countdown {
            transition: opacity 0.3s;
        }

        .countdown-screen.active ~ .hide-on-countdown {
            opacity: 0;
            pointer-events: none;
        }

        /* =========================================== */
        /* RESPONSIVE */
        /* =========================================== */
        @media (max-width: 992px) {
            .form-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .form-label {
                min-width: 100%;
                margin-bottom: 5px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .mode-btn {
                min-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .app-title h1 {
                font-size: 24px;
            }
            
            .language-selector {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .card-body {
                padding: 20px;
            }
            
            .modal-content {
                width: 95%;
            }
            
            .footer-content {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .footer-left {
                justify-content: center;
            }
            
            .copyright {
                text-align: center;
            }
            
            .start-main-btn {
                min-width: 100%;
                padding: 18px 30px;
            }
            
            /* Responsive para pantalla de ejecución */
            .countdown-display {
                font-size: 40vw;
            }
            
            .aggressive-numbers .countdown-display {
                font-size: 45vw !important;
            }
            
            /* Texto "Próxima salida en" en móviles */
            .countdown-label {
                top: 0;
                height: 45px;
                line-height: 45px;
                padding: 0 100px; /* Espacio reducido */
                font-size: 5vw;
            }
            
            /* Ajustes para info-corner en móviles */
            .info-corner {
                min-width: 140px;
                height: 45px;
                padding: 6px 10px;
            }
            
            .config-toggle {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            .info-label {
                font-size: 10px;
            }
            
            .info-value {
                font-size: 16px;
            }
            
            /* SALIDA ajustado automáticamente para móviles */
            .salida-display {
                font-size: min(18vw, 18vh); /* Se ajusta al menor dimension */
                max-width: 95%;
                max-height: 95%;
            }
        }

        @media (max-width: 480px) {
            .app-title {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .app-logo {
                width: 60px;
                height: 60px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 0.95rem;
            }
            
            .btn-lg {
                padding: 16px 30px;
                font-size: 1.1rem;
            }
            
            .interval-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .departures-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .message {
                left: 15px;
                right: 15px;
                max-width: none;
            }
            
            .start-options {
                flex-direction: column;
                align-items: flex-start;
            }
            
            /* Responsive para pantalla de ejecución - móviles pequeños */
            .countdown-display {
                font-size: 50vw;
            }
            
            .aggressive-numbers .countdown-display {
                font-size: 55vw !important;
            }
            
            /* Texto "Próxima salida en" en móviles pequeños */
            .countdown-label {
                top: 0;
                height: 40px;
                line-height: 40px;
                padding: 0 80px; /* Espacio mínimo */
                font-size: 6vw;
            }
            
            /* Ajustes para info-corner en móviles pequeños */
            .info-corner {
                min-width: 120px;
                height: 40px;
                padding: 4px 8px;
            }
            
            .config-toggle {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .info-label {
                font-size: 9px;
                margin-bottom: 1px;
            }
            
            .info-value {
                font-size: 14px;
            }
            
            /* SALIDA en móviles pequeños - ajuste más agresivo */
            .salida-display {
                font-size: min(16vw, 16vh);
                max-width: 98%;
                max-height: 98%;
                padding: 0 3%;
            }
            
            /* Ocultar texto si no cabe en pantallas muy pequeñas */
            @media (max-width: 360px) {
                .countdown-label {
                    font-size: 5.5vw;
                    padding: 0 70px;
                }
                
                .info-corner {
                    min-width: 110px;
                    height: 35px;
                    padding: 3px 6px;
                }
                
                .config-toggle {
                    width: 35px;
                    height: 35px;
                    font-size: 14px;
                }
                
                .salida-display {
                    font-size: min(14vw, 14vh);
                    max-width: 99%;
                }
            }
        }

        /* Orientación horizontal específica */
        @media (max-height: 500px) and (orientation: landscape) {
            .salida-display {
                font-size: min(15vw, 15vh); /* Más pequeño en landscape */
                max-width: 85%;
            }
            
            .countdown-label {
                height: 35px;
                line-height: 35px;
                font-size: 4vw;
            }
            
            .info-corner {
                height: 35px;
            }
            
            .config-toggle {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- =========================================== -->
    <!-- HEADER -->
    <!-- =========================================== -->
    <header class="app-header hide-on-countdown">
        <div class="container">
            <div class="header-content">
                <div class="app-title">
                    <img src="https://rbenet71.github.io/Web/Crono_cuenta_atras_192_192.png" 
                         alt="Logo Crono Cuenta Atrás" 
                         class="app-logo">
                    <h1 id="app-title-text">Crono Cuenta Atrás</h1>
                </div>
                <div class="header-controls">
                    <div class="language-selector">
                        <div class="languages-label" id="languages-label">Idioma / Language</div>
                        <img src="https://flagcdn.com/w40/es.png" class="flag active" id="flag-es" data-lang="es">
                        <div class="flag flag-catalunya" id="flag-ca" data-lang="ca"></div>
                        <img src="https://flagcdn.com/w40/gb.png" class="flag" id="flag-en" data-lang="en">
                        <img src="https://flagcdn.com/w40/fr.png" class="flag" id="flag-fr" data-lang="fr">
                        <i class="fas fa-question-circle help-icon" id="help-icon-header" title="Ayuda"></i>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- =========================================== -->
    <!-- CONTENIDO PRINCIPAL - CONFIGURACIÓN -->
    <!-- =========================================== -->
    <main class="main-content hide-on-countdown">
        <div class="container">
            <!-- Tarjeta 1: Gestión de carrera -->
            <div class="app-card race-management-card">
                <div class="card-header">
                    <h2><i class="fas fa-flag-checkered"></i> <span id="card-race-title">Gestión de Carrera</span></h2>
                </div>
                <div class="card-body">
                    <div class="config-section">
                        <div class="section-title">
                            <i class="fas fa-list"></i>
                            <span id="race-management-title">Selección de carrera</span>
                        </div>
                        <div class="form-group">
                            <div class="form-row">
                                <label for="race-select" class="form-label" id="race-select-label">Carrera actual:</label>
                                <div class="race-selector">
                                    <select id="race-select" class="form-control">
                                        <option value="">-- Selecciona una carrera --</option>
                                    </select>
                                    <button class="btn btn-primary" id="new-race-btn">
                                        <i class="fas fa-plus"></i>
                                        <span id="new-race-text">Nueva</span>
                                    </button>
                                    <button class="btn btn-danger" id="delete-race-btn">
                                        <i class="fas fa-trash"></i>
                                        <span id="delete-race-text">Eliminar</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tarjeta 2: Configuración de tiempos -->
            <div class="app-card time-config-card">
                <div class="card-header">
                    <h2><i class="fas fa-clock"></i> <span id="card-time-title">Configuración de Tiempos</span></h2>
                </div>
                <div class="card-body">
                    <div class="config-section">
                        <div class="section-title">
                            <i class="fas fa-sliders-h"></i>
                            <span id="cadence-title">Cadencia de salida</span>
                        </div>
                        <div class="time-mode-selector">
                            <button class="btn btn-primary mode-btn" id="same-interval-btn">
                                <i class="fas fa-equals"></i>
                                <span id="same-interval-text">Siempre igual</span>
                            </button>
                            <button class="btn btn-warning mode-btn" id="variable-interval-btn">
                                <i class="fas fa-list-ol"></i>
                                <span id="variable-interval-text">Varios tramos</span>
                            </button>
                        </div>

                        <!-- Configuración de intervalo único -->
                        <div id="single-interval-config" class="time-inputs">
                            <div class="form-group">
                                <div class="section-title">
                                    <i class="fas fa-stopwatch"></i>
                                    <span id="interval-time-label">Tiempo entre salidas</span>
                                </div>
                                <div class="form-row">
                                    <div class="input-with-unit">
                                        <input type="number" id="interval-minutes" class="form-control form-control-sm" min="0" value="1">
                                        <span class="unit" id="minutes-text">minutos</span>
                                    </div>
                                    <div class="input-with-unit">
                                        <input type="number" id="interval-seconds" class="form-control form-control-sm" min="0" max="59" value="0">
                                        <span class="unit" id="seconds-text">segundos</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Configuración de intervalos variables -->
                        <div id="variable-interval-config" class="time-inputs" style="display: none;">
                            <div class="form-group">
                                <div class="section-title">
                                    <i class="fas fa-plus-circle"></i>
                                    <span id="add-interval-label">Añadir nuevo tramo</span>
                                </div>
                                <div class="form-row">
                                    <div class="input-with-unit">
                                        <input type="number" id="from-corredor" class="form-control form-control-sm" min="1" value="1">
                                        <span class="unit">desde</span>
                                    </div>
                                    <div class="input-with-unit">
                                        <input type="number" id="to-corredor" class="form-control form-control-sm" min="1" value="10">
                                        <span class="unit" id="to-text">hasta</span>
                                    </div>
                                    <div class="input-with-unit">
                                        <input type="number" id="var-minutes" class="form-control form-control-sm" min="0" value="1">
                                        <span class="unit">min</span>
                                    </div>
                                    <div class="input-with-unit">
                                        <input type="number" id="var-seconds" class="form-control form-control-sm" min="0" max="59" value="0">
                                        <span class="unit">seg</span>
                                    </div>
                                    <button class="btn btn-success" id="add-interval-btn">
                                        <i class="fas fa-plus"></i>
                                        <span id="add-interval-text">Añadir</span>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="section-title">
                                    <i class="fas fa-list-ul"></i>
                                    <span>Tramos configurados</span>
                                </div>
                                <div id="intervals-list">
                                    <!-- Los intervalos se agregarán aquí dinámicamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tarjeta 3: Punto de inicio -->
            <div class="app-card start-point-card">
                <div class="card-header">
                    <h2><i class="fas fa-flag"></i> <span id="card-start-title">Punto de Inicio</span></h2>
                </div>
                <div class="card-body">
                    <div class="config-section">
                        <div class="section-title">
                            <i class="fas fa-play"></i>
                            <span id="start-from-label">Iniciar desde</span>
                        </div>
                        <div class="start-options">
                            <button class="btn btn-primary" id="start-from-zero-btn">
                                <i class="fas fa-play"></i>
                                <span id="start-from-zero-text">Comenzar desde el corredor 1</span>
                            </button>
                            <div class="form-inline-group">
                                <span id="start-from-x-text">O desde la posición:</span>
                                <input type="number" id="start-position" class="form-control form-control-sm" min="1" value="1" style="width: 120px;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botón principal de inicio -->
            <div class="start-main-btn-container">
                <button class="btn btn-success btn-lg start-main-btn" id="start-countdown-btn">
                    <i class="fas fa-rocket"></i>
                    <span id="start-countdown-text">INICIAR CUENTA ATRÁS</span>
                </button>
            </div>

            <!-- Tarjeta 4: Salidas registradas -->
            <div class="app-card departures-card">
                <div class="card-header">
                    <h2><i class="fas fa-history"></i> <span id="card-departures-title">Salidas Registradas</span></h2>
                </div>
                <div class="card-body">
                    <div class="config-section">
                        <div class="departures-header">
                            <div class="section-title">
                                <i class="fas fa-clipboard-list"></i>
                                <span id="departures-label">Historial de salidas</span>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-danger" id="clear-departures-btn">
                                    <i class="fas fa-broom"></i>
                                    <span id="clear-departures-text">Limpiar lista</span>
                                </button>
                                <button class="btn btn-success" id="export-excel-btn">
                                    <i class="fas fa-file-excel"></i>
                                    <span id="export-excel-text">Exportar Excel</span>
                                </button>
                            </div>
                        </div>
                        <div id="departures-list" class="departure-list">
                            <!-- Las salidas se agregarán aquí dinámicamente -->
                            <div class="empty-state">
                                <i class="fas fa-clock"></i>
                                <p>No hay salidas registradas</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- =========================================== -->
    <!-- PANTALLA DE EJECUCIÓN (REDISEÑADA) -->
    <!-- =========================================== -->
    <div class="countdown-screen" id="countdown-screen">
        <div class="config-toggle" id="config-toggle">
            <i class="fas fa-cog"></i>
        </div>

        <div class="countdown-container">
            <div class="countdown-label" id="countdown-label">Salida en</div>
            <div class="countdown-display" id="countdown-display">60</div>
        </div>

        <div class="info-corner top-left">
            <span class="info-label" id="total-time-label">Tiempo total</span>
            <div class="info-value" id="total-time-value">00:00:00</div>
        </div>
        
        <div class="info-corner bottom-left">
            <span class="info-label" id="next-corredor-label">Próximo sale a</span>
            <div class="info-value inline-edit" id="next-corredor-time">1:00</div>
        </div>
        
        <div class="info-corner bottom-right">
            <span class="info-label" id="departed-label">Salidos</span>
            <div class="info-value inline-edit" id="departed-count">0</div>
        </div>

        <div class="salida-display" id="salida-display">SALIDA</div>
    </div>

    <!-- =========================================== -->
    <!-- FOOTER -->
    <!-- =========================================== -->
    <footer class="app-footer hide-on-countdown">
        <div class="container">
            <div class="footer-content">
                <div class="footer-left">
                    <button class="footer-btn" id="footer-help-btn">
                        <i class="fas fa-question-circle"></i>
                        <span id="help-text">Ayuda</span>
                    </button>
                    <button class="footer-btn" id="suggestions-btn">
                        <i class="fas fa-lightbulb"></i>
                        <span id="suggestions-text">Sugerencias</span>
                    </button>
                    <button class="footer-btn" id="install-btn">
                        <i class="fas fa-download"></i>
                        <span id="install-text">Instalar App</span>
                    </button>
                    <button class="footer-btn" id="update-btn">
                        <i class="fas fa-sync-alt"></i>
                        <span id="update-text">Buscar actualizaciones</span>
                    </button>
                </div>
                <div class="copyright" id="copyright-text">
                    2025 © Copyright 
                    <a href="https://rbenet71.github.io/Web/" target="_blank" id="copyright-link">
                        Roberto Benet - rbenet71@gmail.com
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- =========================================== -->
    <!-- MODALES -->
    <!-- =========================================== -->
    
    <!-- Modal de ayuda -->
    <div class="modal" id="help-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="help-modal-title">Ayuda de Crono Cuenta Atrás</h3>
                <button class="modal-close" id="help-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="help-modal-text1">Crono Cuenta Atrás es una aplicación para controlar las salidas en carreras con cuenta atrás visual y sonora.</p>
                
                <h4 id="help-modal-subtitle1">Cómo usar:</h4>
                <ul id="help-modal-list">
                    <li><strong>Selecciona una carrera</strong> o crea una nueva</li>
                    <li><strong>Configura la cadencia de salida</strong> (siempre igual o por tramos)</li>
                    <li><strong>Inicia desde el corredor 1</strong> o desde una posición específica</li>
                    <li><strong>Pulsa "INICIAR CUENTA ATRÁS"</strong> para comenzar</li>
                    <li><strong>La pantalla cambiará</strong> mostrando la cuenta atrás grande</li>
                    <li><strong>Cuando llegue a cero</strong> se mostrará "SALIDA" y comenzará la cuenta para el siguiente</li>
                </ul>
                
                <h4 id="help-modal-subtitle2">Indicadores visuales:</h4>
                <ul>
                    <li><strong style="color: #FF0000; background: #000; padding: 2px 5px;">Fondo ROJO:</strong> Cuenta atrás normal</li>
                    <li><strong style="color: #FFFF00; background: #000; padding: 2px 5px;">Fondo AMARILLO:</strong> Últimos 10 segundos</li>
                    <li><strong style="color: #00FF00; background: #000; padding: 2px 5px;">Fondo VERDE:</strong> Momento de salida (2 segundos)</li>
                    <li><strong style="color: #FF0000; background: #000; padding: 2px 5px;">Números ROJOS pulsantes:</strong> Últimos 5 segundos</li>
                </ul>
                
                <h4 id="help-modal-subtitle3">Sonidos:</h4>
                <ul>
                    <li><strong>Beep agudo:</strong> Al llegar a 10 segundos</li>
                    <li><strong>Beep cada segundo:</strong> Últimos 5 segundos</li>
                    <li><strong>Beep grave:</strong> Al llegar a cero</li>
                </ul>
                
                <p id="help-modal-text2">Los 2 segundos de "SALIDA" se restan automáticamente del tiempo de la siguiente cuenta atrás.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="help-modal-ok">Entendido</button>
            </div>
        </div>
    </div>

    <!-- Modal de configuración durante cuenta atrás -->
    <div class="modal" id="config-during-countdown-modal">
        <div class="modal-content config-modal-during-countdown">
            <div class="modal-header">
                <h3>Configuración</h3>
                <button class="modal-close" id="config-during-countdown-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>La cuenta atrás continúa en segundo plano.</p>
                <div class="modal-buttons-container">
                    <button class="btn btn-success" id="resume-countdown-btn">
                        <i class="fas fa-play"></i> Continuar viendo
                    </button>
                    <button class="btn btn-warning" id="stop-countdown-btn">
                        <i class="fas fa-stop"></i> Detener cuenta atrás
                    </button>
                    <button class="btn btn-primary" id="adjust-times-btn">
                        <i class="fas fa-edit"></i> Ajustar tiempos
                    </button>
                    <button class="btn btn-danger" id="exit-countdown-btn">
                        <i class="fas fa-sign-out-alt"></i> Salir completamente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de ajuste de tiempos -->
    <div class="modal" id="adjust-times-modal">
        <div class="modal-content config-modal-during-countdown">
            <div class="modal-header">
                <h3>Ajustar Tiempos</h3>
                <button class="modal-close" id="adjust-times-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="config-line" style="flex-direction: column; align-items: stretch;">
                    <label for="adjust-next-time">Próximo tiempo (segundos):</label>
                    <input type="number" id="adjust-next-time" class="config-input" min="1" value="60">
                </div>
                <div class="config-line" style="flex-direction: column; align-items: stretch;">
                    <label for="adjust-departed">Corredores salidos:</label>
                    <input type="number" id="adjust-departed" class="config-input" min="0" value="0">
                </div>
                <div class="config-line" style="flex-direction: column; align-items: stretch;">
                    <label for="adjust-current-time">Tiempo actual (segundos):</label>
                    <input type="number" id="adjust-current-time" class="config-input" min="0" value="60">
                </div>
                <div class="modal-buttons-container">
                    <button class="btn btn-success" id="save-adjustments-btn">
                        <i class="fas fa-save"></i> Guardar ajustes
                    </button>
                    <button class="btn" id="cancel-adjustments-btn">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación eliminar carrera -->
    <div class="modal" id="delete-race-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="delete-race-modal-title">Confirmar eliminación</h3>
                <button class="modal-close" id="delete-race-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="delete-race-modal-text">¿Estás seguro de que quieres eliminar esta carrera? Todos los datos se perderán.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="delete-race-confirm-btn">Eliminar</button>
                <button class="btn" id="delete-race-cancel-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación limpiar salidas -->
    <div class="modal" id="clear-departures-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="clear-departures-modal-title">Confirmar limpieza</h3>
                <button class="modal-close" id="clear-departures-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="clear-departures-modal-text">¿Estás seguro de que quieres limpiar la lista de salidas? Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="clear-departures-confirm-btn">Limpiar</button>
                <button class="btn" id="clear-departures-cancel-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de sugerencias -->
    <div class="modal" id="suggestions-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="suggestions-modal-title">Enviar sugerencias</h3>
                <button class="modal-close" id="suggestions-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="suggestion-form">
                    <div class="config-line" style="flex-direction: column; align-items: stretch;">
                        <label for="suggestion-email" id="suggestion-email-label">Email (opcional):</label>
                        <input type="email" id="suggestion-email" class="config-input" placeholder="tu@email.com">
                    </div>
                    <div class="config-line" style="flex-direction: column; align-items: stretch;">
                        <label for="suggestion-text" id="suggestion-text-label">Sugerencias:</label>
                        <textarea id="suggestion-text" class="config-input" rows="5" placeholder="Tus ideas para mejorar la aplicación..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="send-suggestion-btn">Enviar</button>
                <button class="btn" id="cancel-suggestion-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de nueva carrera -->
    <div class="modal" id="new-race-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="new-race-modal-title">Nueva carrera</h3>
                <button class="modal-close" id="new-race-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="config-line" style="flex-direction: column; align-items: stretch;">
                    <label for="new-race-name" id="new-race-name-label">Nombre de la carrera:</label>
                    <input type="text" id="new-race-name" class="config-input" placeholder="Ej: Carrera MTB 2025">
                </div>
                <div class="config-line" style="flex-direction: column; align-items: stretch;">
                    <label for="new-race-description" id="new-race-desc-label">Descripción (opcional):</label>
                    <textarea id="new-race-description" class="config-input" rows="3" placeholder="Información adicional sobre la carrera..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" id="create-race-btn">Crear carrera</button>
                <button class="btn" id="cancel-create-race-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Video oculto para mantener pantalla activa -->
    <video id="keep-alive-video" style="display: none;" muted playsinline>
        <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
    </video>

    <!-- Mensajes flotantes -->
    <div id="message" class="message"></div>

    <!-- =========================================== -->
    <!-- SCRIPT JAVASCRIPT CORREGIDO -->
    <!-- =========================================== -->
    <script>
        // ============================================
        // ESTADO DE LA APLICACIÓN
        // ============================================
        const appState = {
            currentLanguage: 'es',
            currentRace: null,
            races: [],
            countdownActive: false,
            countdownValue: 0,
            countdownInterval: null,
            raceStartTime: null,
            departedCount: 0,
            nextCorredorTime: 60,
            intervals: [],
            currentIntervalIndex: 0,
            departureTimes: [],
            audioContext: null,
            isSalidaShowing: false,
            salidaTimeout: null,
            deferredPrompt: null,
            updateAvailable: false,
            countdownPaused: false,
            accumulatedTime: 0,
            configModalOpen: false,
            variableIntervalConfig: {
                intervals: [],
                saved: false
            },
            soundEnabled: true,
            aggressiveMode: false
        };

        // ============================================
        // TRADUCCIONES ACTUALIZADAS
        // ============================================
        const translations = {
            es: {
                appTitle: "Crono Cuenta Atrás",
                languagesLabel: "Idioma / Language",
                cardRaceTitle: "Gestión de Carrera",
                raceManagementTitle: "Selección de carrera",
                raceSelectLabel: "Carrera actual:",
                newRaceText: "Nueva",
                deleteRaceText: "Eliminar",
                cardTimeTitle: "Configuración de Tiempos",
                cadenceTitle: "Cadencia de salida",
                sameIntervalText: "Siempre igual",
                variableIntervalText: "Varios tramos",
                intervalTimeLabel: "Tiempo entre salidas",
                minutesText: "minutos",
                secondsText: "segundos",
                addIntervalLabel: "Añadir nuevo tramo",
                toText: "hasta",
                addIntervalText: "Añadir",
                cardStartTitle: "Punto de Inicio",
                startFromLabel: "Iniciar desde",
                startFromZeroText: "Comenzar desde el corredor 1",
                startFromXText: "O desde la posición:",
                cardDeparturesTitle: "Salidas Registradas",
                departuresLabel: "Historial de salidas",
                clearDeparturesText: "Limpiar lista",
                exportExcelText: "Exportar Excel",
                startCountdownText: "INICIAR CUENTA ATRÁS",
                totalTimeLabel: "Tiempo total",
                nextCorredorLabel: "Próximo sale a",
                departedLabel: "Salidos",
                helpText: "Ayuda",
                suggestionsText: "Sugerencias",
                installText: "Instalar App",
                updateText: "Buscar actualizaciones",
                copyrightText: "2025 © Copyright ",
                helpModalTitle: "Ayuda de Crono Cuenta Atrás",
                helpModalText1: "Crono Cuenta Atrás es una aplicación para controlar las salidas en carreras con cuenta atrás visual y sonora.",
                helpModalSubtitle1: "Cómo usar:",
                helpModalList: [
                    "Selecciona una carrera o crea una nueva",
                    "Configura la cadencia de salida (siempre igual o por tramos)",
                    "Inicia desde el corredor 1 o desde una posición específica",
                    "Pulsa 'INICIAR CUENTA ATRÁS' para comenzar",
                    "La pantalla cambiará mostrando la cuenta atrás grande",
                    "Cuando llegue a cero se mostrará 'SALIDA' y comenzará la cuenta para el siguiente"
                ],
                helpModalSubtitle2: "Indicadores visuales:",
                helpModalSubtitle3: "Sonidos:",
                helpModalText2: "Los 2 segundos de 'SALIDA' se restan automáticamente del tiempo del siguiente cuenta atrás.",
                deleteRaceModalTitle: "Confirmar eliminación",
                deleteRaceModalText: "¿Estás seguro de que quieres eliminar esta carrera? Todos los datos se perderán.",
                clearDeparturesModalTitle: "Confirmar limpieza",
                clearDeparturesModalText: "¿Estás seguro de que quieres limpiar la lista de salidas? Esta acción no se puede deshacer.",
                suggestionsModalTitle: "Enviar sugerencias",
                suggestionEmailLabel: "Email (opcional):",
                suggestionTextLabel: "Sugerencias:",
                newRaceModalTitle: "Nueva carrera",
                newRaceNameLabel: "Nombre de la carrera:",
                newRaceDescLabel: "Descripción (opcional):",
                deleteConfirm: "Eliminar",
                cancel: "Cancelar",
                understood: "Entendido",
                createRace: "Crear carrera",
                sendSuggestion: "Enviar",
                clear: "Limpiar",
                selectRaceFirst: "Por favor, selecciona una carrera primero",
                countdownStarted: "Cuenta atrás iniciada",
                countdownStopped: "Cuenta atrás detenida",
                raceCreated: "Carrera creada correctamente",
                raceDeleted: "Carrera eliminada",
                departuresCleared: "Lista de salidas limpiada",
                intervalAdded: "Tramo añadido",
                excelExported: "Excel exportado correctamente",
                suggestionSent: "Sugerencia enviada",
                updateChecked: "Actualización verificada",
                intervalSaved: "Configuración de tramos guardada",
                intervalLoaded: "Configuración de tramos cargada"
            },
            ca: {
                appTitle: "Crono Compte Enrere",
                languagesLabel: "Idioma / Language",
                cardRaceTitle: "Gestió de Cursa",
                raceManagementTitle: "Selecció de cursa",
                raceSelectLabel: "Cursa actual:",
                newRaceText: "Nova",
                deleteRaceText: "Eliminar",
                cardTimeTitle: "Configuració de Temps",
                cadenceTitle: "Cadència de sortida",
                sameIntervalText: "Sempre igual",
                variableIntervalText: "Diversos trams",
                intervalTimeLabel: "Temps entre sortides",
                minutesText: "minuts",
                secondsText: "segons",
                addIntervalLabel: "Afegir nou tram",
                toText: "fins a",
                addIntervalText: "Afegir",
                cardStartTitle: "Punt d'Inici",
                startFromLabel: "Iniciar des de",
                startFromZeroText: "Començar des del corredor 1",
                startFromXText: "O des de la posició:",
                cardDeparturesTitle: "Sortides Registrades",
                departuresLabel: "Historial de sortides",
                clearDeparturesText: "Netejar llista",
                exportExcelText: "Exportar Excel",
                startCountdownText: "INICIAR COMPTE ENRERE",
                totalTimeLabel: "Temps total",
                nextCorredorLabel: "Pròxim surt a",
                departedLabel: "Sortits",
                helpText: "Ajuda",
                suggestionsText: "Suggeriments",
                installText: "Instal·lar App",
                updateText: "Cercar actualitzacions",
                copyrightText: "2025 © Copyright ",
                helpModalTitle: "Ajuda de Crono Compte Enrere",
                helpModalText1: "Crono Compte Enrere és una aplicació per controlar les sortides en curses amb compte enrere visual i sonor.",
                helpModalSubtitle1: "Com usar:",
                helpModalList: [
                    "Selecciona una cursa o crea'n una de nova",
                    "Configura la cadència de sortida (sempre igual o per trams)",
                    "Inicia des del corredor 1 o des d'una posició específica",
                    "Prem 'INICIAR COMPTE ENRERE' per començar",
                    "La pantalla canviarà mostrant el compte enrere gran",
                    "Quan arribi a zero es mostrarà 'SORTIDA' i començarà el compte per al següent"
                ],
                helpModalSubtitle2: "Indicadors visuals:",
                helpModalSubtitle3: "Sons:",
                helpModalText2: "Els 2 segons de 'SORTIDA' es resten automàticament del temps del compte enrere següent.",
                deleteRaceModalTitle: "Confirmar eliminació",
                deleteRaceModalText: "Estàs segur que vols eliminar aquesta cursa? Totes les dades es perdran.",
                clearDeparturesModalTitle: "Confirmar neteja",
                clearDeparturesModalText: "Estàs segur que vols netejar la llista de sortides? Aquesta acció no es pot desfer.",
                suggestionsModalTitle: "Enviar suggeriments",
                suggestionEmailLabel: "Email (opcional):",
                suggestionTextLabel: "Suggeriments:",
                newRaceModalTitle: "Nova cursa",
                newRaceNameLabel: "Nom de la cursa:",
                newRaceDescLabel: "Descripció (opcional):",
                deleteConfirm: "Eliminar",
                cancel: "Cancel·lar",
                understood: "Entès",
                createRace: "Crear cursa",
                sendSuggestion: "Enviar",
                clear: "Netejar",
                selectRaceFirst: "Si us plau, selecciona una cursa primer",
                countdownStarted: "Compte enrere iniciat",
                countdownStopped: "Compte enrere aturat",
                raceCreated: "Cursa creada correctament",
                raceDeleted: "Cursa eliminada",
                departuresCleared: "Llista de sortides netejada",
                intervalAdded: "Tram afegit",
                excelExported: "Excel exportat correctament",
                suggestionSent: "Suggeriment enviat",
                updateChecked: "Actualització verificada",
                intervalSaved: "Configuració de trams guardada",
                intervalLoaded: "Configuració de trams carregada"
            },
            en: {
                appTitle: "Countdown Timer",
                languagesLabel: "Language / Idioma",
                cardRaceTitle: "Race Management",
                raceManagementTitle: "Race selection",
                raceSelectLabel: "Current race:",
                newRaceText: "New",
                deleteRaceText: "Delete",
                cardTimeTitle: "Time Configuration",
                cadenceTitle: "Start cadence",
                sameIntervalText: "Always the same",
                variableIntervalText: "Multiple intervals",
                intervalTimeLabel: "Time between starts",
                minutesText: "minutes",
                secondsText: "seconds",
                addIntervalLabel: "Add new interval",
                toText: "to",
                addIntervalText: "Add",
                cardStartTitle: "Starting Point",
                startFromLabel: "Start from",
                startFromZeroText: "Start from racer 1",
                startFromXText: "Or from position:",
                cardDeparturesTitle: "Recorded Starts",
                departuresLabel: "Starts history",
                clearDeparturesText: "Clear list",
                exportExcelText: "Export Excel",
                startCountdownText: "START COUNTDOWN",
                totalTimeLabel: "Total time",
                nextCorredorLabel: "Next starts in",
                departedLabel: "Departed",
                helpText: "Help",
                suggestionsText: "Suggestions",
                installText: "Install App",
                updateText: "Check for updates",
                copyrightText: "2025 © Copyright ",
                helpModalTitle: "Countdown Timer Help",
                helpModalText1: "Countdown Timer is an application to control race starts with visual and sound countdown.",
                helpModalSubtitle1: "How to use:",
                helpModalList: [
                    "Select a race or create a new one",
                    "Configure start cadence (same or multiple intervals)",
                    "Start from racer 1 or from specific position",
                    "Press 'START COUNTDOWN' to begin",
                    "Screen will change showing big countdown",
                    "When it reaches zero 'START' will show and countdown for next begins"
                ],
                helpModalSubtitle2: "Visual indicators:",
                helpModalSubtitle3: "Sounds:",
                helpModalText2: "The 2 seconds of 'START' are automatically subtracted from the next countdown time.",
                deleteRaceModalTitle: "Confirm deletion",
                deleteRaceModalText: "Are you sure you want to delete this race? All data will be lost.",
                clearDeparturesModalTitle: "Confirm cleanup",
                clearDeparturesModalText: "Are you sure you want to clear the starts list? This action cannot be undone.",
                suggestionsModalTitle: "Send suggestions",
                suggestionEmailLabel: "Email (optional):",
                suggestionTextLabel: "Suggestions:",
                newRaceModalTitle: "New race",
                newRaceNameLabel: "Race name:",
                newRaceDescLabel: "Description (optional):",
                deleteConfirm: "Delete",
                cancel: "Cancel",
                understood: "Understood",
                createRace: "Create race",
                sendSuggestion: "Send",
                clear: "Clear",
                selectRaceFirst: "Please select a race first",
                countdownStarted: "Countdown started",
                countdownStopped: "Countdown stopped",
                raceCreated: "Race created successfully",
                raceDeleted: "Race deleted",
                departuresCleared: "Starts list cleared",
                intervalAdded: "Interval added",
                excelExported: "Excel exported successfully",
                suggestionSent: "Suggestion sent",
                updateChecked: "Update checked",
                intervalSaved: "Interval configuration saved",
                intervalLoaded: "Interval configuration loaded"
            },
            fr: {
                appTitle: "Compte à Rebours",
                languagesLabel: "Langue / Language",
                cardRaceTitle: "Gestion de Course",
                raceManagementTitle: "Sélection de course",
                raceSelectLabel: "Course actuelle:",
                newRaceText: "Nouvelle",
                deleteRaceText: "Supprimer",
                cardTimeTitle: "Configuration des Temps",
                cadenceTitle: "Cadence de départ",
                sameIntervalText: "Toujours égal",
                variableIntervalText: "Plusieurs intervalles",
                intervalTimeLabel: "Temps entre départs",
                minutesText: "minutes",
                secondsText: "secondes",
                addIntervalLabel: "Ajouter nouvel intervalle",
                toText: "à",
                addIntervalText: "Ajouter",
                cardStartTitle: "Point de Départ",
                startFromLabel: "Démarrer depuis",
                startFromZeroText: "Démarrer depuis le coureur 1",
                startFromXText: "Ou depuis la position:",
                cardDeparturesTitle: "Départs Enregistrés",
                departuresLabel: "Historique des départs",
                clearDeparturesText: "Effacer liste",
                exportExcelText: "Exporter Excel",
                startCountdownText: "DÉMARRER COMPTE À REBOURS",
                totalTimeLabel: "Temps total",
                nextCorredorLabel: "Prochain départ dans",
                departedLabel: "Partis",
                helpText: "Aide",
                suggestionsText: "Suggestions",
                installText: "Installer App",
                updateText: "Vérifier mises à jour",
                copyrightText: "2025 © Copyright ",
                helpModalTitle: "Aide Compte à Rebours",
                helpModalText1: "Compte à Rebours est une application pour contrôler les départs de course avec compte à rebours visuel et sonore.",
                helpModalSubtitle1: "Comment utiliser:",
                helpModalList: [
                    "Sélectionnez une course ou créez-en une nouvelle",
                    "Configurez la cadence de départ (toujours égal ou plusieurs intervalles)",
                    "Démarrez depuis le coureur 1 ou depuis une position spécifique",
                    "Appuyez sur 'DÉMARRER COMPTE À REBOURS' pour commencer",
                    "L'écran changera montrant le compte à rebours grand",
                    "Quand il atteint zéro 'DÉPART' s'affichera et le compte pour le suivant commencera"
                ],
                helpModalSubtitle2: "Indicateurs visuels:",
                helpModalSubtitle3: "Sons:",
                helpModalText2: "Les 2 secondes de 'DÉPART' sont automatiquement soustraites du temps du compte à rebours suivant.",
                deleteRaceModalTitle: "Confirmer suppression",
                deleteRaceModalText: "Êtes-vous sûr de vouloir supprimer cette course? Toutes les données seront perdues.",
                clearDeparturesModalTitle: "Confirmer nettoyage",
                clearDeparturesModalText: "Êtes-vous sûr de vouloir nettoyer la liste des départs? Cette action ne peut pas être annulée.",
                suggestionsModalTitle: "Envoyer suggestions",
                suggestionEmailLabel: "Email (optionnel):",
                suggestionTextLabel: "Suggestions:",
                newRaceModalTitle: "Nouvelle course",
                newRaceNameLabel: "Nom de la course:",
                newRaceDescLabel: "Description (optionnel):",
                deleteConfirm: "Supprimer",
                cancel: "Annuler",
                understood: "Compris",
                createRace: "Créer course",
                sendSuggestion: "Envoyer",
                clear: "Nettoyer",
                selectRaceFirst: "Veuillez sélectionner une course d'abord",
                countdownStarted: "Compte à rebours démarré",
                countdownStopped: "Compte à rebours arrêté",
                raceCreated: "Course créée avec succès",
                raceDeleted: "Course supprimée",
                departuresCleared: "Liste des départs nettoyée",
                intervalAdded: "Intervalle ajouté",
                excelExported: "Excel exporté avec succès",
                suggestionSent: "Suggestion envoyée",
                updateChecked: "Mise à jour vérifiée",
                intervalSaved: "Configuration des intervalles sauvegardée",
                intervalLoaded: "Configuration des intervalles chargée"
            }
        };

        // ============================================
        // FUNCIONES DE SONIDO
        // ============================================

        function generateBeep(frequency, duration, type = 'sine') {
            try {
                if (!appState.audioContext) {
                    appState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                if (appState.audioContext.state === 'suspended') {
                    appState.audioContext.resume();
                }
                
                const oscillator = appState.audioContext.createOscillator();
                const gainNode = appState.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(appState.audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, appState.audioContext.currentTime);
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.3, appState.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, appState.audioContext.currentTime + duration);
                
                oscillator.start(appState.audioContext.currentTime);
                oscillator.stop(appState.audioContext.currentTime + duration);
                
            } catch (error) {
                console.log("Error generando beep:", error);
            }
        }

        function playSound(type) {
            if (!appState.soundEnabled) return;
            
            try {
                switch(type) {
                    case 'warning':
                        generateBeep(300, 1.5, 'square');
                        break;
                    case 'critical':
                        generateBeep(500, 0.3, 'sine');
                        break;
                    case 'salida':
                        generateBeep(800, 1.5, 'sine');
                        break;
                    case 'beep':
                        generateBeep(500, 0.3, 'sine');
                        break;
                }
            } catch (error) {
                console.log("Error reproduciendo sonido:", error);
            }
        }

        function initAudioOnInteraction() {
            if (!appState.audioContext) {
                appState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            if (appState.audioContext.state === 'suspended') {
                appState.audioContext.resume().then(() => {
                    generateBeep(440, 0.1);
                });
            }
            
            document.removeEventListener('click', initAudioOnInteraction);
            document.removeEventListener('keydown', initAudioOnInteraction);
        }

        // ============================================
        // FUNCIONES PRINCIPALES
        // ============================================

        function initApp() {
            console.log("Inicializando aplicación...");
            
            loadLanguagePreference();
            loadRacesFromStorage();
            loadAppState();
            loadVariableIntervalConfig();
            updateLanguageUI();
            setupEventListeners();
            renderRacesSelect();
            renderDeparturesList();
            setupServiceWorker();
            
            setInterval(updateTotalTime, 1000);
            
            setupPWA();
            
            // NUEVO: Inicializar ajuste de tamaño
            setupCountdownResize();
            adjustCountdownSize(); // Ajustar tamaño inicial

            document.addEventListener('click', initAudioOnInteraction);
            document.addEventListener('keydown', initAudioOnInteraction);
            
            console.log("Aplicación inicializada correctamente");
        }

        function loadLanguagePreference() {
            const savedLang = localStorage.getItem('countdown-language');
            if (savedLang && translations[savedLang]) {
                appState.currentLanguage = savedLang;
            }
        }

        function loadRacesFromStorage() {
            const savedRaces = localStorage.getItem('countdown-races');
            if (savedRaces) {
                appState.races = JSON.parse(savedRaces);
            }
            
            const savedCurrentRace = localStorage.getItem('countdown-current-race');
            if (savedCurrentRace) {
                appState.currentRace = JSON.parse(savedCurrentRace);
            }
        }

        function loadVariableIntervalConfig() {
            const savedConfig = localStorage.getItem('countdown-variable-intervals');
            if (savedConfig) {
                appState.variableIntervalConfig = JSON.parse(savedConfig);
                if (appState.variableIntervalConfig.intervals && appState.variableIntervalConfig.intervals.length > 0) {
                    appState.intervals = [...appState.variableIntervalConfig.intervals];
                    renderIntervalsList();
                }
            }
        }

        function loadAppState() {
            const savedState = localStorage.getItem('countdown-app-state');
            if (savedState) {
                const state = JSON.parse(savedState);
                
                appState.departedCount = state.departedCount || 0;
                appState.nextCorredorTime = state.nextCorredorTime || 60;
                appState.intervals = state.intervals || [];
                appState.currentIntervalIndex = state.currentIntervalIndex || 0;
                appState.departureTimes = state.departureTimes || [];
                appState.accumulatedTime = state.accumulatedTime || 0;
                
                appState.countdownActive = false;
                appState.countdownValue = 0;
                appState.raceStartTime = null;
                appState.countdownPaused = false;
                
                console.log("Estado cargado, cuenta atrás NO activada automáticamente");
            }
        }

        function saveAppState() {
            if (appState.countdownActive) {
                localStorage.setItem('countdown-app-state', JSON.stringify({
                    countdownActive: appState.countdownActive,
                    countdownValue: appState.countdownValue,
                    departedCount: appState.departedCount,
                    nextCorredorTime: appState.nextCorredorTime,
                    intervals: appState.intervals,
                    currentIntervalIndex: appState.currentIntervalIndex,
                    departureTimes: appState.departureTimes,
                    raceStartTime: appState.raceStartTime,
                    accumulatedTime: appState.accumulatedTime,
                    countdownPaused: appState.countdownPaused
                }));
            } else {
                localStorage.removeItem('countdown-app-state');
            }
        }

        function saveRacesToStorage() {
            localStorage.setItem('countdown-races', JSON.stringify(appState.races));
            if (appState.currentRace) {
                localStorage.setItem('countdown-current-race', JSON.stringify(appState.currentRace));
            }
        }

        function updateLanguageUI() {
            const lang = appState.currentLanguage;
            const t = translations[lang];
            
            document.getElementById('app-title-text').textContent = t.appTitle;
            document.getElementById('languages-label').textContent = t.languagesLabel;
            document.getElementById('card-race-title').textContent = t.cardRaceTitle;
            document.getElementById('race-management-title').textContent = t.raceManagementTitle;
            document.getElementById('race-select-label').textContent = t.raceSelectLabel;
            document.getElementById('new-race-text').textContent = t.newRaceText;
            document.getElementById('delete-race-text').textContent = t.deleteRaceText;
            document.getElementById('card-time-title').textContent = t.cardTimeTitle;
            document.getElementById('cadence-title').textContent = t.cadenceTitle;
            document.getElementById('same-interval-text').textContent = t.sameIntervalText;
            document.getElementById('variable-interval-text').textContent = t.variableIntervalText;
            document.getElementById('interval-time-label').textContent = t.intervalTimeLabel;
            document.getElementById('minutes-text').textContent = t.minutesText;
            document.getElementById('seconds-text').textContent = t.secondsText;
            document.getElementById('add-interval-label').textContent = t.addIntervalLabel;
            document.getElementById('to-text').textContent = t.toText;
            document.getElementById('add-interval-text').textContent = t.addIntervalText;
            document.getElementById('card-start-title').textContent = t.cardStartTitle;
            document.getElementById('start-from-label').textContent = t.startFromLabel;
            document.getElementById('start-from-zero-text').textContent = t.startFromZeroText;
            document.getElementById('start-from-x-text').textContent = t.startFromXText;
            document.getElementById('card-departures-title').textContent = t.cardDeparturesTitle;
            document.getElementById('departures-label').textContent = t.departuresLabel;
            document.getElementById('clear-departures-text').textContent = t.clearDeparturesText;
            document.getElementById('export-excel-text').textContent = t.exportExcelText;
            document.getElementById('start-countdown-text').textContent = t.startCountdownText;
            document.getElementById('total-time-label').textContent = t.totalTimeLabel;
            document.getElementById('next-corredor-label').textContent = t.nextCorredorLabel;
            document.getElementById('departed-label').textContent = t.departedLabel;
            document.getElementById('help-text').textContent = t.helpText;
            document.getElementById('suggestions-text').textContent = t.suggestionsText;
            document.getElementById('install-text').textContent = t.installText;
            document.getElementById('update-text').textContent = t.updateText;
            document.getElementById('copyright-text').innerHTML = `2025 © Copyright <a href="https://rbenet71.github.io/Web/" target="_blank" id="copyright-link">Roberto Benet - rbenet71@gmail.com - Va_12_12_2025</a>`;
            
            document.querySelectorAll('.flag').forEach(flag => {
                flag.classList.remove('active');
            });
            document.getElementById('flag-' + lang).classList.add('active');
            
            updateModalTexts();
        }

        function updateModalTexts() {
            const t = translations[appState.currentLanguage];
            
            document.getElementById('help-modal-title').textContent = t.helpModalTitle;
            document.getElementById('help-modal-text1').textContent = t.helpModalText1;
            document.getElementById('help-modal-subtitle1').textContent = t.helpModalSubtitle1;
            document.getElementById('help-modal-subtitle2').textContent = t.helpModalSubtitle2;
            document.getElementById('help-modal-subtitle3').textContent = t.helpModalSubtitle3;
            document.getElementById('help-modal-text2').textContent = t.helpModalText2;
            document.getElementById('help-modal-ok').textContent = t.understood;
            
            document.getElementById('delete-race-modal-title').textContent = t.deleteRaceModalTitle;
            document.getElementById('delete-race-modal-text').textContent = t.deleteRaceModalText;
            document.getElementById('delete-race-confirm-btn').textContent = t.deleteConfirm;
            document.getElementById('delete-race-cancel-btn').textContent = t.cancel;
            
            document.getElementById('clear-departures-modal-title').textContent = t.clearDeparturesModalTitle;
            document.getElementById('clear-departures-modal-text').textContent = t.clearDeparturesModalText;
            document.getElementById('clear-departures-confirm-btn').textContent = t.clear;
            document.getElementById('clear-departures-cancel-btn').textContent = t.cancel;
            
            document.getElementById('suggestions-modal-title').textContent = t.suggestionsModalTitle;
            document.getElementById('suggestion-email-label').textContent = t.suggestionEmailLabel;
            document.getElementById('suggestion-text-label').textContent = t.suggestionTextLabel;
            document.getElementById('send-suggestion-btn').textContent = t.sendSuggestion;
            document.getElementById('cancel-suggestion-btn').textContent = t.cancel;
            
            document.getElementById('new-race-modal-title').textContent = t.newRaceModalTitle;
            document.getElementById('new-race-name-label').textContent = t.newRaceNameLabel;
            document.getElementById('new-race-desc-label').textContent = t.newRaceDescLabel;
            document.getElementById('create-race-btn').textContent = t.createRace;
            document.getElementById('cancel-create-race-btn').textContent = t.cancel;
            
            const helpList = document.getElementById('help-modal-list');
            if (helpList) {
                helpList.innerHTML = '';
                t.helpModalList.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    li.style.marginBottom = '8px';
                    helpList.appendChild(li);
                });
            }
        }

        function renderRacesSelect() {
            const select = document.getElementById('race-select');
            select.innerHTML = '<option value="">-- ' + translations[appState.currentLanguage].raceSelectLabel + ' --</option>';
            
            appState.races.forEach((race, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = race.name;
                if (appState.currentRace && race.id === appState.currentRace.id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        function renderDeparturesList() {
            const container = document.getElementById('departures-list');
            
            if (appState.departureTimes.length === 0) {
                container.innerHTML = '<div class="empty-state">' +
                    '<i class="fas fa-clock"></i>' +
                    '<p>No hay salidas registradas</p>' +
                    '</div>';
                return;
            }
            
            container.innerHTML = '';
            const reversedTimes = [...appState.departureTimes].reverse();
            
            reversedTimes.forEach(departure => {
                const item = document.createElement('div');
                item.className = 'departure-item';
                
                const time = new Date(departure.timestamp);
                const timeStr = time.toLocaleTimeString();
                const dateStr = time.toLocaleDateString();
                
                item.innerHTML = `
                    <div class="departure-number">Corredor ${departure.corredor}</div>
                    <div class="departure-time">${dateStr} ${timeStr}</div>
                `;
                
                container.appendChild(item);
            });
            
            document.getElementById('departed-count').textContent = appState.departedCount;
        }

        function setupServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/Web/countdown-sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registrado:', registration.scope);
                        
                        setInterval(() => {
                            registration.update();
                        }, 60 * 60 * 1000);
                    })
                    .catch(error => {
                        console.log('Error registrando ServiceWorker:', error);
                    });
            }
        }

        function setupPWA() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                appState.deferredPrompt = e;
                
                const installBtn = document.getElementById('install-btn');
                installBtn.style.display = 'flex';
            });
        }

        function installPWA() {
            if (appState.deferredPrompt) {
                appState.deferredPrompt.prompt();
                appState.deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showMessage('Aplicación instalada', 'success');
                    }
                    appState.deferredPrompt = null;
                });
            }
        }

        function keepScreenAwakeAlternative() {
            if (!appState.countdownActive) return;
            
            if ('wakeLock' in navigator) {
                navigator.wakeLock.request('screen')
                    .then(wakeLock => {
                        console.log('Wake Lock activado');
                    })
                    .catch(err => {
                        console.log('Wake Lock no disponible:', err);
                    });
            }
            
            const video = document.getElementById('keep-alive-video');
            if (video) {
                video.loop = true;
                video.play().catch(e => console.log('Video keep-alive falló:', e));
            }
            
            if (navigator.vibrate) {
                navigator.vibrate(0);
            }
        }

        // ============================================
        // FUNCIONES DE CUENTA ATRÁS - CORREGIDAS
        // ============================================

        function startCountdown() {
            console.log("Iniciando cuenta atrás...");
            
            if (!appState.currentRace) {
                showMessage(translations[appState.currentLanguage].selectRaceFirst, 'error');
                return;
            }
            
            document.querySelectorAll('.hide-on-countdown').forEach(el => {
                el.style.display = 'none';
            });
            
            const countdownScreen = document.getElementById('countdown-screen');
            countdownScreen.classList.add('active');
            countdownScreen.classList.remove('aggressive-numbers');
            
            appState.raceStartTime = Date.now();
            appState.accumulatedTime = 0;
            
            updateCadenceTime();
            
            updateCurrentInterval();
            
            appState.countdownActive = true;
            appState.countdownPaused = false;
            appState.countdownValue = appState.nextCorredorTime;
            appState.aggressiveMode = false;
            
            document.body.classList.remove('countdown-warning', 'countdown-critical', 'countdown-salida');
            document.body.classList.add('countdown-normal');
            
            countdownScreen.classList.remove('countdown-salida-active');
            
            document.getElementById('countdown-label').style.opacity = '1';
            document.getElementById('countdown-label').style.visibility = 'visible';
            
            updateCountdownDisplay();
            
            if (appState.countdownInterval) {
                clearInterval(appState.countdownInterval);
            }
            
            appState.countdownInterval = setInterval(updateCountdown, 1000);
            
            keepScreenAwakeAlternative();
            
            saveAppState();
            
            showMessage(translations[appState.currentLanguage].countdownStarted, 'success');
            console.log("Cuenta atrás iniciada correctamente");
        }

        function updateCadenceTime() {
            const isVariableMode = document.getElementById('variable-interval-config').style.display !== 'none';
            
            if (!isVariableMode) {
                const minutes = parseInt(document.getElementById('interval-minutes').value) || 0;
                const seconds = parseInt(document.getElementById('interval-seconds').value) || 0;
                const totalSeconds = minutes * 60 + seconds;
                
                appState.nextCorredorTime = totalSeconds;
                
                if (appState.intervals.length === 0) {
                    appState.intervals = [{
                        from: 1,
                        to: 9999,
                        minutes: minutes,
                        seconds: seconds,
                        totalSeconds: totalSeconds
                    }];
                } else {
                    appState.intervals[0] = {
                        from: 1,
                        to: 9999,
                        minutes: minutes,
                        seconds: seconds,
                        totalSeconds: totalSeconds
                    };
                }
            }
            
            updateNextCorredorDisplay();
        }

        function updateCountdown() {
            if (!appState.countdownActive || appState.countdownPaused) return;
            
            const currentTime = Date.now();
            const elapsedFromRaceStart = Math.floor((currentTime - appState.raceStartTime) / 1000);
            
            const expectedElapsedTime = appState.accumulatedTime + 
                (appState.nextCorredorTime - appState.countdownValue);
            
            if (Math.abs(elapsedFromRaceStart - expectedElapsedTime) > 1) {
                appState.countdownValue = Math.max(0, appState.nextCorredorTime - 
                    (elapsedFromRaceStart - appState.accumulatedTime));
            } else {
                appState.countdownValue--;
            }
            
            if (appState.countdownValue <= 0) {
                handleCountdownZero();
                return;
            }
            
            updateCountdownDisplay();
            
            if (appState.countdownValue === 10) {
                document.body.classList.remove('countdown-normal');
                document.body.classList.add('countdown-warning');
                playSound('warning');
                
                const countdownScreen = document.getElementById('countdown-screen');
                countdownScreen.classList.remove('aggressive-numbers');
                appState.aggressiveMode = false;
            } else if (appState.countdownValue === 5) {
                document.body.classList.remove('countdown-warning');
                document.body.classList.add('countdown-critical');
                playSound('critical');
                
                const countdownScreen = document.getElementById('countdown-screen');
                countdownScreen.classList.add('aggressive-numbers');
                appState.aggressiveMode = true;
            } else if (appState.countdownValue < 5 && appState.countdownValue > 0) {
                playSound('beep');
                
                if (!appState.aggressiveMode) {
                    const countdownScreen = document.getElementById('countdown-screen');
                    countdownScreen.classList.add('aggressive-numbers');
                    appState.aggressiveMode = true;
                }
            } else if (appState.countdownValue > 5 && appState.aggressiveMode) {
                const countdownScreen = document.getElementById('countdown-screen');
                countdownScreen.classList.remove('aggressive-numbers');
                appState.aggressiveMode = false;
            }
            
            if (appState.countdownValue % 10 === 0) {
                saveAppState();
            }
        }

        function updateCountdownDisplay() {
            const display = document.getElementById('countdown-display');
            
            if (appState.countdownValue >= 60) {
                const minutes = Math.floor(appState.countdownValue / 60);
                const seconds = appState.countdownValue % 60;
                display.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            } else {
                display.textContent = appState.countdownValue.toString();
            }
            
            updateNextCorredorDisplay();
            adjustCountdownSize();
        }

        function handleCountdownZero() {
            clearInterval(appState.countdownInterval);
            
            const countdownScreen = document.getElementById('countdown-screen');
            countdownScreen.classList.add('countdown-salida-active');
            
            countdownScreen.classList.remove('aggressive-numbers');
            appState.aggressiveMode = false;
            
            document.body.classList.remove('countdown-critical', 'countdown-warning', 'countdown-normal');
            document.body.classList.add('countdown-salida');
            
            const salidaDisplay = document.getElementById('salida-display');
            salidaDisplay.classList.add('show');
            
            playSound('salida');
            
            registerDeparture();
            
            appState.accumulatedTime += appState.nextCorredorTime;
            
            appState.salidaTimeout = setTimeout(() => {
                salidaDisplay.classList.remove('show');
                countdownScreen.classList.remove('countdown-salida-active');
                prepareNextCountdown();
            }, 2000);
        }

        function registerDeparture() {
            appState.departedCount++;
            
            const departure = {
                corredor: appState.departedCount,
                timestamp: Date.now()
            };
            
            appState.departureTimes.push(departure);
            
            document.getElementById('departed-count').textContent = appState.departedCount;
            
            renderDeparturesList();
            
            saveAppState();
            localStorage.setItem('countdown-departures', JSON.stringify(appState.departureTimes));
        }

        function prepareNextCountdown() {
            updateCurrentInterval();
            
            appState.countdownValue = Math.max(0, appState.nextCorredorTime - 2);
            
            document.body.classList.remove('countdown-salida');
            document.body.classList.add('countdown-normal');
            
            document.getElementById('countdown-label').style.opacity = '1';
            document.getElementById('countdown-label').style.visibility = 'visible';
            
            updateCountdownDisplay();
            
            appState.countdownInterval = setInterval(updateCountdown, 1000);
            
            saveAppState();
        }

        function updateCurrentInterval() {
            const currentCorredor = appState.departedCount + 1;
            
            for (let i = 0; i < appState.intervals.length; i++) {
                const interval = appState.intervals[i];
                if (currentCorredor >= interval.from && currentCorredor <= interval.to) {
                    appState.currentIntervalIndex = i;
                    appState.nextCorredorTime = interval.totalSeconds;
                    break;
                }
            }
        }

        function updateNextCorredorDisplay() {
            const display = document.getElementById('next-corredor-time');
            const totalSeconds = appState.nextCorredorTime;
            
            if (totalSeconds >= 60) {
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                display.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            } else {
                display.textContent = totalSeconds + "s";
            }
        }

        function updateTotalTime() {
            if (!appState.raceStartTime) return;
            
            const elapsed = Math.floor((Date.now() - appState.raceStartTime) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;
            
            const display = document.getElementById('total-time-value');
            display.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function stopCountdown() {
            console.log("Deteniendo cuenta atrás...");
            
            if (appState.countdownInterval) {
                clearInterval(appState.countdownInterval);
                appState.countdownInterval = null;
            }
            
            if (appState.salidaTimeout) {
                clearTimeout(appState.salidaTimeout);
                appState.salidaTimeout = null;
            }
            
            appState.countdownActive = false;
            appState.countdownPaused = false;
            appState.raceStartTime = null;
            appState.accumulatedTime = 0;
            appState.aggressiveMode = false;
            
            document.getElementById('countdown-screen').classList.remove('aggressive-numbers');
            
            document.getElementById('total-time-value').textContent = '00:00:00';
            
            localStorage.removeItem('countdown-app-state');
            
            console.log("Cuenta atrás detenida");
        }

        function pauseCountdownVisual() {
            appState.countdownPaused = true;
            appState.configModalOpen = true;
        }

        function resumeCountdownVisual() {
            appState.countdownPaused = false;
            appState.configModalOpen = false;
        }

        // ============================================
        // FUNCIONES DE CONFIGURACIÓN
        // ============================================

        function createNewRace() {
            const name = document.getElementById('new-race-name').value.trim();
            if (!name) {
                showMessage('Ingresa un nombre para la carrera', 'error');
                return;
            }
            
            const description = document.getElementById('new-race-description').value.trim();
            
            const newRace = {
                id: Date.now(),
                name: name,
                description: description,
                createdAt: new Date().toISOString(),
                intervals: [],
                departures: []
            };
            
            appState.races.push(newRace);
            appState.currentRace = newRace;
            
            saveRacesToStorage();
            renderRacesSelect();
            
            document.getElementById('new-race-modal').classList.remove('active');
            document.getElementById('new-race-name').value = '';
            document.getElementById('new-race-description').value = '';
            
            showMessage(translations[appState.currentLanguage].raceCreated, 'success');
        }

        function deleteCurrentRace() {
            if (!appState.currentRace) return;
            
            const raceIndex = appState.races.findIndex(r => r.id === appState.currentRace.id);
            if (raceIndex !== -1) {
                appState.races.splice(raceIndex, 1);
                appState.currentRace = null;
                
                if (appState.countdownActive) {
                    stopCountdown();
                    document.getElementById('countdown-screen').classList.remove('active');
                    document.querySelectorAll('.hide-on-countdown').forEach(el => {
                        el.style.display = '';
                    });
                }
                
                saveRacesToStorage();
                renderRacesSelect();
                showMessage(translations[appState.currentLanguage].raceDeleted, 'success');
            }
        }

        function addVariableInterval() {
            const from = parseInt(document.getElementById('from-corredor').value) || 1;
            const to = parseInt(document.getElementById('to-corredor').value) || 10;
            const minutes = parseInt(document.getElementById('var-minutes').value) || 0;
            const seconds = parseInt(document.getElementById('var-seconds').value) || 0;
            
            if (from > to) {
                showMessage('El corredor "desde" debe ser menor o igual que "hasta"', 'error');
                return;
            }
            
            if (minutes === 0 && seconds === 0) {
                showMessage('Ingresa un tiempo válido', 'error');
                return;
            }
            
            const totalSeconds = minutes * 60 + seconds;
            
            const newInterval = {
                from: from,
                to: to,
                minutes: minutes,
                seconds: seconds,
                totalSeconds: totalSeconds
            };
            
            appState.intervals.push(newInterval);
            renderIntervalsList();
            
            saveVariableIntervalConfig();
            
            document.getElementById('from-corredor').value = to + 1;
            document.getElementById('to-corredor').value = to + 10;
            document.getElementById('var-minutes').value = 1;
            document.getElementById('var-seconds').value = 0;
            
            showMessage(translations[appState.currentLanguage].intervalAdded, 'success');
        }

        function renderIntervalsList() {
            const container = document.getElementById('intervals-list');
            container.innerHTML = '';
            
            appState.intervals.forEach((interval, index) => {
                const row = document.createElement('div');
                row.className = 'interval-row';
                row.innerHTML = `
                    <div class="interval-info">
                        <div class="interval-range">Corredores ${interval.from} - ${interval.to}</div>
                        <div class="interval-time">Cada: ${interval.minutes}min ${interval.seconds}s</div>
                    </div>
                    <button class="btn btn-danger btn-sm remove-interval-btn" data-index="${index}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(row);
            });
            
            document.querySelectorAll('.remove-interval-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    appState.intervals.splice(index, 1);
                    renderIntervalsList();
                    saveVariableIntervalConfig();
                });
            });
        }

        function clearDeparturesList() {
            appState.departureTimes = [];
            appState.departedCount = 0;
            renderDeparturesList();
            saveAppState();
            localStorage.removeItem('countdown-departures');
            showMessage(translations[appState.currentLanguage].departuresCleared, 'success');
        }

        function exportToExcel() {
            if (appState.departureTimes.length === 0) {
                showMessage('No hay datos para exportar', 'warning');
                return;
            }
            
            const data = [
                ['Corredor', 'Fecha', 'Hora', 'Timestamp']
            ];
            
            appState.departureTimes.forEach(departure => {
                const date = new Date(departure.timestamp);
                data.push([
                    departure.corredor,
                    date.toLocaleDateString(),
                    date.toLocaleTimeString(),
                    departure.timestamp
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Salidas");
            
            const raceName = appState.currentRace ? 
                appState.currentRace.name.replace(/[^a-z0-9]/gi, '_') : 'carrera';
            const date = new Date().toISOString().split('T')[0];
            const filename = `salidas_${raceName}_${date}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            showMessage(translations[appState.currentLanguage].excelExported, 'success');
        }

        function sendSuggestion() {
            const email = document.getElementById('suggestion-email').value.trim();
            const text = document.getElementById('suggestion-text').value.trim();
            
            if (!text) {
                showMessage('Ingresa tu sugerencia', 'error');
                return;
            }
            
            console.log('Sugerencia enviada:', { email, text });
            
            document.getElementById('suggestions-modal').classList.remove('active');
            document.getElementById('suggestion-email').value = '';
            document.getElementById('suggestion-text').value = '';
            
            showMessage(translations[appState.currentLanguage].suggestionSent, 'success');
        }

        // ============================================
        // UTILIDADES
        // ============================================

        function showMessage(text, type = 'info') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        function saveLastUpdate() {
            localStorage.setItem('countdown-last-update', Date.now().toString());
        }

        function saveVariableIntervalConfig() {
            appState.variableIntervalConfig = {
                intervals: [...appState.intervals],
                saved: true
            };
            localStorage.setItem('countdown-variable-intervals', JSON.stringify(appState.variableIntervalConfig));
            showMessage(translations[appState.currentLanguage].intervalSaved, 'success');
        }

        // ============================================
        // EVENT LISTENERS CORREGIDOS
        // ============================================

        function setupEventListeners() {
            console.log("Configurando event listeners...");
            
            // Selector de idioma
            document.querySelectorAll('.flag').forEach(flag => {
                flag.addEventListener('click', function() {
                    const lang = this.getAttribute('data-lang');
                    appState.currentLanguage = lang;
                    localStorage.setItem('countdown-language', lang);
                    updateLanguageUI();
                });
            });
            
            // Botón de ayuda
            document.getElementById('help-icon-header').addEventListener('click', () => {
                document.getElementById('help-modal').classList.add('active');
            });
            
            document.getElementById('footer-help-btn').addEventListener('click', () => {
                document.getElementById('help-modal').classList.add('active');
            });
            
            // Cerrar modales
            document.getElementById('help-modal-close').addEventListener('click', () => {
                document.getElementById('help-modal').classList.remove('active');
            });
            
            document.getElementById('help-modal-ok').addEventListener('click', () => {
                document.getElementById('help-modal').classList.remove('active');
            });
            
            document.getElementById('delete-race-modal-close').addEventListener('click', () => {
                document.getElementById('delete-race-modal').classList.remove('active');
            });
            
            document.getElementById('delete-race-cancel-btn').addEventListener('click', () => {
                document.getElementById('delete-race-modal').classList.remove('active');
            });
            
            document.getElementById('clear-departures-modal-close').addEventListener('click', () => {
                document.getElementById('clear-departures-modal').classList.remove('active');
            });
            
            document.getElementById('clear-departures-cancel-btn').addEventListener('click', () => {
                document.getElementById('clear-departures-modal').classList.remove('active');
            });
            
            document.getElementById('suggestions-modal-close').addEventListener('click', () => {
                document.getElementById('suggestions-modal').classList.remove('active');
            });
            
            document.getElementById('cancel-suggestion-btn').addEventListener('click', () => {
                document.getElementById('suggestions-modal').classList.remove('active');
            });
            
            document.getElementById('new-race-modal-close').addEventListener('click', () => {
                document.getElementById('new-race-modal').classList.remove('active');
            });
            
            document.getElementById('cancel-create-race-btn').addEventListener('click', () => {
                document.getElementById('new-race-modal').classList.remove('active');
            });
            
            // Modal de configuración durante cuenta atrás
            document.getElementById('config-during-countdown-close').addEventListener('click', () => {
                document.getElementById('config-during-countdown-modal').classList.remove('active');
                resumeCountdownVisual();
            });
            
            document.getElementById('resume-countdown-btn').addEventListener('click', () => {
                document.getElementById('config-during-countdown-modal').classList.remove('active');
                resumeCountdownVisual();
            });
            
            document.getElementById('stop-countdown-btn').addEventListener('click', () => {
                stopCountdown();
                document.getElementById('countdown-screen').classList.remove('active');
                document.querySelectorAll('.hide-on-countdown').forEach(el => {
                    el.style.display = '';
                });
                document.getElementById('config-during-countdown-modal').classList.remove('active');
                showMessage(translations[appState.currentLanguage].countdownStopped, 'info');
            });
            
            document.getElementById('adjust-times-btn').addEventListener('click', () => {
                document.getElementById('config-during-countdown-modal').classList.remove('active');
                document.getElementById('adjust-times-modal').classList.add('active');
                
                document.getElementById('adjust-next-time').value = appState.nextCorredorTime;
                document.getElementById('adjust-departed').value = appState.departedCount;
                document.getElementById('adjust-current-time').value = appState.countdownValue;
            });
            
            document.getElementById('exit-countdown-btn').addEventListener('click', () => {
                stopCountdown();
                document.getElementById('countdown-screen').classList.remove('active');
                document.querySelectorAll('.hide-on-countdown').forEach(el => {
                    el.style.display = '';
                });
                document.getElementById('config-during-countdown-modal').classList.remove('active');
                showMessage('Sesión finalizada', 'info');
            });
            
            // Modal de ajuste de tiempos
            document.getElementById('adjust-times-close').addEventListener('click', () => {
                document.getElementById('adjust-times-modal').classList.remove('active');
                resumeCountdownVisual();
            });
            
            document.getElementById('cancel-adjustments-btn').addEventListener('click', () => {
                document.getElementById('adjust-times-modal').classList.remove('active');
                resumeCountdownVisual();
            });
            
            document.getElementById('save-adjustments-btn').addEventListener('click', () => {
                const newNextTime = parseInt(document.getElementById('adjust-next-time').value) || 60;
                const newDeparted = parseInt(document.getElementById('adjust-departed').value) || 0;
                const newCurrentTime = parseInt(document.getElementById('adjust-current-time').value) || 60;
                
                if (newNextTime <= 0 || newCurrentTime < 0 || newDeparted < 0) {
                    showMessage('Valores no válidos', 'error');
                    return;
                }
                
                appState.nextCorredorTime = newNextTime;
                appState.departedCount = newDeparted;
                appState.countdownValue = Math.min(newCurrentTime, newNextTime);
                
                updateNextCorredorDisplay();
                document.getElementById('departed-count').textContent = newDeparted;
                updateCountdownDisplay();
                
                document.getElementById('adjust-times-modal').classList.remove('active');
                resumeCountdownVisual();
                saveAppState();
                showMessage('Tiempos ajustados correctamente', 'success');
            });
            
            // Cerrar modal al hacer clic fuera
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                        if (modal.id === 'config-during-countdown-modal' || 
                            modal.id === 'adjust-times-modal') {
                            resumeCountdownVisual();
                        }
                    }
                });
            });
            
            // Gestión de carreras
            document.getElementById('race-select').addEventListener('change', function() {
                const index = parseInt(this.value);
                if (index >= 0 && index < appState.races.length) {
                    appState.currentRace = appState.races[index];
                    saveRacesToStorage();
                }
            });
            
            document.getElementById('new-race-btn').addEventListener('click', () => {
                document.getElementById('new-race-modal').classList.add('active');
                document.getElementById('new-race-name').focus();
            });
            
            document.getElementById('create-race-btn').addEventListener('click', createNewRace);
            
            document.getElementById('delete-race-btn').addEventListener('click', () => {
                if (!appState.currentRace) {
                    showMessage(translations[appState.currentLanguage].selectRaceFirst, 'error');
                    return;
                }
                document.getElementById('delete-race-modal').classList.add('active');
            });
            
            document.getElementById('delete-race-confirm-btn').addEventListener('click', deleteCurrentRace);
            
            // Configuración de intervalos - CORREGIDO
            document.getElementById('same-interval-btn').addEventListener('click', () => {
                console.log("Botón 'Siempre igual' clickeado");
                document.getElementById('single-interval-config').style.display = 'block';
                document.getElementById('variable-interval-config').style.display = 'none';
                appState.intervals = [];
                renderIntervalsList();
                saveVariableIntervalConfig();
            });
            
            document.getElementById('variable-interval-btn').addEventListener('click', () => {
                console.log("Botón 'Varios tramos' clickeado");
                document.getElementById('single-interval-config').style.display = 'none';
                document.getElementById('variable-interval-config').style.display = 'block';
                
                if (appState.variableIntervalConfig.saved && appState.variableIntervalConfig.intervals.length > 0) {
                    appState.intervals = [...appState.variableIntervalConfig.intervals];
                    renderIntervalsList();
                    showMessage(translations[appState.currentLanguage].intervalLoaded, 'info');
                }
            });
            
            document.getElementById('add-interval-btn').addEventListener('click', addVariableInterval);
            
            // Iniciar desde posición
            document.getElementById('start-from-zero-btn').addEventListener('click', () => {
                appState.departedCount = 0;
                document.getElementById('departed-count').textContent = '0';
            });
            
            document.getElementById('start-position').addEventListener('change', function() {
                const position = parseInt(this.value) || 1;
                appState.departedCount = Math.max(0, position - 1);
                document.getElementById('departed-count').textContent = appState.departedCount;
            });
            
            // Limpiar salidas
            document.getElementById('clear-departures-btn').addEventListener('click', () => {
                if (appState.departureTimes.length === 0) {
                    showMessage('La lista ya está vacía', 'info');
                    return;
                }
                document.getElementById('clear-departures-modal').classList.add('active');
            });
            
            document.getElementById('clear-departures-confirm-btn').addEventListener('click', () => {
                clearDeparturesList();
                document.getElementById('clear-departures-modal').classList.remove('active');
            });
            
            // Exportar Excel
            document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
            
            // Iniciar cuenta atrás - CORREGIDO
            document.getElementById('start-countdown-btn').addEventListener('click', startCountdown);
            
            // Configuración en pantalla de ejecución
            document.getElementById('config-toggle').addEventListener('click', function(e) {
                console.log("Botón de configuración clickeado");
                e.stopPropagation();
                
                if (appState.countdownActive && !appState.configModalOpen) {
                    console.log("Abriendo modal de configuración durante cuenta atrás");
                    pauseCountdownVisual();
                    document.getElementById('config-during-countdown-modal').classList.add('active');
                } else {
                    console.log("No se puede abrir modal: cuenta atrás inactiva o modal ya abierto");
                }
            });

            document.getElementById('config-toggle').addEventListener('touchend', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (appState.countdownActive && !appState.configModalOpen) {
                    pauseCountdownVisual();
                    document.getElementById('config-during-countdown-modal').classList.add('active');
                }
            });
            
            // Edición inline del tiempo del próximo corredor
            document.getElementById('next-corredor-time').addEventListener('dblclick', function(e) {
                e.stopPropagation();
                
                const currentText = this.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'inline-edit-input';
                input.value = currentText;
                
                this.innerHTML = '';
                this.appendChild(input);
                input.focus();
                input.select();
                
                const finishEdit = () => {
                    const value = input.value.trim();
                    let seconds = 0;
                    
                    if (value.includes(':')) {
                        const parts = value.split(':');
                        const mins = parseInt(parts[0]) || 0;
                        const secs = parseInt(parts[1]) || 0;
                        seconds = mins * 60 + secs;
                    } else if (value.includes('min')) {
                        const mins = parseInt(value) || 0;
                        seconds = mins * 60;
                    } else {
                        seconds = parseInt(value) || 0;
                    }
                    
                    if (seconds > 0) {
                        appState.nextCorredorTime = seconds;
                        
                        if (appState.intervals.length === 1) {
                            appState.intervals[0].totalSeconds = seconds;
                            appState.intervals[0].minutes = Math.floor(seconds / 60);
                            appState.intervals[0].seconds = seconds % 60;
                        }
                        
                        if (appState.countdownActive && appState.countdownValue > seconds) {
                            appState.countdownValue = seconds;
                            updateCountdownDisplay();
                        }
                        
                        updateNextCorredorDisplay();
                        saveAppState();
                        saveVariableIntervalConfig();
                    }
                    
                    this.textContent = appState.nextCorredorTime >= 60 ? 
                        `${Math.floor(appState.nextCorredorTime / 60)}:${(appState.nextCorredorTime % 60).toString().padStart(2, '0')}` : 
                        appState.nextCorredorTime + "s";
                };
                
                input.addEventListener('blur', finishEdit);
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        finishEdit();
                    }
                });
            });
            
            // Edición inline de contadores
            document.getElementById('departed-count').addEventListener('dblclick', function(e) {
                e.stopPropagation();
                
                const currentValue = parseInt(this.textContent) || 0;
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'inline-edit-input';
                input.value = currentValue;
                input.min = 0;
                
                this.innerHTML = '';
                this.appendChild(input);
                input.focus();
                input.select();
                
                const finishEdit = () => {
                    const newValue = parseInt(input.value) || 0;
                    appState.departedCount = newValue;
                    this.textContent = newValue;
                    updateCurrentInterval();
                    saveAppState();
                    renderDeparturesList();
                };
                
                input.addEventListener('blur', finishEdit);
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        finishEdit();
                    }
                });
            });
            
            // Botones del footer
            document.getElementById('suggestions-btn').addEventListener('click', () => {
                document.getElementById('suggestions-modal').classList.add('active');
                document.getElementById('suggestion-text').focus();
            });
            
            document.getElementById('send-suggestion-btn').addEventListener('click', sendSuggestion);
            
            document.getElementById('install-btn').addEventListener('click', installPWA);
            
            document.getElementById('update-btn').addEventListener('click', () => {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.update();
                        showMessage(translations[appState.currentLanguage].updateChecked, 'info');
                    });
                }
            });
            
            // Actualizar cadencia al cambiar valores
            document.getElementById('interval-minutes').addEventListener('change', () => {
                if (!appState.countdownActive) {
                    updateCadenceTime();
                }
            });
            
            document.getElementById('interval-seconds').addEventListener('change', () => {
                if (!appState.countdownActive) {
                    updateCadenceTime();
                }
            });
            
            document.getElementById('same-interval-btn').addEventListener('click', () => {
                if (!appState.countdownActive) {
                    setTimeout(updateCadenceTime, 100);
                }
            });
            
            // Permitir Enter para enviar sugerencias
            document.getElementById('suggestion-text').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    sendSuggestion();
                }
            });
            
            // Guardar configuración de intervalos
            document.getElementById('same-interval-btn').addEventListener('click', () => {
                setTimeout(saveVariableIntervalConfig, 100);
            });
            
            document.getElementById('variable-interval-btn').addEventListener('click', () => {
                setTimeout(saveVariableIntervalConfig, 100);
            });
            
            console.log("Event listeners configurados correctamente");
        }

        // ============================================
        // INICIALIZACIÓN
        // ============================================

        document.addEventListener('DOMContentLoaded', initApp);

        window.addEventListener('beforeunload', () => {
            if (appState.countdownActive) {
                saveLastUpdate();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && appState.countdownActive && !appState.configModalOpen) {
                pauseCountdownVisual();
                document.getElementById('config-during-countdown-modal').classList.add('active');
            }
            
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('start-countdown-btn').click();
            }
        });
        // Función para ajustar tamaño del contador
function adjustCountdownSize() {
    const display = document.getElementById('countdown-display');
    if (!display) return;
    
    const screenWidth = window.innerWidth;
    const screenHeight = window.innerHeight;
    const text = display.textContent;
    const isAggressive = document.getElementById('countdown-screen').classList.contains('aggressive-numbers');
    
    // Determinar tamaño óptimo
    let fontSize;
    
    // Priorizar la dimensión más pequeña para evitar desbordamiento
    const minDimension = Math.min(screenWidth, screenHeight);
    
    if (isAggressive) {
        // Modo agresivo (últimos 5 segundos) - más grande
        if (minDimension < 400) {
            fontSize = minDimension * 0.35; // 35% en móviles pequeños
        } else if (minDimension < 768) {
            fontSize = minDimension * 0.30; // 30% en móviles
        } else if (minDimension < 1024) {
            fontSize = minDimension * 0.25; // 25% en tablets
        } else {
            fontSize = minDimension * 0.20; // 20% en desktop
        }
    } else {
        // Modo normal
        if (minDimension < 400) {
            fontSize = minDimension * 0.30; // 30% en móviles pequeños
        } else if (minDimension < 768) {
            fontSize = minDimension * 0.25; // 25% en móviles
        } else if (minDimension < 1024) {
            fontSize = minDimension * 0.20; // 20% en tablets
        } else {
            fontSize = minDimension * 0.15; // 15% en desktop
        }
    }
    
    // Limitar tamaño mínimo y máximo
    fontSize = Math.max(80, Math.min(fontSize, 500));
    
    // Aplicar tamaño
    display.style.fontSize = `${fontSize}px`;
    
    // Ajustar también el contenedor si es necesario
    display.style.lineHeight = `${fontSize * 0.9}px`;
}

// Llamar a la función en eventos relevantes
function setupCountdownResize() {
    // Al cargar
    window.addEventListener('load', adjustCountdownSize);
    
    // Al redimensionar
    window.addEventListener('resize', adjustCountdownSize);
    
    // Al cambiar orientación
    window.addEventListener('orientationchange', adjustCountdownSize);
    
    // También después de cada actualización del contador
    const originalUpdateCountdownDisplay = window.updateCountdownDisplay;
    window.updateCountdownDisplay = function() {
        if (originalUpdateCountdownDisplay) {
            originalUpdateCountdownDisplay();
        }
        adjustCountdownSize();
    };
}

        
    </script>

    <!-- Script para XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>