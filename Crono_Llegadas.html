<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crono Llegadas - Cron√≥metro Digital</title>
<style>
:root {
  --lcd-bg: #1a2a1a;
  --lcd-display: #0a1a0a;
  --lcd-digit-on: #4aff4a;
  --lcd-digit-off: #0a2a0a;
  --lcd-border: #3a5a3a;
  --lcd-glow: #6aff6a;
  --panel-bg: #2a3a2a;
  --panel-text: #e0ffe0;
  --accent: #6aff6a;
  --button-bg: #3a4a3a;
  --button-hover: #4a5a4a;
  --danger: #ff6a6a;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Courier New', monospace;
  background: linear-gradient(135deg, #1a2a1a 0%, #2a3a2a 100%);
  color: var(--panel-text);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 20px;
  min-height: 100vh;
}

.container {
  width: 100%;
  max-width: 600px;
  background: var(--panel-bg);
  border-radius: 15px;
  padding: 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  border: 2px solid var(--lcd-border);
}

.header {
  text-align: center;
  margin-bottom: 20px;
}

h1 {
  font-size: 2.5rem;
  color: var(--accent);
  text-shadow: 0 0 10px var(--lcd-glow);
  margin-bottom: 10px;
  letter-spacing: 3px;
}

.subtitle {
  color: var(--lcd-digit-on);
  font-size: 1rem;
  opacity: 0.8;
}

/* Pantalla LCD */
.lcd-display {
  background: var(--lcd-display);
  border: 3px solid var(--lcd-border);
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 
    inset 0 0 20px rgba(0, 0, 0, 0.8),
    0 0 20px rgba(74, 255, 74, 0.2);
}

.status-indicator {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.status-led {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--danger);
  box-shadow: 0 0 10px currentColor;
}

.status-led.running {
  background: var(--accent);
  box-shadow: 0 0 15px var(--lcd-glow);
}

.lcd-time {
  font-size: 0.9rem;
  color: var(--lcd-digit-on);
  text-shadow: 0 0 5px var(--lcd-glow);
}

/* Display principal con d√≠gitos LCD */
.main-display {
  display: flex;
  justify-content: center;
  align-items: center;
  background: var(--lcd-bg);
  border: 2px solid var(--lcd-border);
  border-radius: 8px;
  padding: 15px;
  margin: 10px 0;
}

.digital-display {
  display: flex;
  align-items: center;
  font-family: 'Segment7', monospace;
  font-size: 4rem;
  color: var(--lcd-digit-on);
  text-shadow: 0 0 10px var(--lcd-glow);
  letter-spacing: 2px;
}

.digit {
  display: inline-block;
  text-align: center;
  margin: 0 1px;
}

.separator {
  margin: 0 5px;
  opacity: 0.7;
}

.milliseconds {
  font-size: 2rem;
  margin-left: 10px;
  opacity: 0.9;
}

/* Controles principales */
.controls-main {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}

.btn-large {
  flex: 1;
  padding: 15px;
  font-size: 1.2rem;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  background: var(--button-bg);
  color: var(--panel-text);
  transition: all 0.3s;
  border: 2px solid var(--lcd-border);
}

.btn-large:hover {
  background: var(--button-hover);
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.btn-large:active {
  transform: translateY(0);
}

.btn-lap {
  background: var(--accent);
  color: #000;
  font-weight: bold;
}

.btn-lap:hover {
  background: var(--lcd-glow);
  box-shadow: 0 5px 15px rgba(74, 255, 74, 0.3);
}

.btn-start {
  background: #2a5a2a;
  color: var(--accent);
}

.btn-stop {
  background: #5a2a2a;
  color: var(--danger);
}

/* Lista de cortes */
.laps-container {
  background: var(--lcd-display);
  border: 2px solid var(--lcd-border);
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 15px;
  max-height: 200px;
  overflow-y: auto;
}

.laps-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  padding-bottom: 5px;
  border-bottom: 1px solid var(--lcd-border);
  font-weight: bold;
  color: var(--accent);
}

.lap-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid rgba(74, 255, 74, 0.1);
}

.lap-number {
  color: var(--accent);
  font-weight: bold;
  min-width: 60px;
}

.lap-time {
  font-family: 'Courier New', monospace;
  color: var(--lcd-digit-on);
  text-shadow: 0 0 5px var(--lcd-glow);
  flex-grow: 1;
  text-align: center;
}

.lap-dorsal {
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  background: rgba(74, 255, 74, 0.1);
  border: 1px solid var(--lcd-border);
  min-width: 120px;
  text-align: center;
  transition: all 0.3s;
}

.lap-dorsal:hover {
  background: rgba(74, 255, 74, 0.2);
  border-color: var(--accent);
}

.lap-dorsal.assigned {
  background: rgba(74, 255, 74, 0.3);
  border-color: var(--accent);
  font-weight: bold;
}

/* Controles secundarios */
.controls-secondary {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}

.btn-secondary {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: var(--button-bg);
  color: var(--panel-text);
  border: 1px solid var(--lcd-border);
  transition: all 0.3s;
}

.btn-secondary:hover {
  background: var(--button-hover);
}

/* Pesta√±as */
.tabs {
  display: flex;
  margin-bottom: 15px;
  background: var(--lcd-display);
  border-radius: 6px;
  border: 1px solid var(--lcd-border);
  overflow: hidden;
}

.tab {
  flex: 1;
  padding: 12px;
  text-align: center;
  cursor: pointer;
  background: var(--button-bg);
  transition: all 0.3s;
  border-right: 1px solid var(--lcd-border);
}

.tab:last-child {
  border-right: none;
}

.tab.active {
  background: var(--accent);
  color: #000;
  font-weight: bold;
}

.tab-content {
  background: var(--lcd-display);
  border: 1px solid var(--lcd-border);
  border-radius: 6px;
  padding: 15px;
  margin-bottom: 15px;
}

/* Dorsales */
.dorsal-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  border-bottom: 1px solid rgba(74, 255, 74, 0.1);
}

.dorsal-number {
  color: var(--accent);
  font-weight: bold;
  min-width: 80px;
}

.dorsal-times {
  flex-grow: 1;
  text-align: center;
  font-family: 'Courier New', monospace;
  color: var(--lcd-digit-on);
}

.dorsal-actions {
  display: flex;
  gap: 5px;
}

.btn-small {
  padding: 5px 10px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  background: var(--danger);
  color: white;
  font-size: 0.8rem;
}

/* Input groups */
.input-group {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
  align-items: center;
}

.input-group label {
  min-width: 150px;
  color: var(--accent);
}

.input-group input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid var(--lcd-border);
  border-radius: 4px;
  background: var(--lcd-display);
  color: var(--lcd-digit-on);
  font-family: 'Courier New', monospace;
}

.input-group input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 5px var(--lcd-glow);
}

/* Botones de exportaci√≥n */
.export-buttons {
  display: flex;
  gap: 10px;
}

.btn-export {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  background: var(--button-bg);
  color: var(--panel-text);
  border: 1px solid var(--lcd-border);
  transition: all 0.3s;
  font-weight: bold;
}

.btn-export:hover {
  background: var(--accent);
  color: #000;
  transform: translateY(-2px);
}

/* Modal de edici√≥n de dorsal */
.dorsal-input-container {
  display: flex;
  gap: 5px;
  align-items: center;
}

.dorsal-input {
  padding: 4px 8px;
  border: 1px solid var(--accent);
  border-radius: 4px;
  background: var(--lcd-display);
  color: var(--lcd-digit-on);
  width: 150px;
}

.dorsal-save-btn {
  padding: 4px 8px;
  background: var(--accent);
  color: #000;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}

.dorsal-cancel-btn {
  padding: 4px 8px;
  background: var(--danger);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

/* Fuente digital */
@font-face {
  font-family: 'Segment7';
  src: url('data:font/woff2;base64,d09GMgABAAAAA...') format('woff2');
  font-weight: normal;
  font-style: italic;
}

/* Scrollbar personalizado */
.laps-container::-webkit-scrollbar {
  width: 8px;
}

.laps-container::-webkit-scrollbar-track {
  background: var(--lcd-display);
}

.laps-container::-webkit-scrollbar-thumb {
  background: var(--lcd-border);
  border-radius: 4px;
}

.laps-container::-webkit-scrollbar-thumb:hover {
  background: var(--accent);
}

/* Responsive */
@media (max-width: 600px) {
  .container {
    padding: 15px;
  }
  
  .digital-display {
    font-size: 3rem;
  }
  
  .milliseconds {
    font-size: 1.5rem;
  }
  
  .controls-main, .controls-secondary {
    flex-direction: column;
  }
  
  .input-group {
    flex-direction: column;
    align-items: stretch;
  }
  
  .input-group label {
    min-width: auto;
    margin-bottom: 5px;
  }
}
</style>
</head>
<body>
<div class="container">
  <!-- Header -->
  <div class="header">
    <h1>CRONO LLEGADAS</h1>
    <div class="subtitle">SISTEMA DE CRONOMETRAJE DIGITAL</div>
  </div>

  <!-- Pantalla LCD -->
  <div class="lcd-display">
    <div class="status-indicator">
      <div class="status-led" id="status"></div>
      <div class="lcd-time" id="startTimeDisplay">HORA SALIDA: --:--:--.---</div>
    </div>
    
    <div class="main-display">
      <div class="digital-display" id="display">
        <span class="digit">0</span>
        <span class="digit">0</span>
        <span class="separator">:</span>
        <span class="digit">0</span>
        <span class="digit">0</span>
        <span class="separator">"</span>
        <span class="digit">0</span>
        <span class="digit">0</span>
        <span class="digit">0</span>
      </div>
    </div>
  </div>

  <!-- Bot√≥n principal de corte -->
  <div class="controls-main">
    <button id="lapBtn" class="btn-large btn-lap">‚è± REGISTRAR LLEGADA</button>
  </div>

  <!-- Lista de cortes -->
  <div class="laps-container">
    <div class="laps-header">
      <span>LLEGADA</span>
      <span>TIEMPO</span>
      <span>DORSAL</span>
    </div>
    <div id="laps">
      <!-- Los cortes aparecer√°n aqu√≠ -->
    </div>
  </div>

  <!-- Controles de inicio/pausa y reinicio -->
  <div class="controls-secondary">
    <button id="startStopBtn" class="btn-secondary btn-start">‚èµ INICIAR</button>
    <button id="resetBtn" class="btn-secondary">üîÑ REINICIAR</button>
  </div>

  <!-- Pesta√±as -->
  <div class="tabs">
    <div class="tab active" data-tab="config">CONFIGURACI√ìN</div>
    <div class="tab" data-tab="dorsales">DORSALES</div>
  </div>

  <!-- Contenido de pesta√±as -->
  <div class="tab-content">
    <!-- Configuraci√≥n -->
    <div id="configContent">
      <div class="input-group">
        <label>HORA DE SALIDA:</label>
        <input type="time" id="startTimeInput" step="1">
        <button id="setStartBtn" class="btn-small">FIJAR</button>
      </div>
      
      <div class="input-group">
        <label>TIEMPO MANUAL (HH:MM:SS):</label>
        <input type="text" id="setElapsedInput" placeholder="00:00:00">
        <button id="setElapsedBtn" class="btn-small">APLICAR</button>
      </div>
    </div>

    <!-- Dorsales -->
    <div id="dorsalesContent" style="display: none;">
      <div style="text-align: center; margin-bottom: 15px; color: var(--accent);">
        Haga clic en cualquier tiempo para asignar dorsales (m√∫ltiples separados por comas)
      </div>
      <div id="dorsalList">
        <!-- Los dorsales asignados aparecer√°n aqu√≠ -->
      </div>
    </div>
  </div>

  <!-- Botones de exportaci√≥n -->
  <div class="export-buttons">
    <button id="exportBtn" class="btn-export">üíæ EXPORTAR LLEGADAS</button>
    <button id="exportDorsalesBtn" class="btn-export">üíæ EXPORTAR DORSALES</button>
  </div>

  <!-- Ayuda -->
  <div style="text-align: center; margin-top: 15px; font-size: 0.8rem; color: var(--lcd-digit-on); opacity: 0.7;">
    Atajos: ESPACIO (Iniciar/Pausar) | L (Llegada) | Ctrl+R (Reiniciar)
  </div>
</div>

<script>
// Variables globales
let startTime = 0;
let elapsedTime = 0;
let timerInterval;
let running = false;
let lapTimes = [];
let startTimeValue = "";
let startTimeInSeconds = 0;
let dorsalAssignments = {};
let editingLapIndex = null;

// Elementos DOM
const display = document.getElementById('display');
const startStopBtn = document.getElementById('startStopBtn');
const lapBtn = document.getElementById('lapBtn');
const resetBtn = document.getElementById('resetBtn');
const startTimeInput = document.getElementById('startTimeInput');
const setStartBtn = document.getElementById('setStartBtn');
const laps = document.getElementById('laps');
const status = document.getElementById('status');
const exportBtn = document.getElementById('exportBtn');
const setElapsedInput = document.getElementById('setElapsedInput');
const setElapsedBtn = document.getElementById('setElapsedBtn');
const startTimeDisplay = document.getElementById('startTimeDisplay');
const dorsalList = document.getElementById('dorsalList');
const exportDorsalesBtn = document.getElementById('exportDorsalesBtn');

// Cargar datos guardados al iniciar
loadFromStorage();

// Funciones de formato
function formatTime(ms){
  let totalSeconds = Math.floor(ms / 1000);
  const milliseconds = ms % 1000;
  const seconds = totalSeconds % 60;
  const minutes = Math.floor(totalSeconds / 60) % 60;
  const hours = Math.floor(totalSeconds / 3600);

  return {
    hours: hours.toString().padStart(2, '0'),
    minutes: minutes.toString().padStart(2, '0'),
    seconds: seconds.toString().padStart(2, '0'),
    milliseconds: milliseconds.toString().padStart(3, '0')
  };
}

function formatHoraExacta(date){
  const h = String(date.getHours()).padStart(2,'0');
  const m = String(date.getMinutes()).padStart(2,'0');
  const s = String(date.getSeconds()).padStart(2,'0');
  const ms = String(date.getMilliseconds()).padStart(3,'0');
  return `${h}:${m}:${s}.${ms}`;
}

function formatHoraSalida(date){
  const h = String(date.getHours()).padStart(2,'0');
  const m = String(date.getMinutes()).padStart(2,'0');
  const s = String(date.getSeconds()).padStart(2,'0');
  const ms = String(date.getMilliseconds()).padStart(3,'0');
  return `${h}:${m}:${s}.${ms}`;
}

function horaToSeconds(horaStr) {
  const parts = horaStr.split(':');
  const h = parseInt(parts[0]);
  const m = parseInt(parts[1]);
  const sParts = parts[2].split('.');
  const s = parseInt(sParts[0]);
  const ms = parseInt(sParts[1] || 0);
  return (h * 3600) + (m * 60) + s + (ms / 1000);
}

function msToSeconds(ms) {
  return (ms / 1000).toFixed(3);
}

function updateDisplay(){
  const time = formatTime(elapsedTime);
  const digits = display.querySelectorAll('.digit');
  
  // Actualizar horas, minutos, segundos
  digits[0].textContent = time.hours[0];
  digits[1].textContent = time.hours[1];
  digits[3].textContent = time.minutes[0];
  digits[4].textContent = time.minutes[1];
  digits[6].textContent = time.seconds[0];
  digits[7].textContent = time.seconds[1];
  digits[8].textContent = time.milliseconds[0];
}

function updateStartTimeDisplay() {
  if (startTimeValue) {
    startTimeDisplay.textContent = `HORA SALIDA: ${startTimeValue}`;
  } else {
    startTimeDisplay.textContent = 'HORA SALIDA: --:--:--.---';
  }
}

function start(){
  if(!running){
    startTime = Date.now() - elapsedTime;
    timerInterval = setInterval(()=>{
      elapsedTime = Date.now() - startTime;
      updateDisplay();
      saveToStorage();
    },10);
    running = true;
    startStopBtn.textContent = '‚è∏ PAUSAR';
    startStopBtn.className = 'btn-secondary btn-stop';
    status.className = 'status-led running';
    
    if (!startTimeValue) {
      const now = new Date();
      startTimeInput.value = now.toTimeString().split(' ')[0];
      startTimeValue = formatHoraSalida(now);
      startTimeInSeconds = horaToSeconds(startTimeValue);
      updateStartTimeDisplay();
    }
  } else {
    clearInterval(timerInterval);
    running = false;
    startStopBtn.textContent = '‚èµ INICIAR';
    startStopBtn.className = 'btn-secondary btn-start';
    status.className = 'status-led';
  }
  saveToStorage();
}

function reset(){
  if(confirm('¬øSeguro que quieres reiniciar y borrar todos los registros?')){
    clearInterval(timerInterval);
    elapsedTime = 0;
    running = false;
    lapTimes = [];
    startTimeValue = "";
    startTimeInSeconds = 0;
    dorsalAssignments = {};
    editingLapIndex = null;
    updateDisplay();
    laps.innerHTML = '';
    startStopBtn.textContent = '‚èµ INICIAR';
    startStopBtn.className = 'btn-secondary btn-start';
    status.className = 'status-led';
    startTimeInput.value = "";
    updateStartTimeDisplay();
    renderDorsalList();
    localStorage.removeItem('cronoLlegadasCortes');
    localStorage.removeItem('cronoLlegadasTiempo');
    localStorage.removeItem('cronoLlegadasRunning');
    localStorage.removeItem('cronoLlegadasStartTime');
    localStorage.removeItem('cronoLlegadasStartTimeSeconds');
    localStorage.removeItem('cronoLlegadasDorsales');
  }
}

function lap(){
  if(!running) {
    lapBtn.style.backgroundColor = '#ff4444';
    setTimeout(() => {
      lapBtn.style.backgroundColor = '';
    }, 200);
    return;
  }
  
  lapBtn.style.transform = 'scale(0.95)';
  setTimeout(() => {
    lapBtn.style.transform = 'scale(1)';
  }, 100);
  
  const lapTime = elapsedTime;
  const now = new Date();
  const horaExacta = formatHoraExacta(now);
  const segundos = msToSeconds(lapTime);
  const tiempoLlegadaSegundos = startTimeInSeconds + parseFloat(segundos);
  
  lapTimes.push({
    timeMs: lapTime, 
    total: formatTimeDisplay(lapTime), 
    hora: horaExacta,
    segundos: segundos,
    tiempoSalidaSegundos: startTimeInSeconds,
    tiempoLlegadaSegundos: tiempoLlegadaSegundos.toFixed(3),
    dorsales: []
  });
  
  renderLaps();
  saveToStorage();
  laps.scrollTop = laps.scrollHeight;
}

function formatTimeDisplay(ms) {
  const time = formatTime(ms);
  return `${time.hours}:${time.minutes}:${time.seconds}"${time.milliseconds}`;
}

function startEditingDorsal(lapIndex){
  editingLapIndex = lapIndex;
  renderLaps();
}

function saveDorsales(lapIndex, dorsalInput){
  const dorsalesStr = dorsalInput.value.trim();
  
  if(dorsalesStr === '') {
    // Si est√° vac√≠o, eliminar todos los dorsales de este corte
    removeAllDorsalsFromLap(lapIndex);
    editingLapIndex = null;
    renderLaps();
    renderDorsalList();
    saveToStorage();
    return;
  }
  
  // Separar dorsales por comas y limpiar
  const dorsales = dorsalesStr.split(',')
    .map(d => d.trim())
    .filter(d => d !== '');
  
  if(dorsales.length === 0) {
    alert('Introduce al menos un dorsal v√°lido.');
    return;
  }
  
  // Validar que todos los dorsales sean n√∫meros
  for(const dorsal of dorsales) {
    if(isNaN(dorsal) || dorsal === '') {
      alert(`"${dorsal}" no es un dorsal v√°lido. Solo se permiten n√∫meros.`);
      return;
    }
  }
  
  // Actualizar el corte con los nuevos dorsales
  lapTimes[lapIndex].dorsales = dorsales;
  
  // Actualizar asignaciones globales
  updateDorsalAssignments();
  
  editingLapIndex = null;
  renderLaps();
  renderDorsalList();
  saveToStorage();
}

function cancelEditing(){
  editingLapIndex = null;
  renderLaps();
}

function removeAllDorsalsFromLap(lapIndex){
  lapTimes[lapIndex].dorsales = [];
  updateDorsalAssignments();
}

function updateDorsalAssignments(){
  // Reconstruir las asignaciones globales desde los cortes
  dorsalAssignments = {};
  
  lapTimes.forEach((lap, lapIndex) => {
    lap.dorsales.forEach(dorsal => {
      if(!dorsalAssignments[dorsal]) {
        dorsalAssignments[dorsal] = [];
      }
      if(!dorsalAssignments[dorsal].includes(lapIndex)) {
        dorsalAssignments[dorsal].push(lapIndex);
      }
    });
  });
}

function renderLaps(){
  laps.innerHTML = lapTimes.slice().reverse().map((lap, i) => {
    const lapIndex = lapTimes.length - i - 1;
    const isEditing = editingLapIndex === lapIndex;
    
    let dorsalDisplay;
    if(isEditing) {
      const currentDorsales = lap.dorsales.join(', ');
      dorsalDisplay = `
        <div class="dorsal-input-container">
          <input type="text" 
                 class="dorsal-input" 
                 value="${currentDorsales}" 
                 placeholder="1, 5, 12..."
                 onkeypress="if(event.key==='Enter') saveDorsales(${lapIndex}, this)">
          <button class="dorsal-save-btn" onclick="saveDorsales(${lapIndex}, this.previousElementSibling)">‚úì</button>
          <button class="dorsal-cancel-btn" onclick="cancelEditing()">‚úï</button>
        </div>
      `;
    } else {
      const dorsalText = lap.dorsales.length > 0 
        ? `Dorsales: ${lap.dorsales.join(', ')}`
        : 'Haz clic para asignar dorsales';
      
      dorsalDisplay = `
        <span class="lap-dorsal ${lap.dorsales.length > 0 ? 'assigned' : ''}" 
              onclick="startEditingDorsal(${lapIndex})">
          ${dorsalText}
        </span>
      `;
    }
    
    return `<li>
      <span>Corte ${lapTimes.length - i}</span>
      <div class="lap-info">
        <span class="lap-time">${lap.total}</span>
        <span class="lap-details">${lap.segundos}s | ${dorsalDisplay}</span>
      </div>
    </li>`;
  }).join('');
}

function renderDorsalList(){
  dorsalList.innerHTML = '';
  
  // Obtener todos los dorsales √∫nicos
  const dorsales = Object.keys(dorsalAssignments).sort((a, b) => parseInt(a) - parseInt(b));
  
  if(dorsales.length === 0) {
    dorsalList.innerHTML = '<div style="text-align: center; color: var(--partial); padding: 20px;">No hay dorsales asignados</div>';
    return;
  }
  
  dorsales.forEach(dorsal => {
    const lapIndices = dorsalAssignments[dorsal];
    const tiempos = lapIndices.map(index => lapTimes[index]);
    
    const dorsalElement = document.createElement('div');
    dorsalElement.className = 'dorsal-item';
    
    let tiemposHTML = tiempos.map((lap, i) => 
      `Vuelta ${i + 1}: ${lap.total}`
    ).join(' | ');
    
    dorsalElement.innerHTML = `
      <div class="dorsal-number">Dorsal ${dorsal}</div>
      <div class="dorsal-time">${tiemposHTML}</div>
      <div class="dorsal-actions">
        <button onclick="removeDorsal(${dorsal})" style="background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">‚úï</button>
      </div>
    `;
    
    dorsalList.appendChild(dorsalElement);
  });
}

function removeDorsal(dorsal){
  if(confirm(`¬øEliminar todas las asignaciones del dorsal ${dorsal}?`)){
    // Quitar el dorsal de todos los cortes
    lapTimes.forEach(lap => {
      lap.dorsales = lap.dorsales.filter(d => d != dorsal);
    });
    
    // Actualizar asignaciones globales
    updateDorsalAssignments();
    
    // Actualizar visualizaciones
    renderLaps();
    renderDorsalList();
    saveToStorage();
  }
}

function setStart(){
  if(!startTimeInput.value) return;
  const [h,m,s] = startTimeInput.value.split(':').map(Number);
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, s);
  startTime = start.getTime();
  elapsedTime = Date.now() - startTime;
  startTimeValue = formatHoraSalida(start); // Usar formato con mil√©simas
  startTimeInSeconds = horaToSeconds(startTimeValue);
  updateDisplay();
  updateStartTimeDisplay();
  saveToStorage();
}

function setElapsed(){
  const input = setElapsedInput.value.trim();
  const timeRegex = /^(\d{1,2}):([0-5]?\d):([0-5]?\d)$/;
  
  if(!timeRegex.test(input)) {
    alert('Formato inv√°lido. Use: hh:mm:ss (ej: 01:23:45)');
    return;
  }
  
  const parts = input.split(':').map(Number);
  const ms = ((parts[0]*3600)+(parts[1]*60)+parts[2])*1000;
  
  if(ms < 0) {
    alert('El tiempo no puede ser negativo');
    return;
  }
  
  elapsedTime = ms;
  startTime = Date.now() - ms;
  const startDate = new Date(startTime);
  startTimeInput.value = startDate.toTimeString().split(' ')[0];
  startTimeValue = formatHoraSalida(startDate); // Usar formato con mil√©simas
  startTimeInSeconds = horaToSeconds(startTimeValue);
  updateDisplay();
  updateStartTimeDisplay();
  saveToStorage();
  
  // Feedback visual
  setElapsedInput.style.borderColor = '#0f0';
  setTimeout(() => {
    setElapsedInput.style.borderColor = '';
  }, 1000);
}

function exportCSV(){
  if(lapTimes.length === 0){
    alert('No hay cortes para exportar.');
    return;
  }

  let csv = 'Corte #;Tiempo;Tiempo (segundos);Hora exacta;Hora salida;Tiempo salida (segundos);Tiempo llegada (segundos);Dorsales\n';
  lapTimes.forEach((lap, index) => {
    csv += `${index + 1};${lap.total};${lap.segundos};${lap.hora};${startTimeValue || "No establecida"};${lap.tiempoSalidaSegundos};${lap.tiempoLlegadaSegundos};${lap.dorsales.join(', ') || ""}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `cortes_ciclismo_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
}

function exportDorsalesCSV(){
  if(Object.keys(dorsalAssignments).length === 0){
    alert('No hay dorsales asignados para exportar.');
    return;
  }

  let csv = 'Dorsal;Vuelta;Tiempo;Tiempo (segundos);Hora exacta\n';
  
  Object.keys(dorsalAssignments).sort((a, b) => parseInt(a) - parseInt(b)).forEach(dorsal => {
    const lapIndices = dorsalAssignments[dorsal];
    lapIndices.forEach((lapIndex, vueltaIndex) => {
      const lap = lapTimes[lapIndex];
      csv += `${dorsal};${vueltaIndex + 1};${lap.total};${lap.segundos};${lap.hora}\n`;
    });
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `dorsales_ciclismo_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
}

// Guardar cortes en localStorage
function saveToStorage() {
  localStorage.setItem('cronometroCortes', JSON.stringify(lapTimes));
  localStorage.setItem('cronometroTiempo', elapsedTime);
  localStorage.setItem('cronometroRunning', running);
  localStorage.setItem('cronometroStartTime', startTimeValue);
  localStorage.setItem('cronometroStartTimeSeconds', startTimeInSeconds);
  localStorage.setItem('cronometroDorsales', JSON.stringify(dorsalAssignments));
}

function loadFromStorage() {
  const savedLaps = localStorage.getItem('cronometroCortes');
  const savedTime = localStorage.getItem('cronometroTiempo');
  const savedRunning = localStorage.getItem('cronometroRunning');
  const savedStartTime = localStorage.getItem('cronometroStartTime');
  const savedStartTimeSeconds = localStorage.getItem('cronometroStartTimeSeconds');
  const savedDorsales = localStorage.getItem('cronometroDorsales');
  
  if(savedLaps) {
    lapTimes = JSON.parse(savedLaps);
    // Asegurar que todos los cortes tengan el campo dorsales
    lapTimes.forEach(lap => {
      if(!lap.dorsales) {
        lap.dorsales = [];
      }
    });
  }
  if(savedTime) elapsedTime = Number(savedTime);
  if(savedRunning) running = JSON.parse(savedRunning);
  if(savedStartTime) {
    startTimeValue = savedStartTime;
    // Convertir la hora guardada al formato de input time
    const timeParts = savedStartTime.split(':');
    if (timeParts.length >= 2) {
      startTimeInput.value = `${timeParts[0]}:${timeParts[1]}:${timeParts[2] ? timeParts[2].split('.')[0] : '00'}`;
    }
  }
  if(savedStartTimeSeconds) {
    startTimeInSeconds = parseFloat(savedStartTimeSeconds);
  }
  if(savedDorsales) {
    dorsalAssignments = JSON.parse(savedDorsales);
  } else {
    // Si no hay dorsales guardados, reconstruir desde los cortes
    updateDorsalAssignments();
  }
  
  if(running) {
    startTime = Date.now() - elapsedTime;
    start();
  } else {
    updateDisplay();
    renderLaps();
  }
  
  // Actualizar estado visual
  status.style.color = running ? 'var(--led-run)' : 'var(--led-stop)';
  startStopBtn.textContent = running ? '‚è∏ Pausar' : '‚èµ Iniciar';
  updateStartTimeDisplay();
  renderDorsalList();
}

// Navegaci√≥n por pesta√±as
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    // Remover clase active de todas las pesta√±as
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    // A√±adir clase active a la pesta√±a clickeada
    tab.classList.add('active');
    
    // Mostrar contenido correspondiente
    const tabName = tab.getAttribute('data-tab');
    if(tabName === 'cortes') {
      document.getElementById('laps').style.display = 'block';
      document.getElementById('dorsalesContent').style.display = 'none';
    } else if(tabName === 'dorsales') {
      document.getElementById('laps').style.display = 'none';
      document.getElementById('dorsalesContent').style.display = 'block';
    }
  });
});

// Atajos de teclado
document.addEventListener('keydown', (e) => {
  if(e.code === 'Space') {
    e.preventDefault();
    startStopBtn.click();
  } else if(e.code === 'KeyL') {
    e.preventDefault();
    lapBtn.click();
  } else if(e.code === 'KeyR' && e.ctrlKey) {
    e.preventDefault();
    resetBtn.click();
  }
});

// Event listeners
startStopBtn.addEventListener('click', start);
resetBtn.addEventListener('click', reset);
lapBtn.addEventListener('click', lap);
setStartBtn.addEventListener('click', setStart);
setElapsedBtn.addEventListener('click', setElapsed);
exportBtn.addEventListener('click', exportCSV);
exportDorsalesBtn.addEventListener('click', exportDorsalesCSV);
</script>
</body>
</html>