<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cron√≥metro Web Persistente</title>
<style>
:root {
  --bg: #111;
  --text: #eee;
  --panel: #222;
  --accent: #0ff;
  --led-run: #0f0;
  --led-stop: #f00;
  --partial: #aaa;
}
@media (prefers-color-scheme: light) {
  :root {
    --bg: #f5f5f5;
    --text: #111;
    --panel: #ddd;
    --accent: #0077ff;
    --partial: #555;
  }
}
body {
  font-family: Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 20px;
  margin: 0;
  transition: background 0.3s, color 0.3s;
}
h1 {
  margin-bottom: 15px;
  color: var(--accent);
  text-shadow: 0 0 10px var(--accent);
}
#status {
  width: 15px;
  height: 15px;
  border-radius: 50%;
  margin-bottom: 10px;
  box-shadow: 0 0 10px currentColor;
}
#display {
  font-size: 3rem;
  margin-bottom: 15px;
  text-align: center;
}
.controls {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
  width: 100%;
}
.controls button {
  padding: 10px 20px;
  font-size: 1rem;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  background: var(--panel);
  color: var(--text);
  transition: 0.2s;
}
.controls button:hover {
  background: var(--accent);
  color: #000;
}
#lapBtn {
  width: 100%;
  font-size: 1.5rem;
  padding: 15px;
}
input[type="time"], input[type="text"] {
  font-size: 1rem;
  padding: 5px 10px;
  border-radius: 5px;
  border: 1px solid #555;
  background: var(--panel);
  color: var(--text);
  margin-right:5px;
}
ul {
  list-style: none;
  padding: 0;
  width: 90%;
  max-height: 250px;
  overflow-y: auto;
  border-top: 1px solid #333;
  margin-top: 15px;
}
li {
  border-bottom: 1px solid #333;
  padding: 5px 0;
  display: flex;
  justify-content: space-between;
}
li span.partial {
  color: var(--partial);
}
.bottom-controls {
  margin-top: 15px;
}
</style>
</head>
<body>
<h1>‚è± Cron√≥metro</h1>
<div id="status"></div>
<div id="display">0:00:00.000</div>

<!-- Bot√≥n Vuelta grande -->
<div class="controls">
  <button id="lapBtn">‚è± Vuelta</button>
</div>

<!-- Botones Iniciar/Continuar-Pausar y Reiniciar -->
<div class="controls">
  <button id="startStopBtn" style="flex:1;">‚èµ Iniciar</button>
  <button id="resetBtn" style="flex:1;">üîÑ Reiniciar</button>
</div>

<!-- Lista de vueltas -->
<ul id="laps"></ul>

<!-- Hora de inicio -->
<div style="margin-top:10px; width:100%;">
  <label>Hora de inicio: </label>
  <input type="time" id="startTimeInput" step="1">
  <button id="setStartBtn">Fijar</button>
</div>

<!-- Fijar tiempo manual -->
<div style="margin-top:10px; width:100%;">
  <label>Tiempo del cron√≥metro (hh:mm:ss): </label>
  <input type="text" id="setElapsedInput" placeholder="00:00:00">
  <button id="setElapsedBtn">Aplicar tiempo</button>
</div>

<!-- Exportar CSV -->
<div class="bottom-controls">
  <button id="exportBtn">üíæ Exportar vueltas (CSV)</button>
</div>

<script>
let startTime = 0;
let elapsedTime = 0;
let timerInterval;
let running = false;
const lapTimes = [];

const display = document.getElementById('display');
const startStopBtn = document.getElementById('startStopBtn');
const lapBtn = document.getElementById('lapBtn');
const resetBtn = document.getElementById('resetBtn');
const startTimeInput = document.getElementById('startTimeInput');
const setStartBtn = document.getElementById('setStartBtn');
const laps = document.getElementById('laps');
const status = document.getElementById('status');
const exportBtn = document.getElementById('exportBtn');
const setElapsedInput = document.getElementById('setElapsedInput');
const setElapsedBtn = document.getElementById('setElapsedBtn');

function saveState(){
  const state = { startTime, elapsedTime, running, laps: lapTimes };
  localStorage.setItem('cronometroState', JSON.stringify(state));
}

function loadState(){
  const saved = localStorage.getItem('cronometroState');
  if(!saved) return;
  const state = JSON.parse(saved);
  startTime=state.startTime;
  elapsedTime=state.elapsedTime;
  running=state.running;
  lapTimes.length=0;
  state.laps.forEach(t=>lapTimes.push(t));
  renderLaps();
  updateDisplay();
  updateStatus();
  updateStartButtonText();
  if(running){
    const now=Date.now();
    const delta=now-startTime+elapsedTime;
    startTime=now-delta;
    start();
  }
}

function updateDisplay(){
  display.textContent=formatTimeMs(elapsedTime);
}

function updateStatus(){
  status.style.background=running?'var(--led-run)':'var(--led-stop)';
  status.style.color=running?'var(--led-run)':'var(--led-stop)';
}

function updateStartButtonText(){
  if(running) startStopBtn.textContent = `‚è∏ Pausar`;
  else startStopBtn.textContent = elapsedTime>0 ? `‚èµ Continuar` : `‚èµ Iniciar`;
}

function start(){
  running=true;
  startTime=Date.now()-elapsedTime;
  if(!startTimeInput.value){
    const now=new Date();
    const hh=String(now.getHours()).padStart(2,'0');
    const mm=String(now.getMinutes()).padStart(2,'0');
    const ss=String(now.getSeconds()).padStart(2,'0');
    startTimeInput.value=`${hh}:${mm}:${ss}`;
  }
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{elapsedTime=Date.now()-startTime; updateDisplay(); saveState();},10);
  updateStartButtonText();
  updateStatus();
  saveState();
}

function pause(){
  running=false;
  clearInterval(timerInterval);
  updateStartButtonText();
  updateStatus();
  saveState();
}

function startStop(){ running ? pause() : start(); }

function reset(){
  if(!confirm("¬øEst√°s seguro de que quieres reiniciar el tiempo y borrar todas las vueltas?")) return;
  pause();
  elapsedTime = 0;
  lapTimes.length = 0;
  renderLaps();
  updateDisplay();
  updateStatus();
  saveState();
}

function addLap(){
  if(!running) return;
  let prev = lapTimes.length ? parseTimeMs(lapTimes[0].split(' | ')[0]) : 0;
  let partial = elapsedTime - prev;
  lapTimes.unshift(`${formatTimeMs(elapsedTime)} | ${formatTimeMs(partial)}`);
  renderLaps();
  saveState();
}

function renderLaps(){
  laps.innerHTML='';
  lapTimes.forEach(t=>{
    const [total, partial] = t.split(' | ');
    const li=document.createElement('li');
    li.innerHTML=`<span class="total">${total}</span> <span class="partial">${partial}</span>`;
    laps.appendChild(li);
  });
}

function setStartTime(){
  const value=startTimeInput.value;
  if(value){
    const [h,m,s]=value.split(':').map(Number);
    const now=new Date();
    const target=new Date();
    target.setHours(h,m,s||0,0);
    let diff=now-target;
    if(diff<0) diff+=24*3600*1000;
    elapsedTime=diff;
    updateDisplay();
    updateStartButtonText();
    saveState();
  }
}

function setElapsedTime(){
  const value=setElapsedInput.value.trim();
  if(!value.match(/^\d{2}:\d{2}:\d{2}$/)){alert("Formato inv√°lido. Usa hh:mm:ss"); return;}
  const [h,m,s]=value.split(':').map(Number);
  elapsedTime=((h*3600)+(m*60)+s)*1000;
  updateDisplay();
  const now=new Date();
  const start=new Date(now-elapsedTime);
  const hh=String(start.getHours()).padStart(2,'0');
  const mm=String(start.getMinutes()).padStart(2,'0');
  const ss=String(start.getSeconds()).padStart(2,'0');
  startTimeInput.value=`${hh}:${mm}:${ss}`;
  startTime=Date.now()-elapsedTime;
  updateStartButtonText();
  saveState();
}

function exportCSV(){
  if(lapTimes.length===0){alert("No hay vueltas para exportar."); return;}
  const csv="data:text/csv;charset=utf-8,"+["N¬∫,Tiempo total,Tiempo parcial"].join(",")+"\n"+
            lapTimes.map((t,i)=>`${i+1},${t.replace(' | ',',')}`).join("\n");
  const link=document.createElement('a');
  link.href=encodeURI(csv);
  link.download='vueltas.csv';
  link.click();
}

function parseTimeMs(str){
  const parts = str.split(':');
  let h=0, m=0, s=0, ms=0;

  if(parts.length === 3){
    h = Number(parts[0]);
    m = Number(parts[1]);
    if(parts[2].includes('.')){
      [s, ms] = parts[2].split('.').map(Number);
      ms = ms || 0;
    } else s = Number(parts[2]);
  } else if(parts.length === 2){
    m = Number(parts[0]);
    if(parts[1].includes('.')){
      [s, ms] = parts[1].split('.').map(Number);
      ms = ms || 0;
    } else s = Number(parts[1]);
  } else if(parts.length === 1){
    if(parts[0].includes('.')){
      [s, ms] = parts[0].split('.').map(Number);
      ms = ms || 0;
    } else s = Number(parts[0]);
  }

  return ((h*3600)+(m*60)+s)*1000 + ms;
}

function formatTimeMs(ms){
  let totalSeconds = Math.floor(ms/1000);
  const milliseconds = ms % 1000;

  const h = Math.floor(totalSeconds/3600);
  totalSeconds %= 3600;
  const m = Math.floor(totalSeconds/60);
  const s = totalSeconds % 60;

  let timeStr = '';
  if(h>0) timeStr += h + ':';
  if(h>0 || m>0) timeStr += m + ':';
  timeStr += s + '.' + String(milliseconds).padStart(3,'0');

  return timeStr;
}

startStopBtn.addEventListener('click',startStop);
resetBtn.addEventListener('click',reset);
lapBtn.addEventListener('click',addLap);
setStartBtn.addEventListener('click',setStartTime);
setElapsedBtn.addEventListener('click',setElapsedTime);
exportBtn.addEventListener('click',exportCSV);

loadState();
updateStatus();
updateStartButtonText();
</script>
</body>
</html>