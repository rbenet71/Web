<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Tiempos - Ciclismo</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 15px;
        }
        
        .calculator {
            background-color: #2c3e50;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 300px;
            padding: 20px;
            color: white;
            transform: scale(0.8);
        }
        
        .display {
            background-color: #1a252f;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            color: #fff;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.5);
        }
        
        .current-operation {
            font-size: 14px;
            min-height: 20px;
            margin-bottom: 12px;
            color: #7f8c8d;
            text-align: right;
        }
        
        .current-input {
            font-size: 26px;
            min-height: 32px;
            margin-bottom: 12px;
            text-align: right;
            font-weight: bold;
            color: #ecf0f1;
        }
        
        .history {
            font-size: 12px;
            color: #95a5a6;
            height: 60px;
            overflow-y: auto;
            border-top: 1px solid #34495e;
            padding-top: 8px;
        }
        
        .history-item {
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 1px solid #34495e;
            text-align: right;
        }
        
        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        button {
            background-color: #34495e;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            padding: 14px 0;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            background-color: #4a6583;
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .unit-btn {
            background-color: #2980b9;
        }
        
        .unit-btn:hover {
            background-color: #3498db;
        }
        
        .unit-btn.active {
            background-color: #1abc9c;
            box-shadow: 0 0 8px #1abc9c;
        }
        
        .memory-btn {
            background-color: #27ae60;
        }
        
        .memory-btn:hover {
            background-color: #2ecc71;
        }
        
        .operation-btn {
            background-color: #e67e22;
        }
        
        .operation-btn:hover {
            background-color: #f39c12;
        }
        
        .equals-btn {
            background-color: #c0392b;
        }
        
        .equals-btn:hover {
            background-color: #e74c3c;
        }
        
        .clear-btn {
            background-color: #8e44ad;
        }
        
        .clear-btn:hover {
            background-color: #9b59b6;
        }
        
        .zero-btn {
            grid-column: span 2;
        }
        
        .mode-indicator {
            color: #2ecc71;
            font-size: 13px;
            margin-top: 12px;
            text-align: center;
            font-weight: bold;
        }
        
        .title {
            text-align: center;
            margin-bottom: 15px;
            color: white;
            font-size: 19px;
            font-weight: bold;
        }
        
        .history::-webkit-scrollbar {
            width: 6px;
        }
        
        .history::-webkit-scrollbar-track {
            background: #34495e;
            border-radius: 3px;
        }
        
        .history::-webkit-scrollbar-thumb {
            background: #7f8c8d;
            border-radius: 3px;
        }
        
        .history::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }
    </style>
</head>
<body>
    <div class="calculator">
        <div class="title">Calculadora de Tiempos</div>
        
        <div class="display">
            <div class="current-operation" id="currentOperation"></div>
            <div class="current-input" id="currentInput">0</div>
            <div class="history" id="history"></div>
        </div>
        
        <div class="buttons">
            <button class="unit-btn" id="hourBtn" data-unit="hour">Hora</button>
            <button class="unit-btn" id="minuteBtn" data-unit="minute">Minuto</button>
            <button class="unit-btn" id="secondBtn" data-unit="second">Segundo</button>
            <button class="unit-btn active" id="decimalBtn" data-unit="decimal">Decimal</button>
            
            <button class="memory-btn" data-memory="m+">M+</button>
            <button class="memory-btn" data-memory="mc">Mc</button>
            <button class="memory-btn" data-memory="mr">Mr</button>
            <button class="operation-btn" data-operation="%">%</button>
            
            <button class="clear-btn" data-clear="c">C</button>
            <button class="clear-btn" data-clear="ce">CE</button>
            <button class="operation-btn" data-operation="*">×</button>
            <button class="operation-btn" data-operation="/">÷</button>
            
            <button data-number="7">7</button>
            <button data-number="8">8</button>
            <button data-number="9">9</button>
            <button class="operation-btn" data-operation="-">-</button>
            
            <button data-number="4">4</button>
            <button data-number="5">5</button>
            <button data-number="6">6</button>
            <button class="operation-btn" data-operation="+">+</button>
            
            <button data-number="1">1</button>
            <button data-number="2">2</button>
            <button data-number="3">3</button>
            <button class="operation-btn" data-operation="%+">%+</button>
            
            <button class="zero-btn" data-number="0">0</button>
            <button data-decimal>.</button>
            <button class="equals-btn" data-equals>=</button>
        </div>
        
        <div class="mode-indicator" id="modeIndicator">Modo: Decimal</div>
    </div>

    <script>
        class TimeCalculator {
            constructor() {
                this.currentInput = '0';
                this.previousInput = '';
                this.operation = null;
                this.mode = 'decimal';
                this.memory = 0;
                this.history = [];
                this.waitingForNewInput = false;
                
                // Variables para modo tiempo
                this.timeInput = {
                    hours: 0,
                    minutes: 0,
                    seconds: 0
                };
                this.currentNumber = '';
                this.isBuildingTime = false;
                
                this.initializeElements();
                this.attachEventListeners();
                this.updateDisplay();
            }
            
            initializeElements() {
                this.currentInputElement = document.getElementById('currentInput');
                this.currentOperationElement = document.getElementById('currentOperation');
                this.historyElement = document.getElementById('history');
                this.modeIndicatorElement = document.getElementById('modeIndicator');
                this.hourBtn = document.getElementById('hourBtn');
                this.minuteBtn = document.getElementById('minuteBtn');
                this.secondBtn = document.getElementById('secondBtn');
                this.decimalBtn = document.getElementById('decimalBtn');
            }
            
            attachEventListeners() {
                document.querySelectorAll('[data-number]').forEach(button => {
                    button.addEventListener('click', () => {
                        this.inputNumber(button.getAttribute('data-number'));
                    });
                });
                
                document.querySelector('[data-decimal]').addEventListener('click', () => {
                    this.inputDecimal();
                });
                
                document.querySelectorAll('[data-operation]').forEach(button => {
                    button.addEventListener('click', () => {
                        this.inputOperation(button.getAttribute('data-operation'));
                    });
                });
                
                document.querySelector('[data-equals]').addEventListener('click', () => {
                    this.calculate();
                });
                
                document.querySelectorAll('[data-memory]').forEach(button => {
                    button.addEventListener('click', () => {
                        this.handleMemory(button.getAttribute('data-memory'));
                    });
                });
                
                document.querySelectorAll('[data-unit]').forEach(button => {
                    button.addEventListener('click', () => {
                        this.setUnit(button.getAttribute('data-unit'));
                    });
                });
                
                document.querySelectorAll('[data-clear]').forEach(button => {
                    button.addEventListener('click', () => {
                        this.handleClear(button.getAttribute('data-clear'));
                    });
                });
            }
            
            inputNumber(number) {
                if (this.mode === 'decimal') {
                    if (this.waitingForNewInput) {
                        this.currentInput = number;
                        this.waitingForNewInput = false;
                    } else {
                        this.currentInput = this.currentInput === '0' ? number : this.currentInput + number;
                    }
                } else {
                    // Modo tiempo - acumular números pero mantener el display del tiempo completo
                    if (!this.isBuildingTime || this.waitingForNewInput) {
                        this.currentNumber = '';
                        this.isBuildingTime = true;
                        this.waitingForNewInput = false;
                    }
                    this.currentNumber += number;
                    
                    // Mostrar el tiempo completo + el número que se está introduciendo (sin el signo +)
                    const timeDisplay = this.formatTimeInput();
                    if (timeDisplay !== '0') {
                        this.currentInput = timeDisplay + ' ' + this.currentNumber;
                    } else {
                        this.currentInput = this.currentNumber;
                    }
                }
                this.updateDisplay();
            }
            
            setUnit(unit) {
                // Actualizar botones activos
                this.hourBtn.classList.remove('active');
                this.minuteBtn.classList.remove('active');
                this.secondBtn.classList.remove('active');
                this.decimalBtn.classList.remove('active');
                
                if (unit === 'decimal') {
                    this.mode = 'decimal';
                    this.modeIndicatorElement.textContent = 'Modo: Decimal';
                    this.decimalBtn.classList.add('active');
                    this.currentInput = '0';
                    this.currentNumber = '';
                    this.isBuildingTime = false;
                    this.resetTimeInput();
                } else {
                    this.mode = 'time';
                    this.modeIndicatorElement.textContent = `Modo: Tiempo`;
                    
                    // Activar el botón correspondiente
                    document.getElementById(unit + 'Btn').classList.add('active');
                    
                    // SIEMPRE asignar el número actual a la unidad, incluso si estamos empezando
                    if (this.currentNumber && this.currentNumber !== '0') {
                        const value = parseInt(this.currentNumber);
                        
                        if (unit === 'hour') {
                            this.timeInput.hours = value;
                        } else if (unit === 'minute') {
                            this.timeInput.minutes = value;
                        } else if (unit === 'second') {
                            this.timeInput.seconds = value;
                        }
                        
                        this.currentNumber = '';
                        this.isBuildingTime = false;
                    } else if (this.currentInput !== '0' && !isNaN(this.currentInput)) {
                        // Si currentInput tiene un número válido (no es '0' y no es NaN)
                        const value = parseInt(this.currentInput);
                        
                        if (unit === 'hour') {
                            this.timeInput.hours = value;
                        } else if (unit === 'minute') {
                            this.timeInput.minutes = value;
                        } else if (unit === 'second') {
                            this.timeInput.seconds = value;
                        }
                    }
                    
                    // Mostrar el tiempo actual
                    this.currentInput = this.formatTimeInput();
                }
                this.updateDisplay();
            }
            
            formatTimeInput() {
                let parts = [];
                if (this.timeInput.hours > 0) parts.push(this.timeInput.hours + 'h');
                if (this.timeInput.minutes > 0) parts.push(this.timeInput.minutes + 'm');
                if (this.timeInput.seconds > 0) parts.push(this.timeInput.seconds + 's');
                
                return parts.length > 0 ? parts.join(' ') : '0';
            }
            
            getTimeInSeconds() {
                return this.timeInput.hours * 3600 + 
                       this.timeInput.minutes * 60 + 
                       this.timeInput.seconds;
            }
            
            resetTimeInput() {
                this.timeInput = { hours: 0, minutes: 0, seconds: 0 };
            }
            
            inputDecimal() {
                if (this.mode === 'decimal') {
                    if (this.waitingForNewInput) {
                        this.currentInput = '0.';
                        this.waitingForNewInput = false;
                    } else if (this.currentInput.indexOf('.') === -1) {
                        this.currentInput += '.';
                    }
                }
                this.updateDisplay();
            }
            
            inputOperation(op) {
                if (this.operation && !this.waitingForNewInput) {
                    this.calculate();
                }
                
                // Convertir tiempo a segundos para operaciones
                if (this.mode === 'time') {
                    const seconds = this.getTimeInSeconds();
                    this.currentInput = seconds.toString();
                    this.resetTimeInput();
                }
                
                this.operation = op;
                this.previousInput = this.currentInput;
                this.waitingForNewInput = true;
                
                // Limpiar la línea de operación después de pulsar la operación
                this.currentOperationElement.textContent = '';
                this.updateDisplay();
            }
            
            calculate() {
                if (!this.operation || this.waitingForNewInput) return;
                
                let prev = this.parseTimeToSeconds(this.previousInput);
                let current = this.parseTimeToSeconds(this.currentInput);
                let result;
                let operationString = '';
                
                switch (this.operation) {
                    case '+':
                        result = prev + current;
                        operationString = `${this.formatTimeForOperation(this.previousInput)} + ${this.formatTimeForOperation(this.currentInput)}`;
                        break;
                    case '-':
                        result = prev - current;
                        operationString = `${this.formatTimeForOperation(this.previousInput)} - ${this.formatTimeForOperation(this.currentInput)}`;
                        break;
                    case '*':
                        result = prev * current;
                        operationString = `${this.formatTimeForOperation(this.previousInput)} × ${this.formatTimeForOperation(this.currentInput)}`;
                        break;
                    case '/':
                        if (current === 0) {
                            alert("Error: División por cero");
                            return;
                        }
                        result = prev / current;
                        operationString = `${this.formatTimeForOperation(this.previousInput)} ÷ ${this.formatTimeForOperation(this.currentInput)}`;
                        break;
                    case '%':
                        result = prev % current;
                        operationString = `${this.formatTimeForOperation(this.previousInput)} % ${this.formatTimeForOperation(this.currentInput)}`;
                        break;
                    case '%+':
                        result = prev * (1 + current / 100);
                        operationString = `${this.formatTimeForOperation(this.previousInput)} %+ ${this.formatTimeForOperation(this.currentInput)}`;
                        break;
                    default:
                        return;
                }
                
                // Formatear resultado
                let displayResult;
                let historyResult;
                
                if (this.mode === 'time') {
                    displayResult = this.formatTime(result);
                    historyResult = `${operationString} = ${displayResult} (${Math.round(result)}s)`;
                } else {
                    displayResult = result.toString();
                    historyResult = `${operationString} = ${displayResult}`;
                }
                
                this.currentInput = displayResult;
                this.addToHistory(historyResult);
                this.operation = null;
                this.previousInput = '';
                this.waitingForNewInput = true;
                this.updateDisplay();
            }
            
            parseTimeToSeconds(timeStr) {
                if (typeof timeStr === 'number') return timeStr;
                
                // Si es un número decimal normal
                if (!isNaN(timeStr)) return parseFloat(timeStr);
                
                // Parsear formato de tiempo (1h 30m 45s)
                let seconds = 0;
                const hoursMatch = timeStr.match(/(\d+)h/);
                const minutesMatch = timeStr.match(/(\d+)m/);
                const secondsMatch = timeStr.match(/(\d+)s/);
                
                if (hoursMatch) seconds += parseInt(hoursMatch[1]) * 3600;
                if (minutesMatch) seconds += parseInt(minutesMatch[1]) * 60;
                if (secondsMatch) seconds += parseInt(secondsMatch[1]);
                
                return seconds;
            }
            
            formatTimeForOperation(value) {
                // Si el valor ya está en formato tiempo, mantenerlo sin segundos
                if (isNaN(value)) {
                    return value;
                }
                // Si es un número (segundos), convertirlo a formato tiempo sin segundos
                const numValue = parseFloat(value);
                return this.formatTime(numValue);
            }
            
            formatTimeForHistory(value) {
                // Para el historial, mostrar con conversión a segundos
                if (isNaN(value)) {
                    const seconds = this.parseTimeToSeconds(value);
                    return value + ` (${seconds}s)`;
                }
                const numValue = parseFloat(value);
                return this.formatTime(numValue) + ` (${Math.round(numValue)}s)`;
            }
            
            handleMemory(memoryOp) {
                switch (memoryOp) {
                    case 'm+':
                        this.memory += parseFloat(this.currentInput);
                        break;
                    case 'mc':
                        this.memory = 0;
                        break;
                    case 'mr':
                        this.currentInput = this.memory.toString();
                        this.waitingForNewInput = true;
                        break;
                }
                this.updateDisplay();
            }
            
            handleClear(clearType) {
                if (clearType === 'c') {
                    this.currentInput = '0';
                    this.previousInput = '';
                    this.operation = null;
                    this.currentNumber = '';
                    this.isBuildingTime = false;
                    this.resetTimeInput();
                    this.hourBtn.classList.remove('active');
                    this.minuteBtn.classList.remove('active');
                    this.secondBtn.classList.remove('active');
                    this.decimalBtn.classList.add('active');
                    this.mode = 'decimal';
                    this.modeIndicatorElement.textContent = 'Modo: Decimal';
                } else if (clearType === 'ce') {
                    this.currentInput = '0';
                    this.currentNumber = '';
                    this.isBuildingTime = false;
                }
                this.updateDisplay();
            }
            
            formatTime(totalSeconds) {
                let hours = Math.floor(totalSeconds / 3600);
                let minutes = Math.floor((totalSeconds % 3600) / 60);
                let seconds = Math.floor(totalSeconds % 60);
                let milliseconds = Math.round((totalSeconds % 1) * 1000);
                
                let parts = [];
                if (hours > 0) {
                    parts.push(hours + 'h');
                    // Si hay horas, siempre mostrar minutos y segundos (aunque sean 0)
                    parts.push(minutes.toString().padStart(2, '0') + 'm');
                    parts.push(seconds.toString().padStart(2, '0') + 's');
                } else if (minutes > 0) {
                    // Si hay minutos pero no horas, mostrar minutos y segundos
                    parts.push(minutes + 'm');
                    parts.push(seconds.toString().padStart(2, '0') + 's');
                } else {
                    // Si solo hay segundos, mostrar solo segundos
                    parts.push(seconds + 's');
                }
                
                if (milliseconds > 0) parts.push(milliseconds.toString().padStart(3, '0') + 'ms');
                
                return parts.join(' ');
            }
            
            addToHistory(operation) {
                this.history.unshift(operation);
                if (this.history.length > 20) this.history.pop();
                this.updateHistoryDisplay();
            }
            
            updateDisplay() {
                // En la línea de entrada actual, mostrar solo el formato de tiempo sin segundos
                this.currentInputElement.textContent = this.currentInput;
                
                // En la línea de operación, mostrar solo durante la entrada, no después de pulsar operación
                if (this.operation && !this.waitingForNewInput) {
                    this.currentOperationElement.textContent = 
                        `${this.formatTimeForOperation(this.previousInput)} ${this.operation}`;
                } else {
                    this.currentOperationElement.textContent = '';
                }
            }
            
            updateHistoryDisplay() {
                this.historyElement.innerHTML = '';
                this.history.slice(0, 3).forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.textContent = item;
                    this.historyElement.appendChild(div);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new TimeCalculator();
        });
    </script>
</body>
</html>