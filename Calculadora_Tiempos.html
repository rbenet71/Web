<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Tiempos - Ciclismo V1</title>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CV925PMBQV"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-CV925PMBQV');
    </script>

	<!-- Iconos para la aplicaci√≥n -->
	<link rel="icon" type="image/png" href="https://rbenet71.github.io/Web/Calculadora_Tiempos_192x192.png">
	<link rel="apple-touch-icon" href="https://rbenet71.github.io/Web/Calculadora_Tiempos_192x192.png">

	<!-- Iconos para PWA -->
	<link rel="icon" type="image/png" href="https://rbenet71.github.io/Web/Calculadora_Tiempos_192x192.png?v=2">
	<link rel="apple-touch-icon" href="https://rbenet71.github.io/Web/Calculadora_Tiempos_192x192.png?v=2">
	<link rel="icon" type="image/png" sizes="192x192" href="https://rbenet71.github.io/Web/Calculadora_Tiempos_192x192.png?v=2">
	<link rel="icon" type="image/png" sizes="512x512" href="https://rbenet71.github.io/Web/Calculadora_Tiempos_192x192.png?v=2">
	<link rel="apple-touch-icon" sizes="192x192" href="https://rbenet71.github.io/Web/Calculadora_Tiempos_192x192.png?v=2">
	<meta name="msapplication-TileImage" content="https://rbenet71.github.io/Web/Calculadora_Tiempos_192x192.png?v=2">
	
	<!-- Configuraci√≥n para PWA (Progressive Web App) -->
	<meta name="theme-color" content="#2c3e50">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="Crono 80%">
	<meta name="msapplication-TileColor" content="#2c3e50">
	<meta name="msapplication-TileImage" content="https://rbenet71.github.io/Web/Calculadora_Tiempos.png">

	<!-- Manifest para PWA -->
	<link rel="manifest" href="https://rbenet71.github.io/Web/Calculadora_Tiempos_manifest.json">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 12px;
        }
        
        .calculator {
            background-color: #2c3e50;
            border-radius: 10px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 256px; /* Reducido de 320px */
            padding: 16px;
            color: white;
        }
        
        .display {
            background-color: #1a252f;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            color: #fff;
            min-height: 112px; /* Reducido de 140px */
            display: flex;
            flex-direction: column;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.5);
            position: relative; /* A√±adido para posicionar el indicador de modo */
        }
        
        .current-operation {
            font-size: 11px; /* Reducido de 14px */
            min-height: 16px;
            margin-bottom: 10px;
            color: #7f8c8d;
            text-align: right;
        }
        
        .current-input {
            font-size: 21px; /* Reducido de 26px */
            min-height: 26px;
            margin-bottom: 10px;
            text-align: right;
            font-weight: bold;
            color: #ecf0f1;
        }
        
        .history {
            font-size: 10px; /* Reducido de 12px */
            color: #95a5a6;
            height: 48px; /* Reducido de 60px */
            overflow-y: auto;
            border-top: 1px solid #34495e;
            padding-top: 6px;
        }
        
        .history-item {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #34495e;
            text-align: right;
        }
        
        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px; /* Reducido de 10px */
            margin-bottom: 8px;
        }
        
        button {
            background-color: #34495e;
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 11px; /* Reducido de 14px */
            padding: 11px 0; /* Reducido de 14px */
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            background-color: #4a6583;
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .unit-btn {
            background-color: #2980b9;
        }
        
        .unit-btn:hover {
            background-color: #3498db;
        }
        
        .unit-btn.active {
            background-color: #1abc9c;
            box-shadow: 0 0 6px #1abc9c;
        }
        
        .memory-btn {
            background-color: #27ae60;
        }
        
        .memory-btn:hover {
            background-color: #2ecc71;
        }
        
        .operation-btn {
            background-color: #e67e22;
        }
        
        .operation-btn:hover {
            background-color: #f39c12;
        }
        
        .equals-btn {
            background-color: #c0392b;
        }
        
        .equals-btn:hover {
            background-color: #e74c3c;
        }
        
        .clear-btn {
            background-color: #8e44ad;
        }
        
        .clear-btn:hover {
            background-color: #9b59b6;
        }
        
        .special-btn {
            background-color: #16a085;
        }
        
        .special-btn:hover {
            background-color: #1abc9c;
        }
        
        .zero-btn {
            grid-column: span 2;
        }
        
        .special-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px; /* Reducido de 10px */
            margin-top: 8px;
        }
        
        .title {
            text-align: center;
            margin-bottom: 12px;
            color: white;
            font-size: 15px; /* Reducido de 19px */
            font-weight: bold;
        }
        
        .history::-webkit-scrollbar {
            width: 5px; /* Reducido de 6px */
        }
        
        .history::-webkit-scrollbar-track {
            background: #34495e;
            border-radius: 2px;
        }
        
        .history::-webkit-scrollbar-thumb {
            background: #7f8c8d;
            border-radius: 2px;
        }
        
        .history::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #2c3e50;
            padding: 16px;
            border-radius: 8px;
            width: 90%;
            max-width: 320px; /* Reducido de 400px */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        
        .modal-title {
            text-align: center;
            margin-bottom: 12px;
            color: white;
            font-size: 14px; /* Reducido de 18px */
        }
        
        .modal-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 12px;
            border-radius: 4px;
            border: 1px solid #34495e;
            background-color: #1a252f;
            color: white;
            font-size: 13px; /* Reducido de 16px */
        }
        
        .modal-buttons {
            display: flex;
            justify-content: space-between;
        }
        
        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }
        
        .modal-cancel {
            background-color: #7f8c8d;
            color: white;
        }
        
        .modal-calculate {
            background-color: #27ae60;
            color: white;
        }
        
        /* Nuevos estilos para el header */
        .calculator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .language-selector {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .flag {
            width: 20px; /* Reducido de 25px */
            height: 14px; /* Reducido de 17px */
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s;
            border: 1px solid #ccc;
        }
        
        .flag.active {
            opacity: 1;
            border: 2px solid #3498db;
        }
        
        .flag-catalunya {
            background: linear-gradient(
                to bottom,
                #ffcd00 0%, #ffcd00 10%,
                #da121a 10%, #da121a 20%,
                #ffcd00 20%, #ffcd00 30%,
                #da121a 30%, #da121a 40%,
                #ffcd00 40%, #ffcd00 50%,
                #da121a 50%, #da121a 60%,
                #ffcd00 60%, #ffcd00 70%,
                #da121a 70%, #da121a 80%,
                #ffcd00 80%, #ffcd00 90%,
                #da121a 90%, #da121a 100%
            );
        }
        
        .help-icon {
            font-size: 1rem; /* Reducido de 1.2rem */
            cursor: pointer;
            color: #3498db;
            margin-left: 4px;
            transition: all 0.3s;
        }
        
        .help-icon:hover {
            transform: scale(1.1);
            color: #2c3e50;
        }
        
        /* Footer */
        .calculator-footer {
            text-align: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #34495e;
            color: #95a5a6;
            font-size: 10px; /* Reducido de 12px */
        }
        
        .calculator-footer a {
            color: #3498db;
            text-decoration: none;
            font-weight: bold;
        }
        
        .calculator-footer a:hover {
            text-decoration: underline;
        }
        
        .btn-help {
            background-color: #3498db;
            color: white;
            padding: 6px 13px; /* Reducido de 8px 16px */
            margin-top: 8px;
            width: 100%;
            font-size: 11px;
        }
        
        .btn-install {
            background-color: #9b59b6;
            color: white;
            padding: 6px 13px;
            margin-top: 8px;
            width: 100%;
            font-size: 11px;
        }
        
        .btn-install:hover {
            background-color: #8e44ad;
        }
        
        /* Nuevos estilos para el indicador de modo en el display */
        .display-mode-indicator {
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 9px;
            color: #7f8c8d;
            font-weight: normal;
        }
        
        /* Estilos para el modal de instalaci√≥n */
        .install-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .install-modal-content {
            background-color: #2c3e50;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 300px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .install-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .install-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            min-height: 40px;
        }
        
        .install-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .install-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .install-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .install-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            min-width: 100px;
        }
        
        .install-primary {
            background-color: #3498db;
            color: white;
        }
        
        .install-secondary {
            background-color: #7f8c8d;
            color: white;
        }
        
        .install-instructions {
            margin-top: 15px;
            padding: 10px;
            background-color: #34495e;
            border-radius: 5px;
            font-size: 10px;
            text-align: left;
        }
        
        .install-instructions h4 {
            margin-bottom: 5px;
            color: #ecf0f1;
        }
    </style>
</head>
<body>
    <div class="calculator">
        <div class="calculator-header">
    <div style="display: flex; align-items: center; gap: 8px;">
        <img src="https://rbenet71.github.io/Web/Calculadora_Tiempos_192x192.png" 
             alt="Logo" 
             style="width: 24px; height: 24px; border-radius: 4px;">
        <div class="title">Calculadora de Tiempos</div>
    </div>
            <div class="language-selector">
                <img src="https://flagcdn.com/w40/es.png" class="flag active" id="flag-es" data-lang="es">
                <div class="flag flag-catalunya" id="flag-ca" data-lang="ca"></div>
                <img src="https://flagcdn.com/w40/gb.png" class="flag" id="flag-en" data-lang="en">
                <span class="help-icon" id="help-icon-header" title="Ayuda">‚ùì</span>
            </div>
        </div>
        <div class="display">
            <div class="display-mode-indicator" id="displayModeIndicator">Modo: Decimal</div>
            <div class="current-operation" id="currentOperation"></div>
            <div class="current-input" id="currentInput">0</div>
            <div class="history" id="history"></div>
        </div>
        
        <div class="buttons">
            <button class="unit-btn" id="hourBtn" data-unit="hour">Hora</button>
            <button class="unit-btn" id="minuteBtn" data-unit="minute">Minuto</button>
            <button class="unit-btn" id="secondBtn" data-unit="second">Segundo</button>
            <button class="unit-btn active" id="decimalBtn" data-unit="decimal">Decimal</button>
            
            <button class="memory-btn" data-memory="m+">M+</button>
            <button class="memory-btn" data-memory="mc">Mc</button>
            <button class="memory-btn" data-memory="mr">Mr</button>
            <button class="operation-btn" data-operation="%">%</button>
            
            <button class="clear-btn" data-clear="c">C</button>
            <button class="clear-btn" data-clear="ce">CE</button>
            <button class="operation-btn" data-operation="*">√ó</button>
            <button class="operation-btn" data-operation="/">√∑</button>
            
            <button data-number="7">7</button>
            <button data-number="8">8</button>
            <button data-number="9">9</button>
            <button class="operation-btn" data-operation="%+">%+</button>
            
            <button data-number="4">4</button>
            <button data-number="5">5</button>
            <button data-number="6">6</button>
            <button class="operation-btn" data-operation="-">-</button>
            
            <button data-number="1">1</button>
            <button data-number="2">2</button>
            <button data-number="3">3</button>
            <button class="operation-btn" data-operation="+">+</button>
            
            <button class="zero-btn" data-number="0">0</button>
            <button data-decimal>.</button>
            <button class="equals-btn" data-equals>=</button>
        </div>
        
        <div class="special-buttons">
            <button class="special-btn" id="averageBtn">C√°lculo Promedio</button>
            <button class="special-btn" id="lapsBtn">N√∫mero de Vueltas</button>
        </div>
        
        <button class="btn-help" id="btn-help">Ayuda</button>
        <button class="btn-install" id="btn-install">Instalar App</button>
        
        <div class="calculator-footer">
            <p>
                <span id="copyright-text">2025 ¬© Copyright</span>
                <a href="https://rbenet71.github.io/Web/" target="_blank" id="copyright-link">
                    Roberto Benet - rbenet71@gmail.com - V_01_12_2025
                </a>
            </p>
        </div>
    </div>

    <!-- Modal para C√°lculo de Promedio -->
    <div class="modal" id="averageModal">
        <div class="modal-content">
            <div class="modal-title">C√°lculo de Promedio (km/h)</div>
            <input type="number" class="modal-input" id="distanceInput" placeholder="Distancia en km" step="0.1">
            <input type="text" class="modal-input" id="timeInput" placeholder="Tiempo (ej: 1h 30m 45s)">
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="cancelAverage">Cancelar</button>
                <button class="modal-btn modal-calculate" id="calculateAverage">Calcular</button>
            </div>
        </div>
    </div>

    <!-- Modal para C√°lculo de Vueltas -->
    <div class="modal" id="lapsModal">
        <div class="modal-content">
            <div class="modal-title">C√°lculo de N√∫mero de Vueltas</div>
            <input type="text" class="modal-input" id="lapTimeInput" placeholder="Tiempo por vuelta (ej: 5m 30s)">
            <input type="text" class="modal-input" id="targetTimeInput" placeholder="Tiempo objetivo (ej: 1h 30m)">
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="cancelLaps">Cancelar</button>
                <button class="modal-btn modal-calculate" id="calculateLaps">Calcular</button>
            </div>
        </div>
    </div>

    <!-- Modal para Instalaci√≥n -->
    <div class="install-modal" id="installModal">
        <div class="install-modal-content">
            <div class="install-icon" id="installIcon">üì±</div>
            <div class="install-message" id="installMessage"></div>
            <div class="install-buttons">
                <button class="install-btn install-primary" id="installActionBtn">Instalar</button>
                <button class="install-btn install-secondary" id="installCancelBtn">Cerrar</button>
            </div>
            <div class="install-instructions" id="installInstructions">
                <h4 id="instructionsTitle">Instrucciones de instalaci√≥n</h4>
                <div id="instructionsList">
                    <!-- Las instrucciones se llenar√°n din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales para el sistema de idiomas
        let currentLanguage = 'es';
        
        // Textos en diferentes idiomas
        const translations = {
            es: {
                appTitle: "Calculadora de Tiempos",
                modeDecimal: "Modo: Decimal",
                modeTime: "Modo: Tiempo",
                averageCalc: "C√°lculo Promedio",
                lapsCalc: "N√∫mero de Vueltas",
                helpButton: "Ayuda",
                installButton: "Instalar App",
                averageModalTitle: "C√°lculo de Promedio (km/h)",
                distancePlaceholder: "Distancia en km",
                timePlaceholder: "Tiempo (ej: 1h 30m 45s)",
                lapsModalTitle: "C√°lculo de N√∫mero de Vueltas",
                lapTimePlaceholder: "Tiempo por vuelta (ej: 5m 30s)",
                targetTimePlaceholder: "Tiempo objetivo (ej: 1h 30m)",
                cancelButton: "Cancelar",
                calculateButton: "Calcular",
                hourButton: "Hora",
                minuteButton: "Minuto",
                secondButton: "Segundo",
                decimalButton: "Decimal",
                installTitle: "Instalar App",
                installSubtitle: "A√±ade un acceso directo a tu dispositivo",
                installAction: "Instalar",
                installClose: "Cerrar",
                iosInstructionsTitle: "Instalar en iPhone/iPad",
                iosInstructions: `<ol style="padding-left: 15px;">
                    <li>Toca el bot√≥n "Instalar"</li>
                    <li>Se abrir√° el men√∫ de compartir</li>
                    <li>Despl√°zate y selecciona <strong>"A√±adir a Pantalla de Inicio"</strong></li>
                    <li>Pulsa <strong>"A√±adir"</strong> para confirmar</li>
                </ol>`,
                androidInstructionsTitle: "Instalar en Android",
                androidInstructions: `<ol style="padding-left: 15px;">
                    <li>Toca el bot√≥n "Instalar"</li>
                    <li>Se instalar√° autom√°ticamente como app PWA</li>
                    <li>La app aparecer√° en tu pantalla de inicio</li>
                </ol>`,
                windowsInstructionsTitle: "Crear Acceso Directo en Windows",
                windowsInstructions: `<ol style="padding-left: 15px;">
                    <li>Toca el bot√≥n "Instalar"</li>
                    <li>Se descargar√° un archivo .url</li>
                    <li>√Åbrelo para crear el acceso directo en tu escritorio</li>
                </ol>`,
                otherInstructionsTitle: "Instalar App",
                otherInstructions: `<ol style="padding-left: 15px;">
                    <li>Toca el bot√≥n "Instalar"</li>
                    <li>Sigue las instrucciones de tu navegador</li>
                </ol>`
            },
            ca: {
                appTitle: "Calculadora de Temps",
                modeDecimal: "Mode: Decimal",
                modeTime: "Mode: Temps",
                averageCalc: "C√†lcul Promig",
                lapsCalc: "Nombre de Voltes",
                helpButton: "Ajuda",
                installButton: "Instal¬∑lar App",
                averageModalTitle: "C√†lcul de Promig (km/h)",
                distancePlaceholder: "Dist√†ncia en km",
                timePlaceholder: "Temps (ex: 1h 30m 45s)",
                lapsModalTitle: "C√†lcul de Nombre de Voltes",
                lapTimePlaceholder: "Temps per volta (ex: 5m 30s)",
                targetTimePlaceholder: "Temps objectiu (ex: 1h 30m)",
                cancelButton: "Cancel¬∑lar",
                calculateButton: "Calcular",
                hourButton: "Hora",
                minuteButton: "Minut",
                secondButton: "Segon",
                decimalButton: "Decimal",
                installTitle: "Instal¬∑lar App",
                installSubtitle: "Afegeix un acc√©s directe al teu dispositiu",
                installAction: "Instal¬∑lar",
                installClose: "Tancar",
                iosInstructionsTitle: "Instal¬∑lar a iPhone/iPad",
                iosInstructions: `<ol style="padding-left: 15px;">
                    <li>Toca el bot√≥ "Instal¬∑lar"</li>
                    <li>S'obrir√† el men√∫ de compartir</li>
                    <li>Despla√ßa't i selecciona <strong>"Afegeix a la pantalla d'inici"</strong></li>
                    <li>Prem <strong>"Afegeix"</strong> per confirmar</li>
                </ol>`,
                androidInstructionsTitle: "Instal¬∑lar a Android",
                androidInstructions: `<ol style="padding-left: 15px;">
                    <li>Toca el bot√≥ "Instal¬∑lar"</li>
                    <li>S'instal¬∑lar√† autom√†ticament com a app PWA</li>
                    <li>L'app apareixer√† a la teva pantalla d'inici</li>
                </ol>`,
                windowsInstructionsTitle: "Crear Acc√©s Directe a Windows",
                windowsInstructions: `<ol style="padding-left: 15px;">
                    <li>Toca el bot√≥ "Instal¬∑lar"</li>
                    <li>Es descarregar√† un arxiu .url</li>
                    <li>Obre'l per crear l'acc√©s directe al teu escriptori</li>
                </ol>`,
                otherInstructionsTitle: "Instal¬∑lar App",
                otherInstructions: `<ol style="padding-left: 15px;">
                    <li>Toca el bot√≥ "Instal¬∑lar"</li>
                    <li>Segueix les instruccions del teu navegador</li>
                </ol>`
            },
            en: {
                appTitle: "Time Calculator",
                modeDecimal: "Mode: Decimal",
                modeTime: "Mode: Time",
                averageCalc: "Average Calculation",
                lapsCalc: "Number of Laps",
                helpButton: "Help",
                installButton: "Install App",
                averageModalTitle: "Average Calculation (km/h)",
                distancePlaceholder: "Distance in km",
                timePlaceholder: "Time (ex: 1h 30m 45s)",
                lapsModalTitle: "Number of Laps Calculation",
                lapTimePlaceholder: "Time per lap (ex: 5m 30s)",
                targetTimePlaceholder: "Target time (ex: 1h 30m)",
                cancelButton: "Cancel",
                calculateButton: "Calculate",
                hourButton: "Hour",
                minuteButton: "Minute",
                secondButton: "Second",
                decimalButton: "Decimal",
                installTitle: "Install App",
                installSubtitle: "Add a shortcut to your device",
                installAction: "Install",
                installClose: "Close",
                iosInstructionsTitle: "Install on iPhone/iPad",
                iosInstructions: `<ol style="padding-left: 15px;">
                    <li>Tap the "Install" button</li>
                    <li>The share menu will open</li>
                    <li>Scroll and select <strong>"Add to Home Screen"</strong></li>
                    <li>Tap <strong>"Add"</strong> to confirm</li>
                </ol>`,
                androidInstructionsTitle: "Install on Android",
                androidInstructions: `<ol style="padding-left: 15px;">
                    <li>Tap the "Install" button</li>
                    <li>It will automatically install as a PWA</li>
                    <li>The app will appear on your home screen</li>
                </ol>`,
                windowsInstructionsTitle: "Create Shortcut on Windows",
                windowsInstructions: `<ol style="padding-left: 15px;">
                    <li>Tap the "Install" button</li>
                    <li>A .url file will be downloaded</li>
                    <li>Open it to create the shortcut on your desktop</li>
                </ol>`,
                otherInstructionsTitle: "Install App",
                otherInstructions: `<ol style="padding-left: 15px;">
                    <li>Tap the "Install" button</li>
                    <li>Follow your browser instructions</li>
                </ol>`
            }
        };

        // Funci√≥n para actualizar idioma
        function updateLanguage(lang) {
            currentLanguage = lang;
            
            // Actualizar textos
            document.querySelector('.title').textContent = translations[lang].appTitle;
            document.getElementById('displayModeIndicator').textContent = translations[lang].modeDecimal;
            document.getElementById('averageBtn').textContent = translations[lang].averageCalc;
            document.getElementById('lapsBtn').textContent = translations[lang].lapsCalc;
            document.getElementById('btn-help').textContent = translations[lang].helpButton;
            document.getElementById('btn-install').textContent = translations[lang].installButton;
            
            // Actualizar textos de modales
            document.querySelector('#averageModal .modal-title').textContent = translations[lang].averageModalTitle;
            document.getElementById('distanceInput').placeholder = translations[lang].distancePlaceholder;
            document.getElementById('timeInput').placeholder = translations[lang].timePlaceholder;
            document.getElementById('cancelAverage').textContent = translations[lang].cancelButton;
            document.getElementById('calculateAverage').textContent = translations[lang].calculateButton;
            
            document.querySelector('#lapsModal .modal-title').textContent = translations[lang].lapsModalTitle;
            document.getElementById('lapTimeInput').placeholder = translations[lang].lapTimePlaceholder;
            document.getElementById('targetTimeInput').placeholder = translations[lang].targetTimePlaceholder;
            document.getElementById('cancelLaps').textContent = translations[lang].cancelButton;
            document.getElementById('calculateLaps').textContent = translations[lang].calculateButton;
            
            // Actualizar botones de unidad
            document.getElementById('hourBtn').textContent = translations[lang].hourButton;
            document.getElementById('minuteBtn').textContent = translations[lang].minuteButton;
            document.getElementById('secondBtn').textContent = translations[lang].secondButton;
            document.getElementById('decimalBtn').textContent = translations[lang].decimalButton;
            
            // Actualizar banderas activas
            document.querySelectorAll('.flag').forEach(flag => {
                flag.classList.remove('active');
            });
            document.getElementById('flag-' + lang).classList.add('active');
        }
        
        // Funci√≥n para abrir el archivo de ayuda
        function openHelpFile() {
            window.open('https://rbenet71.github.io/Web/Calculadora_Tiempos_Ayuda.html', '_blank');
        }

        // Sistema de instalaci√≥n de app
        class AppInstaller {
            constructor() {
                this.installModal = document.getElementById('installModal');
                this.installIcon = document.getElementById('installIcon');
                this.installMessage = document.getElementById('installMessage');
                this.installActionBtn = document.getElementById('installActionBtn');
                this.installCancelBtn = document.getElementById('installCancelBtn');
                this.instructionsTitle = document.getElementById('instructionsTitle');
                this.instructionsList = document.getElementById('instructionsList');
                
                this.deferredPrompt = null;
                this.platform = this.detectPlatform();
                
                this.initialize();
            }
            
            initialize() {
                this.attachEventListeners();
                this.setupForPlatform();
            }
            
            detectPlatform() {
                const userAgent = navigator.userAgent.toLowerCase();
                
                if (/iphone|ipad|ipod/.test(userAgent)) {
                    return 'iOS';
                } else if (/android/.test(userAgent)) {
                    return 'Android';
                } else if (/windows/.test(userAgent)) {
                    return 'Windows';
                } else {
                    return 'Other';
                }
            }
            
            setupForPlatform() {
                switch(this.platform) {
                    case 'iOS':
                        this.setupIOS();
                        break;
                    case 'Android':
                        this.setupAndroid();
                        break;
                    case 'Windows':
                        this.setupWindows();
                        break;
                    default:
                        this.setupOther();
                }
            }
            
            setupIOS() {
                this.installIcon.textContent = 'üì±';
                this.installActionBtn.textContent = translations[currentLanguage].installAction;
                this.instructionsTitle.textContent = translations[currentLanguage].iosInstructionsTitle;
                this.instructionsList.innerHTML = translations[currentLanguage].iosInstructions;
            }
            
            setupAndroid() {
                this.installIcon.textContent = 'ü§ñ';
                this.installActionBtn.textContent = translations[currentLanguage].installAction;
                this.instructionsTitle.textContent = translations[currentLanguage].androidInstructionsTitle;
                this.instructionsList.innerHTML = translations[currentLanguage].androidInstructions;
                
                // Escuchar evento de instalaci√≥n PWA
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                });
            }
            
            setupWindows() {
                this.installIcon.textContent = 'üíª';
                this.installActionBtn.textContent = translations[currentLanguage].installAction;
                this.instructionsTitle.textContent = translations[currentLanguage].windowsInstructionsTitle;
                this.instructionsList.innerHTML = translations[currentLanguage].windowsInstructions;
            }
            
            setupOther() {
                this.installIcon.textContent = 'üåê';
                this.installActionBtn.textContent = translations[currentLanguage].installAction;
                this.instructionsTitle.textContent = translations[currentLanguage].otherInstructionsTitle;
                this.instructionsList.innerHTML = translations[currentLanguage].otherInstructions;
            }
            
            attachEventListeners() {
                // Bot√≥n para abrir modal de instalaci√≥n
                document.getElementById('btn-install').addEventListener('click', () => {
                    this.showInstallModal();
                });
                
                // Botones del modal
                this.installActionBtn.addEventListener('click', () => {
                    this.handleInstall();
                });
                
                this.installCancelBtn.addEventListener('click', () => {
                    this.hideInstallModal();
                });
                
                // Cerrar modal al hacer clic fuera
                window.addEventListener('click', (e) => {
                    if (e.target === this.installModal) {
                        this.hideInstallModal();
                    }
                });
            }
            
            showInstallModal() {
                this.installModal.style.display = 'flex';
                this.showMessage(translations[currentLanguage].installSubtitle, true);
            }
            
            hideInstallModal() {
                this.installModal.style.display = 'none';
            }
            
            showMessage(message, isInfo = true) {
                this.installMessage.textContent = message;
                this.installMessage.className = `install-message ${isInfo ? 'install-info' : 'install-success'}`;
            }
            
            async handleInstall() {
                switch(this.platform) {
                    case 'iOS':
                        this.installIOS();
                        break;
                    case 'Android':
                        await this.installAndroid();
                        break;
                    case 'Windows':
                        this.installWindows();
                        break;
                    default:
                        this.installOther();
                }
            }
            
            installIOS() {
                if (navigator.share) {
                    navigator.share({
                        title: document.title,
                        text: 'Instalar esta app en mi pantalla de inicio',
                        url: window.location.href
                    })
                    .then(() => {
                        this.showMessage('‚úÖ Ahora selecciona "A√±adir a Pantalla de Inicio"', false);
                    })
                    .catch((error) => {
                        if (error.name !== 'AbortError') {
                            this.showMessage('‚ùå No se pudo abrir el men√∫ de compartir', true);
                        }
                    });
                } else {
                    this.showMessage('‚ùå Tu navegador no soporta esta funci√≥n', true);
                }
            }
            
            async installAndroid() {
                if (this.deferredPrompt) {
                    try {
                        this.deferredPrompt.prompt();
                        const { outcome } = await this.deferredPrompt.userChoice;
                        
                        if (outcome === 'accepted') {
                            this.showMessage('‚úÖ App instalada correctamente', false);
                            this.installActionBtn.style.display = 'none';
                        } else {
                            this.showMessage('Instalaci√≥n cancelada', true);
                        }
                        this.deferredPrompt = null;
                    } catch (error) {
                        this.showMessage('‚ùå Error en la instalaci√≥n', true);
                    }
                } else {
                    this.showMessage('üîß Tu navegador soporta instalaci√≥n PWA', false);
                }
            }
            
            installWindows() {
                // Crear y descargar archivo .url para acceso directo
                const urlContent = `[InternetShortcut]
URL=${window.location.href}
IconIndex=0
IDList=`;
                
                const blob = new Blob([urlContent], { type: 'application/internet-shortcut' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${document.title}.url`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showMessage('‚úÖ Archivo de acceso directo descargado', false);
            }
            
            installOther() {
                if (navigator.share) {
                    navigator.share({
                        title: document.title,
                        text: 'Instalar esta app',
                        url: window.location.href
                    });
                } else {
                    this.showMessage('‚≠ê Usa el men√∫ de tu navegador para crear un acceso directo', false);
                }
            }
        }
        
        class TimeCalculator {
            constructor() {
                this.currentInput = '0';
                this.previousInput = '';
                this.operation = null;
                this.mode = 'decimal';
                this.memory = 0;
                this.memoryMode = 'decimal';
                this.history = [];
                this.waitingForNewInput = false;
                
                // Variables para modo tiempo
                this.timeInput = {
                    hours: 0,
                    minutes: 0,
                    seconds: 0
                };
                this.currentNumber = '';
                this.isBuildingTime = false;
                this.operationMode = 'decimal';
                this.lastResult = null;
                
                // Modales
                this.averageModal = document.getElementById('averageModal');
                this.lapsModal = document.getElementById('lapsModal');
                
                this.initializeElements();
                this.attachEventListeners();
                this.updateDisplay();
            }
            
            initializeElements() {
                this.currentInputElement = document.getElementById('currentInput');
                this.currentOperationElement = document.getElementById('currentOperation');
                this.historyElement = document.getElementById('history');
                this.displayModeIndicator = document.getElementById('displayModeIndicator');
                this.hourBtn = document.getElementById('hourBtn');
                this.minuteBtn = document.getElementById('minuteBtn');
                this.secondBtn = document.getElementById('secondBtn');
                this.decimalBtn = document.getElementById('decimalBtn');
            }
            
            attachEventListeners() {
                document.querySelectorAll('[data-number]').forEach(button => {
                    button.addEventListener('click', () => {
                        this.inputNumber(button.getAttribute('data-number'));
                    });
                });
                
                document.querySelector('[data-decimal]').addEventListener('click', () => {
                    this.inputDecimal();
                });
                
                document.querySelectorAll('[data-operation]').forEach(button => {
                    button.addEventListener('click', () => {
                        this.inputOperation(button.getAttribute('data-operation'));
                    });
                });
                
                document.querySelector('[data-equals]').addEventListener('click', () => {
                    this.calculate();
                });
                
                document.querySelectorAll('[data-memory]').forEach(button => {
                    button.addEventListener('click', () => {
                        this.handleMemory(button.getAttribute('data-memory'));
                    });
                });
                
                document.querySelectorAll('[data-unit]').forEach(button => {
                    button.addEventListener('click', () => {
                        this.setUnit(button.getAttribute('data-unit'));
                    });
                });
                
                document.querySelectorAll('[data-clear]').forEach(button => {
                    button.addEventListener('click', () => {
                        this.handleClear(button.getAttribute('data-clear'));
                    });
                });
                
                // Eventos para botones especiales
                document.getElementById('averageBtn').addEventListener('click', () => {
                    this.showAverageModal();
                });
                
                document.getElementById('lapsBtn').addEventListener('click', () => {
                    this.showLapsModal();
                });
                
                // Eventos para modales
                document.getElementById('cancelAverage').addEventListener('click', () => {
                    this.hideAverageModal();
                });
                
                document.getElementById('calculateAverage').addEventListener('click', () => {
                    this.calculateAverage();
                });
                
                document.getElementById('cancelLaps').addEventListener('click', () => {
                    this.hideLapsModal();
                });
                
                document.getElementById('calculateLaps').addEventListener('click', () => {
                    this.calculateLaps();
                });
                
                // Eventos para ayuda
                document.getElementById('btn-help').addEventListener('click', openHelpFile);
                document.getElementById('help-icon-header').addEventListener('click', openHelpFile);
                
                // Eventos para cambio de idioma
                document.querySelectorAll('.flag').forEach(flag => {
                    flag.addEventListener('click', function() {
                        const lang = this.getAttribute('data-lang');
                        updateLanguage(lang);
                        // Guardar idioma seleccionado
                        localStorage.setItem('timeCalcLanguage', lang);
                    });
                });
                
                // Cerrar modales al hacer clic fuera
                window.addEventListener('click', (e) => {
                    if (e.target === this.averageModal) {
                        this.hideAverageModal();
                    }
                    if (e.target === this.lapsModal) {
                        this.hideLapsModal();
                    }
                });
            }
            
            showAverageModal() {
                document.getElementById('distanceInput').value = '';
                document.getElementById('timeInput').value = '';
                this.averageModal.style.display = 'flex';
            }
            
            hideAverageModal() {
                this.averageModal.style.display = 'none';
            }
            
            showLapsModal() {
                document.getElementById('lapTimeInput').value = '';
                document.getElementById('targetTimeInput').value = '';
                this.lapsModal.style.display = 'flex';
            }
            
            hideLapsModal() {
                this.lapsModal.style.display = 'none';
            }
            
            calculateAverage() {
                const distance = parseFloat(document.getElementById('distanceInput').value);
                const timeStr = document.getElementById('timeInput').value;
                
                if (!distance || !timeStr) {
                    alert('Por favor, complete todos los campos');
                    return;
                }
                
                const timeInSeconds = this.parseTimeToSeconds(timeStr);
                const timeInHours = timeInSeconds / 3600;
                const average = distance / timeInHours;
                
                this.addToHistory(`Promedio: ${distance}km / ${this.formatTime(timeInSeconds)} = ${average.toFixed(2)} km/h`);
                this.currentInput = average.toFixed(2);
                this.waitingForNewInput = true;
                this.updateDisplay();
                this.hideAverageModal();
            }
            
            calculateLaps() {
                const lapTimeStr = document.getElementById('lapTimeInput').value;
                const targetTimeStr = document.getElementById('targetTimeInput').value;
                
                if (!lapTimeStr || !targetTimeStr) {
                    alert('Por favor, complete todos los campos');
                    return;
                }
                
                const lapTimeInSeconds = this.parseTimeToSeconds(lapTimeStr);
                const targetTimeInSeconds = this.parseTimeToSeconds(targetTimeStr);
                
                if (lapTimeInSeconds === 0) {
                    alert('El tiempo por vuelta no puede ser cero');
                    return;
                }
                
                const exactLaps = targetTimeInSeconds / lapTimeInSeconds;
                let roundedLaps = Math.floor(exactLaps);
                
                // Si la parte decimal es mayor o igual a 0.5, redondear hacia arriba
                if (exactLaps - roundedLaps >= 0.5) {
                    roundedLaps = Math.ceil(exactLaps);
                }
                
                this.addToHistory(`Vueltas: ${this.formatTime(targetTimeInSeconds)} / ${this.formatTime(lapTimeInSeconds)} = ${roundedLaps} vueltas`);
                this.currentInput = roundedLaps.toString();
                this.waitingForNewInput = true;
                this.updateDisplay();
                this.hideLapsModal();
            }
            
            inputNumber(number) {
                if (this.mode === 'decimal') {
                    if (this.waitingForNewInput) {
                        this.currentInput = number;
                        this.waitingForNewInput = false;
                        this.lastResult = null;
                    } else {
                        this.currentInput = this.currentInput === '0' ? number : this.currentInput + number;
                    }
                } else {
                    // Modo tiempo - acumular n√∫meros pero mantener el display del tiempo completo
                    if (!this.isBuildingTime || this.waitingForNewInput) {
                        this.currentNumber = '';
                        this.isBuildingTime = true;
                        this.waitingForNewInput = false;
                        this.lastResult = null;
                    }
                    this.currentNumber += number;
                    
                    // Mostrar el tiempo completo + el n√∫mero que se est√° introduciendo (sin el signo +)
                    const timeDisplay = this.formatTimeInput();
                    if (timeDisplay !== '0') {
                        this.currentInput = timeDisplay + ' ' + this.currentNumber;
                    } else {
                        this.currentInput = this.currentNumber;
                    }
                }
                this.updateDisplay();
            }
            
            setUnit(unit) {
                // Actualizar botones activos
                this.hourBtn.classList.remove('active');
                this.minuteBtn.classList.remove('active');
                this.secondBtn.classList.remove('active');
                this.decimalBtn.classList.remove('active');
                
                if (unit === 'decimal') {
                    this.mode = 'decimal';
                    this.displayModeIndicator.textContent = translations[currentLanguage].modeDecimal;
                    this.decimalBtn.classList.add('active');
                    this.currentInput = '0';
                    this.currentNumber = '';
                    this.isBuildingTime = false;
                    this.resetTimeInput();
                } else {
                    this.mode = 'time';
                    this.displayModeIndicator.textContent = translations[currentLanguage].modeTime;
                    
                    // Activar el bot√≥n correspondiente
                    document.getElementById(unit + 'Btn').classList.add('active');
                    
                    // SIEMPRE asignar el n√∫mero actual a la unidad, incluso si estamos empezando
                    if (this.currentNumber && this.currentNumber !== '0') {
                        const value = parseInt(this.currentNumber);
                        
                        if (unit === 'hour') {
                            this.timeInput.hours = value;
                        } else if (unit === 'minute') {
                            this.timeInput.minutes = value;
                        } else if (unit === 'second') {
                            this.timeInput.seconds = value;
                        }
                        
                        this.currentNumber = '';
                        this.isBuildingTime = false;
                    } else if (this.currentInput !== '0' && !isNaN(this.currentInput)) {
                        // Si currentInput tiene un n√∫mero v√°lido (no es '0' y no es NaN)
                        const value = parseInt(this.currentInput);
                        
                        if (unit === 'hour') {
                            this.timeInput.hours = value;
                        } else if (unit === 'minute') {
                            this.timeInput.minutes = value;
                        } else if (unit === 'second') {
                            this.timeInput.seconds = value;
                        }
                    }
                    
                    // Mostrar el tiempo actual
                    this.currentInput = this.formatTimeInput();
                }
                this.updateDisplay();
            }
            
            formatTimeInput() {
                let parts = [];
                if (this.timeInput.hours > 0) parts.push(this.timeInput.hours + 'h');
                if (this.timeInput.minutes > 0) parts.push(this.timeInput.minutes + 'm');
                if (this.timeInput.seconds > 0) parts.push(this.timeInput.seconds + 's');
                
                return parts.length > 0 ? parts.join(' ') : '0';
            }
            
            getTimeInSeconds() {
                return this.timeInput.hours * 3600 + 
                       this.timeInput.minutes * 60 + 
                       this.timeInput.seconds;
            }
            
            resetTimeInput() {
                this.timeInput = { hours: 0, minutes: 0, seconds: 0 };
            }
            
            inputDecimal() {
                if (this.mode === 'decimal') {
                    if (this.waitingForNewInput) {
                        this.currentInput = '0.';
                        this.waitingForNewInput = false;
                        this.lastResult = null;
                    } else if (this.currentInput.indexOf('.') === -1) {
                        this.currentInput += '.';
                    }
                }
                this.updateDisplay();
            }
            
            inputOperation(op) {
                // Si hay un √∫ltimo resultado y estamos empezando nueva operaci√≥n, usarlo
                if (this.lastResult && this.waitingForNewInput && !this.operation) {
                    this.previousInput = this.lastResult.toString();
                    this.currentInput = this.lastResult.toString();
                }
                
                if (this.operation && !this.waitingForNewInput) {
                    this.calculate();
                }
                
                // Guardar el modo actual al iniciar la operaci√≥n
                this.operationMode = this.mode;
                
                // Limpiar la l√≠nea de entrada actual despu√©s de pulsar una operaci√≥n
                if (this.mode === 'time') {
                    const seconds = this.getTimeInSeconds();
                    this.previousInput = seconds.toString(); // Guardar en segundos para c√°lculo
                    // Mostrar el tiempo formateado en la l√≠nea de operaci√≥n
                    const displayTime = this.formatTimeInput();
                    this.currentOperationElement.textContent = `${displayTime} ${op}`;
                    // Limpiar la l√≠nea de entrada actual
                    this.currentInput = '0';
                    this.resetTimeInput();
                } else {
                    this.previousInput = this.currentInput;
                    this.currentOperationElement.textContent = `${this.currentInput} ${op}`;
                    this.currentInput = '0';
                }
                
                this.operation = op;
                this.waitingForNewInput = true;
                this.lastResult = null;
                
                this.updateDisplay();
            }
            
            calculate() {
                if (!this.operation || this.waitingForNewInput) return;
                
                let prev = this.parseTimeToSeconds(this.previousInput);
                let current;
                
                // Para operaciones de porcentaje, SIEMPRE tratar el valor actual como n√∫mero decimal
                if (this.operation === '%' || this.operation === '%+') {
                    // En operaciones de porcentaje, el valor actual debe ser un n√∫mero, no tiempo
                    if (this.mode === 'time') {
                        // Si estamos en modo tiempo, tomar el n√∫mero actual como valor decimal
                        current = parseFloat(this.currentNumber || this.currentInput);
                        if (isNaN(current)) current = 0;
                    } else {
                        current = parseFloat(this.currentInput);
                    }
                } else {
                    // Para otras operaciones, usar la l√≥gica normal
                    if (this.mode === 'time') {
                        current = this.getTimeInSeconds();
                    } else {
                        current = this.parseTimeToSeconds(this.currentInput);
                    }
                }
                
                let result;
                let operationString = '';
                
                switch (this.operation) {
                    case '+':
                        result = prev + current;
                        operationString = `${this.formatTimeForOperation(this.previousInput)} + ${this.formatTimeForOperation(this.currentInput)}`;
                        break;
                    case '-':
                        result = prev - current;
                        operationString = `${this.formatTimeForOperation(this.previousInput)} - ${this.formatTimeForOperation(this.currentInput)}`;
                        break;
                    case '*':
                        result = prev * current;
                        operationString = `${this.formatTimeForOperation(this.previousInput)} √ó ${this.formatTimeForOperation(this.currentInput)}`;
                        break;
                    case '/':
                        if (current === 0) {
                            alert("Error: Divisi√≥n por cero");
                            return;
                        }
                        result = prev / current;
                        operationString = `${this.formatTimeForOperation(this.previousInput)} √∑ ${this.formatTimeForOperation(this.currentInput)}`;
                        break;
                    case '%':
                        result = prev * (current / 100);
                        operationString = `${this.formatTimeForOperation(this.previousInput)} % ${current}`;
                        break;
                    case '%+':
                        result = prev * (1 + current / 100);
                        operationString = `${this.formatTimeForOperation(this.previousInput)} %+ ${current}`;
                        break;
                    default:
                        return;
                }
                
                // Resto del c√≥digo permanece igual...
                let displayResult;
                let historyResult;
                
                if (this.operationMode === 'time') {
                    displayResult = this.formatTime(result);
                    historyResult = `${operationString} = ${displayResult}`;
                } else {
                    displayResult = result.toString();
                    historyResult = `${operationString} = ${displayResult}`;
                }
                
                this.currentInput = displayResult;
                this.addToHistory(historyResult);
                
                this.lastResult = result;
                this.operation = null;
                this.previousInput = '';
                this.waitingForNewInput = true;
                this.resetTimeInput();
                this.currentOperationElement.textContent = '';
                this.updateDisplay();
            }            
            parseTimeToSeconds(timeStr) {
                if (typeof timeStr === 'number') return timeStr;
                
                // Si es un n√∫mero decimal normal
                if (!isNaN(timeStr)) return parseFloat(timeStr);
                
                // Parsear formato de tiempo (1h 30m 45s)
                let seconds = 0;
                const hoursMatch = timeStr.match(/(\d+)h/);
                const minutesMatch = timeStr.match(/(\d+)m/);
                const secondsMatch = timeStr.match(/(\d+)s/);
                
                if (hoursMatch) seconds += parseInt(hoursMatch[1]) * 3600;
                if (minutesMatch) seconds += parseInt(minutesMatch[1]) * 60;
                if (secondsMatch) seconds += parseInt(secondsMatch[1]);
                
                return seconds;
            }
            
            formatTimeForOperation(value) {
                // Solo formatear como tiempo si estamos en modo tiempo
                if (this.mode === 'time') {
                    // Si el valor ya est√° en formato tiempo, mantenerlo
                    if (isNaN(value)) {
                        return value;
                    }
                    // Si es un n√∫mero (segundos), convertirlo a formato tiempo
                    const numValue = parseFloat(value);
                    return this.formatTime(numValue);
                } else {
                    // En modo decimal, mostrar solo el n√∫mero
                    if (isNaN(value)) {
                        // Si viene en formato tiempo, convertirlo a n√∫mero
                        return this.parseTimeToSeconds(value).toString();
                    }
                    return value;
                }
            }
            
            formatTimeForHistory(value) {
                // Para el historial, mostrar cada elemento con su conversi√≥n a segundos
                if (isNaN(value)) {
                    const seconds = this.parseTimeToSeconds(value);
                    // Asegurar que el tiempo est√© completo (con horas, minutos y segundos)
                    const formattedTime = this.ensureCompleteTimeFormat(value);
                    return `${formattedTime} (${seconds}s)`;
                }
                const numValue = parseFloat(value);
                const formattedTime = this.formatTime(numValue);
                return `${formattedTime} (${Math.round(numValue)}s)`;
            }
            
            // Funci√≥n: Asegurar que el formato de tiempo sea completo
            ensureCompleteTimeFormat(timeStr) {
                if (isNaN(timeStr)) {
                    // Ya est√° en formato tiempo, verificar si est√° completo
                    let hours = 0, minutes = 0, seconds = 0;
                    
                    const hoursMatch = timeStr.match(/(\d+)h/);
                    const minutesMatch = timeStr.match(/(\d+)m/);
                    const secondsMatch = timeStr.match(/(\d+)s/);
                    
                    if (hoursMatch) hours = parseInt(hoursMatch[1]);
                    if (minutesMatch) minutes = parseInt(minutesMatch[1]);
                    if (secondsMatch) seconds = parseInt(secondsMatch[1]);
                    
                    // Reconstruir el formato completo
                    let parts = [];
                    if (hours > 0) parts.push(hours + 'h');
                    if (minutes > 0 || hours > 0) parts.push(minutes.toString().padStart(2, '0') + 'm');
                    parts.push(seconds.toString().padStart(2, '0') + 's');
                    
                    return parts.join(' ');
                } else {
                    // Es un n√∫mero, convertirlo a formato tiempo completo
                    const numValue = parseFloat(timeStr);
                    return this.formatTime(numValue);
                }
            }
            
            handleMemory(memoryOp) {
                switch (memoryOp) {
                    case 'm+':
                        // Sumar a la memoria y preparar para nueva entrada
                        const currentValue = this.parseTimeToSeconds(this.currentInput);
                        this.memory += currentValue;
                        this.memoryMode = this.mode;
                        
                        // A√±adir al historial la operaci√≥n de memoria
                        this.addToHistory(`M+ (${this.formatTimeForOperation(this.currentInput)}) = ${this.formatTime(this.memory)}`);
                        
                        // Preparar para nueva entrada (como una operaci√≥n)
                        this.waitingForNewInput = true;
                        this.currentNumber = '';
                        this.isBuildingTime = false;
                        this.resetTimeInput();
                        this.currentInput = '0';
                        this.lastResult = null;
                        break;
                    case 'mc':
                        this.memory = 0;
                        this.memoryMode = 'decimal';
                        this.addToHistory('MC (Memoria limpiada)');
                        break;
                    case 'mr':
                        // Recuperar formateando seg√∫n el modo actual
                        if (this.mode === 'time') {
                            this.currentInput = this.formatTime(this.memory);
                        } else {
                            this.currentInput = this.memory.toString();
                        }
                        this.waitingForNewInput = true;
                        this.currentNumber = '';
                        this.isBuildingTime = false;
                        this.resetTimeInput();
                        this.lastResult = null;
                        this.addToHistory(`MR = ${this.formatTimeForOperation(this.currentInput)}`);
                        break;
                }
                this.updateDisplay();
            }
            
            handleClear(clearType) {
                if (clearType === 'c') {
                    this.currentInput = '0';
                    this.previousInput = '';
                    this.operation = null;
                    this.currentNumber = '';
                    this.isBuildingTime = false;
                    this.resetTimeInput();
                    this.hourBtn.classList.remove('active');
                    this.minuteBtn.classList.remove('active');
                    this.secondBtn.classList.remove('active');
                    this.decimalBtn.classList.add('active');
                    this.mode = 'decimal';
                    this.displayModeIndicator.textContent = translations[currentLanguage].modeDecimal;
                    this.operationMode = 'decimal';
                    this.lastResult = null;
                    this.currentOperationElement.textContent = '';
                } else if (clearType === 'ce') {
                    this.currentInput = '0';
                    this.currentNumber = '';
                    this.isBuildingTime = false;
                    this.resetTimeInput();
                    this.lastResult = null;
                }
                this.updateDisplay();
            }
            
            formatTime(totalSeconds) {
                let hours = Math.floor(totalSeconds / 3600);
                let minutes = Math.floor((totalSeconds % 3600) / 60);
                let seconds = Math.floor(totalSeconds % 60);
                let milliseconds = Math.round((totalSeconds % 1) * 1000);
                
                let parts = [];
                if (hours > 0) {
                    parts.push(hours + 'h');
                    parts.push(minutes.toString().padStart(2, '0') + 'm');
                    parts.push(seconds.toString().padStart(2, '0') + 's');
                } else if (minutes > 0) {
                    parts.push(minutes + 'm');
                    parts.push(seconds.toString().padStart(2, '0') + 's');
                } else {
                    parts.push(seconds + 's');
                }
                
                if (milliseconds > 0) parts.push(milliseconds.toString().padStart(3, '0') + 'ms');
                
                return parts.join(' ');
            }
            
            addToHistory(operation) {
                this.history.unshift(operation);
                if (this.history.length > 20) this.history.pop();
                this.updateHistoryDisplay();
            }
            
            updateDisplay() {
                this.currentInputElement.textContent = this.currentInput;
                
                // La l√≠nea de operaci√≥n ahora se actualiza directamente en inputOperation()
                // para mostrar inmediatamente la operaci√≥n
            }
            
            updateHistoryDisplay() {
                this.historyElement.innerHTML = '';
                this.history.slice(0, 3).forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.textContent = item;
                    this.historyElement.appendChild(div);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Cargar idioma guardado
            const savedLanguage = localStorage.getItem('timeCalcLanguage');
            if (savedLanguage) {
                currentLanguage = savedLanguage;
            }

            // Actualizar idioma
            updateLanguage(currentLanguage);
            
            // Inicializar calculadora
            new TimeCalculator();
            
            // Inicializar instalador de app
            new AppInstaller();
        });
		// Registrar el Service Worker
        // Registro espec√≠fico para Calculadora
        if ('serviceWorker' in navigator) {
        // Solo registrar para Calculadora_Tiempos
        if (window.location.href.includes('Calculadora_Tiempos')) {
            navigator.serviceWorker.register('/Web/unified-sw.js')
            .then(function(registration) {
                console.log('ServiceWorker Calculadora registrado: ', registration.scope);
            })
            .catch(function(error) {
                console.log('Error al registrar ServiceWorker Calculadora: ', error);
            });
        }
        }
		// Escuchar mensajes del Service Worker
		navigator.serviceWorker.addEventListener('message', event => {
		  if (event.data && event.data.type === 'SW_UPDATED') {
		    console.log('Service Worker actualizado a versi√≥n:', event.data.version);
		    showUpdateNotification();
		  }
		});
		
		// Mostrar notificaci√≥n de actualizaci√≥n
		function showUpdateNotification() {
		  if (confirm('¬°Hay una nueva versi√≥n disponible! ¬øQuieres actualizar ahora?')) {
		    // Forzar la actualizaci√≥n
		    if ('serviceWorker' in navigator) {
		      navigator.serviceWorker.ready.then(registration => {
		        // Enviar mensaje al SW para que se active
		        registration.waiting?.postMessage({ type: 'SKIP_WAITING' });
		        
		        // Recargar la p√°gina despu√©s de un breve delay
		        setTimeout(() => {
		          window.location.reload();
		        }, 500);
		      });
		    } else {
		      window.location.reload();
		    }
		  }
		}
		
		// Verificar actualizaci√≥n al cargar la p√°gina
		window.addEventListener('load', () => {
		  if ('serviceWorker' in navigator) {
		    navigator.serviceWorker.ready.then(registration => {
		      if (registration.waiting) {
		        // Hay una actualizaci√≥n esperando
		        showUpdateNotification();
		      }
		    });
		  }
		});
		// Bot√≥n manual para buscar actualizaciones (opcional)
		function addUpdateButton() {
		  const updateBtn = document.createElement('button');
		  updateBtn.textContent = 'üîÑ Buscar Actualizaciones';
		  updateBtn.style.cssText = `
		    position: fixed;
		    bottom: 10px;
		    right: 10px;
		    z-index: 1000;
		    padding: 8px 12px;
		    background: #3498db;
		    color: white;
		    border: none;
		    border-radius: 5px;
		    cursor: pointer;
		    font-size: 12px;
		  `;
		  updateBtn.onclick = checkForUpdates;
		  document.body.appendChild(updateBtn);
		}
		
		function checkForUpdates() {
		  if ('serviceWorker' in navigator) {
		    navigator.serviceWorker.ready.then(registration => {
		      registration.update().then(() => {
		        alert('B√∫squeda de actualizaciones completada');
		      });
		    });
		  } else {
		    alert('Service Worker no disponible');
		  }
		}


    </script>
</body>
</html>