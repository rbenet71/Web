<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Tiempos - Ciclismo</title>

	<!-- Iconos para la aplicación -->
	<link rel="icon" type="image/png" href="https://rbenet71.github.io/Web/Calculadora_Tiempos_192x192.png">
	<link rel="apple-touch-icon" href="https://rbenet71.github.io/Web/Calculadora_Tiempos_192x192.png">

	<!-- Iconos para PWA -->
	<link rel="icon" type="image/png" sizes="192x192" href="https://rbenet71.github.io/Web/Calculadora_Tiempos_192x192.png">
	<link rel="icon" type="image/png" sizes="512x512" href="https://rbenet71.github.io/Web/Calculadora_Tiempos_192x192.png">
	<link rel="apple-touch-icon" sizes="192x192" href="https://rbenet71.github.io/Web/Calculadora_Tiempos_192x192.png">

	<!-- Configuración para PWA (Progressive Web App) -->
	<meta name="theme-color" content="#2c3e50">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="Crono 80%">
	<meta name="msapplication-TileColor" content="#2c3e50">
	<meta name="msapplication-TileImage" content="https://rbenet71.github.io/Web/Calculadora_Tiempos.png">

	<!-- Manifest para PWA -->
	<link rel="manifest" href="https://rbenet71.github.io/Web/Calculadora_Tiempos_manifest.json">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 12px;
        }
        
        .calculator {
            background-color: #2c3e50;
            border-radius: 10px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 256px; /* Reducido de 320px */
            padding: 16px;
            color: white;
        }
        
        .display {
            background-color: #1a252f;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            color: #fff;
            min-height: 112px; /* Reducido de 140px */
            display: flex;
            flex-direction: column;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.5);
        }
        
        .current-operation {
            font-size: 11px; /* Reducido de 14px */
            min-height: 16px;
            margin-bottom: 10px;
            color: #7f8c8d;
            text-align: right;
        }
        
        .current-input {
            font-size: 21px; /* Reducido de 26px */
            min-height: 26px;
            margin-bottom: 10px;
            text-align: right;
            font-weight: bold;
            color: #ecf0f1;
        }
        
        .history {
            font-size: 10px; /* Reducido de 12px */
            color: #95a5a6;
            height: 48px; /* Reducido de 60px */
            overflow-y: auto;
            border-top: 1px solid #34495e;
            padding-top: 6px;
        }
        
        .history-item {
            margin-bottom: 5px;
            padding-bottom: 5px;
            border-bottom: 1px solid #34495e;
            text-align: right;
        }
        
        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px; /* Reducido de 10px */
            margin-bottom: 8px;
        }
        
        button {
            background-color: #34495e;
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 11px; /* Reducido de 14px */
            padding: 11px 0; /* Reducido de 14px */
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            background-color: #4a6583;
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .unit-btn {
            background-color: #2980b9;
        }
        
        .unit-btn:hover {
            background-color: #3498db;
        }
        
        .unit-btn.active {
            background-color: #1abc9c;
            box-shadow: 0 0 6px #1abc9c;
        }
        
        .memory-btn {
            background-color: #27ae60;
        }
        
        .memory-btn:hover {
            background-color: #2ecc71;
        }
        
        .operation-btn {
            background-color: #e67e22;
        }
        
        .operation-btn:hover {
            background-color: #f39c12;
        }
        
        .equals-btn {
            background-color: #c0392b;
        }
        
        .equals-btn:hover {
            background-color: #e74c3c;
        }
        
        .clear-btn {
            background-color: #8e44ad;
        }
        
        .clear-btn:hover {
            background-color: #9b59b6;
        }
        
        .special-btn {
            background-color: #16a085;
        }
        
        .special-btn:hover {
            background-color: #1abc9c;
        }
        
        .zero-btn {
            grid-column: span 2;
        }
        
        .mode-indicator {
            color: #2ecc71;
            font-size: 10px; /* Reducido de 13px */
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .special-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px; /* Reducido de 10px */
            margin-top: 8px;
        }
        
        .title {
            text-align: center;
            margin-bottom: 12px;
            color: white;
            font-size: 15px; /* Reducido de 19px */
            font-weight: bold;
        }
        
        .history::-webkit-scrollbar {
            width: 5px; /* Reducido de 6px */
        }
        
        .history::-webkit-scrollbar-track {
            background: #34495e;
            border-radius: 2px;
        }
        
        .history::-webkit-scrollbar-thumb {
            background: #7f8c8d;
            border-radius: 2px;
        }
        
        .history::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #2c3e50;
            padding: 16px;
            border-radius: 8px;
            width: 90%;
            max-width: 320px; /* Reducido de 400px */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        
        .modal-title {
            text-align: center;
            margin-bottom: 12px;
            color: white;
            font-size: 14px; /* Reducido de 18px */
        }
        
        .modal-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 12px;
            border-radius: 4px;
            border: 1px solid #34495e;
            background-color: #1a252f;
            color: white;
            font-size: 13px; /* Reducido de 16px */
        }
        
        .modal-buttons {
            display: flex;
            justify-content: space-between;
        }
        
        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }
        
        .modal-cancel {
            background-color: #7f8c8d;
            color: white;
        }
        
        .modal-calculate {
            background-color: #27ae60;
            color: white;
        }
        
        /* Nuevos estilos para el header */
        .calculator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .language-selector {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .flag {
            width: 20px; /* Reducido de 25px */
            height: 14px; /* Reducido de 17px */
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s;
            border: 1px solid #ccc;
        }
        
        .flag.active {
            opacity: 1;
            border: 2px solid #3498db;
        }
        
        .flag-catalunya {
            background: linear-gradient(
                to bottom,
                #ffcd00 0%, #ffcd00 10%,
                #da121a 10%, #da121a 20%,
                #ffcd00 20%, #ffcd00 30%,
                #da121a 30%, #da121a 40%,
                #ffcd00 40%, #ffcd00 50%,
                #da121a 50%, #da121a 60%,
                #ffcd00 60%, #ffcd00 70%,
                #da121a 70%, #da121a 80%,
                #ffcd00 80%, #ffcd00 90%,
                #da121a 90%, #da121a 100%
            );
        }
        
        .help-icon {
            font-size: 1rem; /* Reducido de 1.2rem */
            cursor: pointer;
            color: #3498db;
            margin-left: 4px;
            transition: all 0.3s;
        }
        
        .help-icon:hover {
            transform: scale(1.1);
            color: #2c3e50;
        }
        
        /* Footer */
        .calculator-footer {
            text-align: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #34495e;
            color: #95a5a6;
            font-size: 10px; /* Reducido de 12px */
        }
        
        .calculator-footer a {
            color: #3498db;
            text-decoration: none;
            font-weight: bold;
        }
        
        .calculator-footer a:hover {
            text-decoration: underline;
        }
        
        .visit-counter {
            margin-left: 8px;
            padding: 2px 6px;
            background-color: #3498db;
            color: white;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .btn-help {
            background-color: #3498db;
            color: white;
            padding: 6px 13px; /* Reducido de 8px 16px */
            margin-top: 8px;
            width: 100%;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="calculator">
        <div class="calculator-header">
            <div class="title">Calculadora de Tiempos</div>
            <div class="language-selector">
                <img src="https://flagcdn.com/w40/es.png" class="flag active" id="flag-es" data-lang="es">
                <div class="flag flag-catalunya" id="flag-ca" data-lang="ca"></div>
                <img src="https://flagcdn.com/w40/gb.png" class="flag" id="flag-en" data-lang="en">
                <span class="help-icon" id="help-icon-header" title="Ayuda">❓</span>
            </div>
        </div>
        
        <div class="display">
            <div class="current-operation" id="currentOperation"></div>
            <div class="current-input" id="currentInput">0</div>
            <div class="history" id="history"></div>
        </div>
        
        <div class="buttons">
            <button class="unit-btn" id="hourBtn" data-unit="hour">Hora</button>
            <button class="unit-btn" id="minuteBtn" data-unit="minute">Minuto</button>
            <button class="unit-btn" id="secondBtn" data-unit="second">Segundo</button>
            <button class="unit-btn active" id="decimalBtn" data-unit="decimal">Decimal</button>
            
            <button class="memory-btn" data-memory="m+">M+</button>
            <button class="memory-btn" data-memory="mc">Mc</button>
            <button class="memory-btn" data-memory="mr">Mr</button>
            <button class="operation-btn" data-operation="%">%</button>
            
            <button class="clear-btn" data-clear="c">C</button>
            <button class="clear-btn" data-clear="ce">CE</button>
            <button class="operation-btn" data-operation="*">×</button>
            <button class="operation-btn" data-operation="/">÷</button>
            
            <button data-number="7">7</button>
            <button data-number="8">8</button>
            <button data-number="9">9</button>
            <button class="operation-btn" data-operation="%+">%+</button>
            
            <button data-number="4">4</button>
            <button data-number="5">5</button>
            <button data-number="6">6</button>
            <button class="operation-btn" data-operation="-">-</button>
            
            <button data-number="1">1</button>
            <button data-number="2">2</button>
            <button data-number="3">3</button>
            <button class="operation-btn" data-operation="+">+</button>
            
            <button class="zero-btn" data-number="0">0</button>
            <button data-decimal>.</button>
            <button class="equals-btn" data-equals>=</button>
        </div>
        
        <div class="mode-indicator" id="modeIndicator">Modo: Decimal</div>
        
        <div class="special-buttons">
            <button class="special-btn" id="averageBtn">Cálculo Promedio</button>
            <button class="special-btn" id="lapsBtn">Número de Vueltas</button>
        </div>
        
        <button class="btn-help" id="btn-help">Ayuda</button>
        
        <div class="calculator-footer">
            <p>
                2025 Copyright 
                <a href="https://rbenet71.github.io/Web/" target="_blank">
                    Roberto Benet - rbenet71@gmail.com
                </a>
                <span class="visit-counter" id="visit-counter">0 visitas</span>
            </p>
        </div>
    </div>

    <!-- Modal para Cálculo de Promedio -->
    <div class="modal" id="averageModal">
        <div class="modal-content">
            <div class="modal-title">Cálculo de Promedio (km/h)</div>
            <input type="number" class="modal-input" id="distanceInput" placeholder="Distancia en km" step="0.1">
            <input type="text" class="modal-input" id="timeInput" placeholder="Tiempo (ej: 1h 30m 45s)">
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="cancelAverage">Cancelar</button>
                <button class="modal-btn modal-calculate" id="calculateAverage">Calcular</button>
            </div>
        </div>
    </div>

    <!-- Modal para Cálculo de Vueltas -->
    <div class="modal" id="lapsModal">
        <div class="modal-content">
            <div class="modal-title">Cálculo de Número de Vueltas</div>
            <input type="text" class="modal-input" id="lapTimeInput" placeholder="Tiempo por vuelta (ej: 5m 30s)">
            <input type="text" class="modal-input" id="targetTimeInput" placeholder="Tiempo objetivo (ej: 1h 30m)">
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="cancelLaps">Cancelar</button>
                <button class="modal-btn modal-calculate" id="calculateLaps">Calcular</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales para el sistema de idiomas
        let currentLanguage = 'es';
        
        // Textos en diferentes idiomas
        const translations = {
            es: {
                appTitle: "Calculadora de Tiempos",
                modeDecimal: "Modo: Decimal",
                modeTime: "Modo: Tiempo",
                averageCalc: "Cálculo Promedio",
                lapsCalc: "Número de Vueltas",
                helpButton: "Ayuda",
                averageModalTitle: "Cálculo de Promedio (km/h)",
                distancePlaceholder: "Distancia en km",
                timePlaceholder: "Tiempo (ej: 1h 30m 45s)",
                lapsModalTitle: "Cálculo de Número de Vueltas",
                lapTimePlaceholder: "Tiempo por vuelta (ej: 5m 30s)",
                targetTimePlaceholder: "Tiempo objetivo (ej: 1h 30m)",
                cancelButton: "Cancelar",
                calculateButton: "Calcular",
                hourButton: "Hora",
                minuteButton: "Minuto",
                secondButton: "Segundo",
                decimalButton: "Decimal",
                copyright: "2025 Copyright",
                copyrightLink: "Roberto Benet - rbenet71@gmail.com",
                visits: "visitas"
            },
            ca: {
                appTitle: "Calculadora de Temps",
                modeDecimal: "Mode: Decimal",
                modeTime: "Mode: Temps",
                averageCalc: "Càlcul Promig",
                lapsCalc: "Nombre de Voltes",
                helpButton: "Ajuda",
                averageModalTitle: "Càlcul de Promig (km/h)",
                distancePlaceholder: "Distància en km",
                timePlaceholder: "Temps (ex: 1h 30m 45s)",
                lapsModalTitle: "Càlcul de Nombre de Voltes",
                lapTimePlaceholder: "Temps per volta (ex: 5m 30s)",
                targetTimePlaceholder: "Temps objectiu (ex: 1h 30m)",
                cancelButton: "Cancel·lar",
                calculateButton: "Calcular",
                hourButton: "Hora",
                minuteButton: "Minut",
                secondButton: "Segon",
                decimalButton: "Decimal",
                copyright: "2025 Copyright",
                copyrightLink: "Roberto Benet - rbenet71@gmail.com",
                visits: "visites"
            },
            en: {
                appTitle: "Time Calculator",
                modeDecimal: "Mode: Decimal",
                modeTime: "Mode: Time",
                averageCalc: "Average Calculation",
                lapsCalc: "Number of Laps",
                helpButton: "Help",
                averageModalTitle: "Average Calculation (km/h)",
                distancePlaceholder: "Distance in km",
                timePlaceholder: "Time (ex: 1h 30m 45s)",
                lapsModalTitle: "Number of Laps Calculation",
                lapTimePlaceholder: "Time per lap (ex: 5m 30s)",
                targetTimePlaceholder: "Target time (ex: 1h 30m)",
                cancelButton: "Cancel",
                calculateButton: "Calculate",
                hourButton: "Hour",
                minuteButton: "Minute",
                secondButton: "Second",
                decimalButton: "Decimal",
                copyright: "2025 Copyright",
                copyrightLink: "Roberto Benet - rbenet71@gmail.com",
                visits: "visits"
            }
        };

        // Función para actualizar idioma
        function updateLanguage(lang) {
            currentLanguage = lang;
            
            // Actualizar textos
            document.querySelector('.title').textContent = translations[lang].appTitle;
            document.getElementById('modeIndicator').textContent = translations[lang].modeDecimal;
            document.getElementById('averageBtn').textContent = translations[lang].averageCalc;
            document.getElementById('lapsBtn').textContent = translations[lang].lapsCalc;
            document.getElementById('btn-help').textContent = translations[lang].helpButton;
            
            // Actualizar textos de modales
            document.querySelector('#averageModal .modal-title').textContent = translations[lang].averageModalTitle;
            document.getElementById('distanceInput').placeholder = translations[lang].distancePlaceholder;
            document.getElementById('timeInput').placeholder = translations[lang].timePlaceholder;
            document.getElementById('cancelAverage').textContent = translations[lang].cancelButton;
            document.getElementById('calculateAverage').textContent = translations[lang].calculateButton;
            
            document.querySelector('#lapsModal .modal-title').textContent = translations[lang].lapsModalTitle;
            document.getElementById('lapTimeInput').placeholder = translations[lang].lapTimePlaceholder;
            document.getElementById('targetTimeInput').placeholder = translations[lang].targetTimePlaceholder;
            document.getElementById('cancelLaps').textContent = translations[lang].cancelButton;
            document.getElementById('calculateLaps').textContent = translations[lang].calculateButton;
            
            // Actualizar botones de unidad
            document.getElementById('hourBtn').textContent = translations[lang].hourButton;
            document.getElementById('minuteBtn').textContent = translations[lang].minuteButton;
            document.getElementById('secondBtn').textContent = translations[lang].secondButton;
            document.getElementById('decimalBtn').textContent = translations[lang].decimalButton;
            
            // Actualizar footer
            document.querySelector('.calculator-footer p').innerHTML = 
                translations[lang].copyright + 
                ' <a href="https://rbenet71.github.io/Web/" target="_blank">' +
                translations[lang].copyrightLink + 
                '</a> <span class="visit-counter" id="visit-counter">' + 
                getVisitCount() + ' ' + translations[lang].visits + '</span>';
            
            // Actualizar banderas activas
            document.querySelectorAll('.flag').forEach(flag => {
                flag.classList.remove('active');
            });
            document.getElementById('flag-' + lang).classList.add('active');
        }
        
        // Función para abrir el archivo de ayuda
        function openHelpFile() {
            window.open('https://rbenet71.github.io/Web/Calculadora_Tiempos_Ayuda.html', '_blank');
        }
        
        // Función para el contador de visitas
        function updateVisitCounter() {
            const today = new Date().toDateString();
            const lastVisit = localStorage.getItem('timeCalcLastVisit');
            let visitCount = parseInt(localStorage.getItem('timeCalcVisitCount')) || 0;
            
            // Solo contar una visita por día por usuario
            if (lastVisit !== today) {
                visitCount++;
                localStorage.setItem('timeCalcVisitCount', visitCount);
                localStorage.setItem('timeCalcLastVisit', today);
            }
            
            return visitCount;
        }
        
        function getVisitCount() {
            return parseInt(localStorage.getItem('timeCalcVisitCount')) || 0;
        }

        class TimeCalculator {
            constructor() {
                this.currentInput = '0';
                this.previousInput = '';
                this.operation = null;
                this.mode = 'decimal';
                this.memory = 0;
                this.memoryMode = 'decimal';
                this.history = [];
                this.waitingForNewInput = false;
                
                // Variables para modo tiempo
                this.timeInput = {
                    hours: 0,
                    minutes: 0,
                    seconds: 0
                };
                this.currentNumber = '';
                this.isBuildingTime = false;
                this.operationMode = 'decimal';
                this.lastResult = null;
                
                // Modales
                this.averageModal = document.getElementById('averageModal');
                this.lapsModal = document.getElementById('lapsModal');
                
                this.initializeElements();
                this.attachEventListeners();
                this.updateDisplay();
            }
            
            initializeElements() {
                this.currentInputElement = document.getElementById('currentInput');
                this.currentOperationElement = document.getElementById('currentOperation');
                this.historyElement = document.getElementById('history');
                this.modeIndicatorElement = document.getElementById('modeIndicator');
                this.hourBtn = document.getElementById('hourBtn');
                this.minuteBtn = document.getElementById('minuteBtn');
                this.secondBtn = document.getElementById('secondBtn');
                this.decimalBtn = document.getElementById('decimalBtn');
            }
            
            attachEventListeners() {
                document.querySelectorAll('[data-number]').forEach(button => {
                    button.addEventListener('click', () => {
                        this.inputNumber(button.getAttribute('data-number'));
                    });
                });
                
                document.querySelector('[data-decimal]').addEventListener('click', () => {
                    this.inputDecimal();
                });
                
                document.querySelectorAll('[data-operation]').forEach(button => {
                    button.addEventListener('click', () => {
                        this.inputOperation(button.getAttribute('data-operation'));
                    });
                });
                
                document.querySelector('[data-equals]').addEventListener('click', () => {
                    this.calculate();
                });
                
                document.querySelectorAll('[data-memory]').forEach(button => {
                    button.addEventListener('click', () => {
                        this.handleMemory(button.getAttribute('data-memory'));
                    });
                });
                
                document.querySelectorAll('[data-unit]').forEach(button => {
                    button.addEventListener('click', () => {
                        this.setUnit(button.getAttribute('data-unit'));
                    });
                });
                
                document.querySelectorAll('[data-clear]').forEach(button => {
                    button.addEventListener('click', () => {
                        this.handleClear(button.getAttribute('data-clear'));
                    });
                });
                
                // Eventos para botones especiales
                document.getElementById('averageBtn').addEventListener('click', () => {
                    this.showAverageModal();
                });
                
                document.getElementById('lapsBtn').addEventListener('click', () => {
                    this.showLapsModal();
                });
                
                // Eventos para modales
                document.getElementById('cancelAverage').addEventListener('click', () => {
                    this.hideAverageModal();
                });
                
                document.getElementById('calculateAverage').addEventListener('click', () => {
                    this.calculateAverage();
                });
                
                document.getElementById('cancelLaps').addEventListener('click', () => {
                    this.hideLapsModal();
                });
                
                document.getElementById('calculateLaps').addEventListener('click', () => {
                    this.calculateLaps();
                });
                
                // Eventos para ayuda
                document.getElementById('btn-help').addEventListener('click', openHelpFile);
                document.getElementById('help-icon-header').addEventListener('click', openHelpFile);
                
                // Eventos para cambio de idioma
                document.querySelectorAll('.flag').forEach(flag => {
                    flag.addEventListener('click', function() {
                        const lang = this.getAttribute('data-lang');
                        updateLanguage(lang);
                        // Guardar idioma seleccionado
                        localStorage.setItem('timeCalcLanguage', lang);
                    });
                });
                
                // Cerrar modales al hacer clic fuera
                window.addEventListener('click', (e) => {
                    if (e.target === this.averageModal) {
                        this.hideAverageModal();
                    }
                    if (e.target === this.lapsModal) {
                        this.hideLapsModal();
                    }
                });
            }
            
            showAverageModal() {
                document.getElementById('distanceInput').value = '';
                document.getElementById('timeInput').value = '';
                this.averageModal.style.display = 'flex';
            }
            
            hideAverageModal() {
                this.averageModal.style.display = 'none';
            }
            
            showLapsModal() {
                document.getElementById('lapTimeInput').value = '';
                document.getElementById('targetTimeInput').value = '';
                this.lapsModal.style.display = 'flex';
            }
            
            hideLapsModal() {
                this.lapsModal.style.display = 'none';
            }
            
            calculateAverage() {
                const distance = parseFloat(document.getElementById('distanceInput').value);
                const timeStr = document.getElementById('timeInput').value;
                
                if (!distance || !timeStr) {
                    alert('Por favor, complete todos los campos');
                    return;
                }
                
                const timeInSeconds = this.parseTimeToSeconds(timeStr);
                const timeInHours = timeInSeconds / 3600;
                const average = distance / timeInHours;
                
                this.addToHistory(`Promedio: ${distance}km / ${this.formatTime(timeInSeconds)} = ${average.toFixed(2)} km/h`);
                this.currentInput = average.toFixed(2);
                this.waitingForNewInput = true;
                this.updateDisplay();
                this.hideAverageModal();
            }
            
            calculateLaps() {
                const lapTimeStr = document.getElementById('lapTimeInput').value;
                const targetTimeStr = document.getElementById('targetTimeInput').value;
                
                if (!lapTimeStr || !targetTimeStr) {
                    alert('Por favor, complete todos los campos');
                    return;
                }
                
                const lapTimeInSeconds = this.parseTimeToSeconds(lapTimeStr);
                const targetTimeInSeconds = this.parseTimeToSeconds(targetTimeStr);
                
                if (lapTimeInSeconds === 0) {
                    alert('El tiempo por vuelta no puede ser cero');
                    return;
                }
                
                const exactLaps = targetTimeInSeconds / lapTimeInSeconds;
                let roundedLaps = Math.floor(exactLaps);
                
                // Si la parte decimal es mayor o igual a 0.5, redondear hacia arriba
                if (exactLaps - roundedLaps >= 0.5) {
                    roundedLaps = Math.ceil(exactLaps);
                }
                
                this.addToHistory(`Vueltas: ${this.formatTime(targetTimeInSeconds)} / ${this.formatTime(lapTimeInSeconds)} = ${roundedLaps} vueltas`);
                this.currentInput = roundedLaps.toString();
                this.waitingForNewInput = true;
                this.updateDisplay();
                this.hideLapsModal();
            }
            
            inputNumber(number) {
                if (this.mode === 'decimal') {
                    if (this.waitingForNewInput) {
                        this.currentInput = number;
                        this.waitingForNewInput = false;
                        this.lastResult = null;
                    } else {
                        this.currentInput = this.currentInput === '0' ? number : this.currentInput + number;
                    }
                } else {
                    // Modo tiempo - acumular números pero mantener el display del tiempo completo
                    if (!this.isBuildingTime || this.waitingForNewInput) {
                        this.currentNumber = '';
                        this.isBuildingTime = true;
                        this.waitingForNewInput = false;
                        this.lastResult = null;
                    }
                    this.currentNumber += number;
                    
                    // Mostrar el tiempo completo + el número que se está introduciendo (sin el signo +)
                    const timeDisplay = this.formatTimeInput();
                    if (timeDisplay !== '0') {
                        this.currentInput = timeDisplay + ' ' + this.currentNumber;
                    } else {
                        this.currentInput = this.currentNumber;
                    }
                }
                this.updateDisplay();
            }
            
            setUnit(unit) {
                // Actualizar botones activos
                this.hourBtn.classList.remove('active');
                this.minuteBtn.classList.remove('active');
                this.secondBtn.classList.remove('active');
                this.decimalBtn.classList.remove('active');
                
                if (unit === 'decimal') {
                    this.mode = 'decimal';
                    this.modeIndicatorElement.textContent = translations[currentLanguage].modeDecimal;
                    this.decimalBtn.classList.add('active');
                    this.currentInput = '0';
                    this.currentNumber = '';
                    this.isBuildingTime = false;
                    this.resetTimeInput();
                } else {
                    this.mode = 'time';
                    this.modeIndicatorElement.textContent = translations[currentLanguage].modeTime;
                    
                    // Activar el botón correspondiente
                    document.getElementById(unit + 'Btn').classList.add('active');
                    
                    // SIEMPRE asignar el número actual a la unidad, incluso si estamos empezando
                    if (this.currentNumber && this.currentNumber !== '0') {
                        const value = parseInt(this.currentNumber);
                        
                        if (unit === 'hour') {
                            this.timeInput.hours = value;
                        } else if (unit === 'minute') {
                            this.timeInput.minutes = value;
                        } else if (unit === 'second') {
                            this.timeInput.seconds = value;
                        }
                        
                        this.currentNumber = '';
                        this.isBuildingTime = false;
                    } else if (this.currentInput !== '0' && !isNaN(this.currentInput)) {
                        // Si currentInput tiene un número válido (no es '0' y no es NaN)
                        const value = parseInt(this.currentInput);
                        
                        if (unit === 'hour') {
                            this.timeInput.hours = value;
                        } else if (unit === 'minute') {
                            this.timeInput.minutes = value;
                        } else if (unit === 'second') {
                            this.timeInput.seconds = value;
                        }
                    }
                    
                    // Mostrar el tiempo actual
                    this.currentInput = this.formatTimeInput();
                }
                this.updateDisplay();
            }
            
            formatTimeInput() {
                let parts = [];
                if (this.timeInput.hours > 0) parts.push(this.timeInput.hours + 'h');
                if (this.timeInput.minutes > 0) parts.push(this.timeInput.minutes + 'm');
                if (this.timeInput.seconds > 0) parts.push(this.timeInput.seconds + 's');
                
                return parts.length > 0 ? parts.join(' ') : '0';
            }
            
            getTimeInSeconds() {
                return this.timeInput.hours * 3600 + 
                       this.timeInput.minutes * 60 + 
                       this.timeInput.seconds;
            }
            
            resetTimeInput() {
                this.timeInput = { hours: 0, minutes: 0, seconds: 0 };
            }
            
            inputDecimal() {
                if (this.mode === 'decimal') {
                    if (this.waitingForNewInput) {
                        this.currentInput = '0.';
                        this.waitingForNewInput = false;
                        this.lastResult = null;
                    } else if (this.currentInput.indexOf('.') === -1) {
                        this.currentInput += '.';
                    }
                }
                this.updateDisplay();
            }
            
            inputOperation(op) {
                // Si hay un último resultado y estamos empezando nueva operación, usarlo
                if (this.lastResult && this.waitingForNewInput && !this.operation) {
                    this.previousInput = this.lastResult.toString();
                    this.currentInput = this.lastResult.toString();
                }
                
                if (this.operation && !this.waitingForNewInput) {
                    this.calculate();
                }
                
                // Guardar el modo actual al iniciar la operación
                this.operationMode = this.mode;
                
                // Limpiar la línea de entrada actual después de pulsar una operación
                if (this.mode === 'time') {
                    const seconds = this.getTimeInSeconds();
                    this.previousInput = seconds.toString(); // Guardar en segundos para cálculo
                    // Mostrar el tiempo formateado en la línea de operación
                    const displayTime = this.formatTimeInput();
                    this.currentOperationElement.textContent = `${displayTime} ${op}`;
                    // Limpiar la línea de entrada actual
                    this.currentInput = '0';
                    this.resetTimeInput();
                } else {
                    this.previousInput = this.currentInput;
                    this.currentOperationElement.textContent = `${this.currentInput} ${op}`;
                    this.currentInput = '0';
                }
                
                this.operation = op;
                this.waitingForNewInput = true;
                this.lastResult = null;
                
                this.updateDisplay();
            }
            
            calculate() {
                if (!this.operation || this.waitingForNewInput) return;
                
                let prev = this.parseTimeToSeconds(this.previousInput);
                let current;
                
                // Para operaciones de porcentaje, SIEMPRE tratar el valor actual como número decimal
                if (this.operation === '%' || this.operation === '%+') {
                    // En operaciones de porcentaje, el valor actual debe ser un número, no tiempo
                    if (this.mode === 'time') {
                        // Si estamos en modo tiempo, tomar el número actual como valor decimal
                        current = parseFloat(this.currentNumber || this.currentInput);
                        if (isNaN(current)) current = 0;
                    } else {
                        current = parseFloat(this.currentInput);
                    }
                } else {
                    // Para otras operaciones, usar la lógica normal
                    if (this.mode === 'time') {
                        current = this.getTimeInSeconds();
                    } else {
                        current = this.parseTimeToSeconds(this.currentInput);
                    }
                }
                
                let result;
                let operationString = '';
                
                switch (this.operation) {
                    case '+':
                        result = prev + current;
                        operationString = `${this.formatTimeForOperation(this.previousInput)} + ${this.formatTimeForOperation(this.currentInput)}`;
                        break;
                    case '-':
                        result = prev - current;
                        operationString = `${this.formatTimeForOperation(this.previousInput)} - ${this.formatTimeForOperation(this.currentInput)}`;
                        break;
                    case '*':
                        result = prev * current;
                        operationString = `${this.formatTimeForOperation(this.previousInput)} × ${this.formatTimeForOperation(this.currentInput)}`;
                        break;
                    case '/':
                        if (current === 0) {
                            alert("Error: División por cero");
                            return;
                        }
                        result = prev / current;
                        operationString = `${this.formatTimeForOperation(this.previousInput)} ÷ ${this.formatTimeForOperation(this.currentInput)}`;
                        break;
                    case '%':
                        result = prev * (current / 100);
                        operationString = `${this.formatTimeForOperation(this.previousInput)} % ${current}`;
                        break;
                    case '%+':
                        result = prev * (1 + current / 100);
                        operationString = `${this.formatTimeForOperation(this.previousInput)} %+ ${current}`;
                        break;
                    default:
                        return;
                }
                
                // Resto del código permanece igual...
                let displayResult;
                let historyResult;
                
                if (this.operationMode === 'time') {
                    displayResult = this.formatTime(result);
                    historyResult = `${operationString} = ${displayResult}`;
                } else {
                    displayResult = result.toString();
                    historyResult = `${operationString} = ${displayResult}`;
                }
                
                this.currentInput = displayResult;
                this.addToHistory(historyResult);
                
                this.lastResult = result;
                this.operation = null;
                this.previousInput = '';
                this.waitingForNewInput = true;
                this.resetTimeInput();
                this.currentOperationElement.textContent = '';
                this.updateDisplay();
            }            
            parseTimeToSeconds(timeStr) {
                if (typeof timeStr === 'number') return timeStr;
                
                // Si es un número decimal normal
                if (!isNaN(timeStr)) return parseFloat(timeStr);
                
                // Parsear formato de tiempo (1h 30m 45s)
                let seconds = 0;
                const hoursMatch = timeStr.match(/(\d+)h/);
                const minutesMatch = timeStr.match(/(\d+)m/);
                const secondsMatch = timeStr.match(/(\d+)s/);
                
                if (hoursMatch) seconds += parseInt(hoursMatch[1]) * 3600;
                if (minutesMatch) seconds += parseInt(minutesMatch[1]) * 60;
                if (secondsMatch) seconds += parseInt(secondsMatch[1]);
                
                return seconds;
            }
            
            formatTimeForOperation(value) {
                // Solo formatear como tiempo si estamos en modo tiempo
                if (this.mode === 'time') {
                    // Si el valor ya está en formato tiempo, mantenerlo
                    if (isNaN(value)) {
                        return value;
                    }
                    // Si es un número (segundos), convertirlo a formato tiempo
                    const numValue = parseFloat(value);
                    return this.formatTime(numValue);
                } else {
                    // En modo decimal, mostrar solo el número
                    if (isNaN(value)) {
                        // Si viene en formato tiempo, convertirlo a número
                        return this.parseTimeToSeconds(value).toString();
                    }
                    return value;
                }
            }
            
            formatTimeForHistory(value) {
                // Para el historial, mostrar cada elemento con su conversión a segundos
                if (isNaN(value)) {
                    const seconds = this.parseTimeToSeconds(value);
                    // Asegurar que el tiempo esté completo (con horas, minutos y segundos)
                    const formattedTime = this.ensureCompleteTimeFormat(value);
                    return `${formattedTime} (${seconds}s)`;
                }
                const numValue = parseFloat(value);
                const formattedTime = this.formatTime(numValue);
                return `${formattedTime} (${Math.round(numValue)}s)`;
            }
            
            // Función: Asegurar que el formato de tiempo sea completo
            ensureCompleteTimeFormat(timeStr) {
                if (isNaN(timeStr)) {
                    // Ya está en formato tiempo, verificar si está completo
                    let hours = 0, minutes = 0, seconds = 0;
                    
                    const hoursMatch = timeStr.match(/(\d+)h/);
                    const minutesMatch = timeStr.match(/(\d+)m/);
                    const secondsMatch = timeStr.match(/(\d+)s/);
                    
                    if (hoursMatch) hours = parseInt(hoursMatch[1]);
                    if (minutesMatch) minutes = parseInt(minutesMatch[1]);
                    if (secondsMatch) seconds = parseInt(secondsMatch[1]);
                    
                    // Reconstruir el formato completo
                    let parts = [];
                    if (hours > 0) parts.push(hours + 'h');
                    if (minutes > 0 || hours > 0) parts.push(minutes.toString().padStart(2, '0') + 'm');
                    parts.push(seconds.toString().padStart(2, '0') + 's');
                    
                    return parts.join(' ');
                } else {
                    // Es un número, convertirlo a formato tiempo completo
                    const numValue = parseFloat(timeStr);
                    return this.formatTime(numValue);
                }
            }
            
            handleMemory(memoryOp) {
                switch (memoryOp) {
                    case 'm+':
                        // Sumar a la memoria y preparar para nueva entrada
                        const currentValue = this.parseTimeToSeconds(this.currentInput);
                        this.memory += currentValue;
                        this.memoryMode = this.mode;
                        
                        // Añadir al historial la operación de memoria
                        this.addToHistory(`M+ (${this.formatTimeForOperation(this.currentInput)}) = ${this.formatTime(this.memory)}`);
                        
                        // Preparar para nueva entrada (como una operación)
                        this.waitingForNewInput = true;
                        this.currentNumber = '';
                        this.isBuildingTime = false;
                        this.resetTimeInput();
                        this.currentInput = '0';
                        this.lastResult = null;
                        break;
                    case 'mc':
                        this.memory = 0;
                        this.memoryMode = 'decimal';
                        this.addToHistory('MC (Memoria limpiada)');
                        break;
                    case 'mr':
                        // Recuperar formateando según el modo actual
                        if (this.mode === 'time') {
                            this.currentInput = this.formatTime(this.memory);
                        } else {
                            this.currentInput = this.memory.toString();
                        }
                        this.waitingForNewInput = true;
                        this.currentNumber = '';
                        this.isBuildingTime = false;
                        this.resetTimeInput();
                        this.lastResult = null;
                        this.addToHistory(`MR = ${this.formatTimeForOperation(this.currentInput)}`);
                        break;
                }
                this.updateDisplay();
            }
            
            handleClear(clearType) {
                if (clearType === 'c') {
                    this.currentInput = '0';
                    this.previousInput = '';
                    this.operation = null;
                    this.currentNumber = '';
                    this.isBuildingTime = false;
                    this.resetTimeInput();
                    this.hourBtn.classList.remove('active');
                    this.minuteBtn.classList.remove('active');
                    this.secondBtn.classList.remove('active');
                    this.decimalBtn.classList.add('active');
                    this.mode = 'decimal';
                    this.modeIndicatorElement.textContent = translations[currentLanguage].modeDecimal;
                    this.operationMode = 'decimal';
                    this.lastResult = null;
                    this.currentOperationElement.textContent = '';
                } else if (clearType === 'ce') {
                    this.currentInput = '0';
                    this.currentNumber = '';
                    this.isBuildingTime = false;
                    this.resetTimeInput();
                    this.lastResult = null;
                }
                this.updateDisplay();
            }
            
            formatTime(totalSeconds) {
                let hours = Math.floor(totalSeconds / 3600);
                let minutes = Math.floor((totalSeconds % 3600) / 60);
                let seconds = Math.floor(totalSeconds % 60);
                let milliseconds = Math.round((totalSeconds % 1) * 1000);
                
                let parts = [];
                if (hours > 0) {
                    parts.push(hours + 'h');
                    parts.push(minutes.toString().padStart(2, '0') + 'm');
                    parts.push(seconds.toString().padStart(2, '0') + 's');
                } else if (minutes > 0) {
                    parts.push(minutes + 'm');
                    parts.push(seconds.toString().padStart(2, '0') + 's');
                } else {
                    parts.push(seconds + 's');
                }
                
                if (milliseconds > 0) parts.push(milliseconds.toString().padStart(3, '0') + 'ms');
                
                return parts.join(' ');
            }
            
            addToHistory(operation) {
                this.history.unshift(operation);
                if (this.history.length > 20) this.history.pop();
                this.updateHistoryDisplay();
            }
            
            updateDisplay() {
                this.currentInputElement.textContent = this.currentInput;
                
                // La línea de operación ahora se actualiza directamente en inputOperation()
                // para mostrar inmediatamente la operación
            }
            
            updateHistoryDisplay() {
                this.historyElement.innerHTML = '';
                this.history.slice(0, 3).forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.textContent = item;
                    this.historyElement.appendChild(div);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Cargar idioma guardado
            const savedLanguage = localStorage.getItem('timeCalcLanguage');
            if (savedLanguage) {
                currentLanguage = savedLanguage;
            }
            
            // Inicializar contador de visitas
            updateVisitCounter();
            
            // Actualizar idioma
            updateLanguage(currentLanguage);
            
            // Inicializar calculadora
            new TimeCalculator();
        });
    </script>
</body>
</html>