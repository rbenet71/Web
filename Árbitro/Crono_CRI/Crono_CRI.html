<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Crono CRI - Control de Salidas para Carreras</title>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CV925PMBQV"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-CV925PMBQV');
    </script>

    <!-- Iconos -->
    <link rel="icon" type="image/png" href="https://rbenet71.github.io/Web/Árbitro/Crono_CRI/Crono_CRI_192x192.png">
    <link rel="apple-touch-icon" href="https://rbenet71.github.io/Web/Árbitro/Crono_CRI/Crono_CRI_192x192.png">
    
    <!-- PWA -->
    <meta name="theme-color" content="#FF0000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Crono CRI">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="Crono_CRI.css">
    <style>

    </style>
</head>
<body>
    <!-- =========================================== -->
    <!-- HEADER -->
    <!-- =========================================== -->
    <header class="app-header hide-on-countdown">
        <div class="container">
            <div class="header-content">
                <div class="app-title">
                    <img src="https://rbenet71.github.io/Web/Árbitro/Crono_CRI/Crono_CRI_192x192.png" 
                         alt="Logo Crono CRI" 
                         class="app-logo">
                    <h1 id="app-title-text">Crono CRI</h1>
                </div>
                <div class="header-controls">
                    <div class="language-selector">
                        <div class="languages-label" id="languages-label">Idioma / Language</div>
                        <img src="https://flagcdn.com/w40/es.png" class="flag active" id="flag-es" data-lang="es">
                        <div class="flag flag-catalunya" id="flag-ca" data-lang="ca"></div>
                        <img src="https://flagcdn.com/w40/gb.png" class="flag" id="flag-en" data-lang="en">
                        <img src="https://flagcdn.com/w40/fr.png" class="flag" id="flag-fr" data-lang="fr">
                        <i class="fas fa-question-circle help-icon" id="help-icon-header" title="Ayuda"></i>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- =========================================== -->
    <!-- CONTENIDO PRINCIPAL - CONFIGURACIÓN -->
    <!-- =========================================== -->
    <main class="main-content hide-on-countdown">
        <div class="container">
            
            <!-- Tarjeta 1: Gestión de carrera -->
            <div class="app-card race-management-card">
                <div class="card-header">
                    <h2><i class="fas fa-flag-checkered"></i> <span id="card-race-title">Gestión de Carrera</span></h2>
                    <div class="card-header-controls">
                        <button class="card-toggle-btn" data-target="race-management-card" title="Minimizar/Expandir">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                        <span class="card-collapse-indicator"><i class="fas fa-chevron-down"></i></span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="race-selector">
                        <select id="race-select" class="form-control">
                            <option value="">-- Selecciona una carrera --</option>
                        </select>
                        <button class="btn btn-primary responsive-btn race-action-btn" id="new-race-btn">
                            <i class="fas fa-plus"></i>
                            <span class="race-btn-text" id="new-race-text">Nueva</span>
                        </button>
                        <button class="btn btn-danger responsive-btn race-action-btn" id="delete-race-btn">
                            <i class="fas fa-trash"></i>
                            <span class="race-btn-text" id="delete-race-text">Eliminar</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- =========================================== -->
            <!-- SELECTOR DE MODO DE OPERACIÓN -->
            <!-- =========================================== -->
            <div class="app-card mode-selector-simple-card">
                <div class="card-header">
                    <h2><i class="fas fa-cogs"></i> <span id="mode-selector-title">Modo de Operación</span></h2>
                    <div class="card-header-controls">
                        <button class="card-toggle-btn" data-target="mode-selector-simple-card" title="Minimizar/Expandir">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                        <span class="card-collapse-indicator"><i class="fas fa-chevron-down"></i></span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mode-slider-container">
                        <div class="mode-slider">
                            <div class="mode-slider-option active" data-mode="salida">
                                <span id="mode-salida-text">SALIDAS</span>
                            </div>
                            <div class="mode-slider-option" data-mode="llegadas">
                                <span id="mode-llegadas-text">LLEGADAS</span>
                            </div>
                            <div class="mode-slider-track"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =========================================== -->
            <!-- NUEVA TARJETA: GESTIÓN DEL ORDEN DE SALIDA -->
            <!-- =========================================== -->
            <div class="app-card start-order-card">
                <div class="card-header">
                    <h2><i class="fas fa-list-ol"></i> <span id="card-start-order-title">Orden de Salida</span></h2>
                    <div class="card-header-controls">
                        <button class="card-toggle-btn" data-target="start-order-card" title="Minimizar/Expandir">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                        <span class="card-collapse-indicator"><i class="fas fa-chevron-down"></i></span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Bloque 1 - Configuración de horarios -->
                    <div class="config-section">
                        <div class="time-config-grid">
                            <div class="time-config-item">
                                <label for="first-start-time" class="form-label" id="first-start-label">Hora Salida Primer Corredor:</label>
                                <input type="time" id="first-start-time" class="form-control" value="09:00:00" step="1">
                            </div>
                            <div class="time-config-item">
                                <label class="form-label" id="current-time-label">Hora del Sistema:</label>
                                <div class="time-display" id="current-system-time-display">00:00:00</div>
                            </div>
                            <div class="time-config-item">
                                <label class="form-label" id="time-diff-label">Inicio Cuenta atrás en:</label>
                                <div class="time-display" id="time-difference-display">00:00:00</div>
                            </div>
                            <div class="time-config-item">
                                <label for="total-riders" class="form-label" id="total-riders-label">Total Corredores:</label>
                                <input type="number" id="total-riders" class="form-control" min="1" value="1" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bloque 2 - Botones de acción -->
                    <div class="config-section">
                        <div class="buttons-responsive-container">
                            <button class="responsive-btn btn-primary" id="create-template-btn">
                                <i class="fas fa-file-excel"></i>
                                <span id="create-template-text">Crear Plantilla</span>
                            </button>
                            <button class="responsive-btn btn-success" id="import-order-btn">
                                <i class="fas fa-file-import"></i>
                                <span id="import-order-text">Importar Orden</span>
                            </button>
                            <button class="responsive-btn btn-danger" id="delete-order-btn">
                                <i class="fas fa-trash"></i>
                                <span id="delete-order-text">Eliminar Orden</span>
                            </button>
                            <button class="responsive-btn btn-warning" id="export-order-btn">
                                <i class="fas fa-file-export"></i>
                                <span id="export-order-text">Exportar Orden</span>
                            </button>
                            <button class="responsive-btn btn-info" id="add-rider-btn">
                                <i class="fas fa-user-plus"></i>
                                <span id="add-rider-text">Añadir Corredor</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Bloque 3 - Tabla de orden de salida -->
                    <div class="config-section">
                        <div class="section-title">
                            <i class="fas fa-table"></i>
                            <span id="order-table-label">Orden de Salida</span>
                        </div>
                        <div class="start-order-table-container" id="start-order-table-container">
                            <table class="start-order-table" id="start-order-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="order" id="order-header">Orden</th>
                                        <th class="sortable" data-sort="dorsal" id="dorsal-header">Dorsal</th>
                                        <th class="sortable" data-sort="cronoSalida" id="crono-salida-header">Crono Salida</th>
                                        <th class="sortable" data-sort="horaSalida" id="hora-salida-header">Hora Salida</th>
                                        <th class="sortable" data-sort="nombre" id="nombre-header">Nombre</th>
                                        <th class="sortable" data-sort="apellidos" id="apellidos-header">Apellidos</th>
                                        <th class="sortable" data-sort="chip" id="chip-header">Chip</th>
                                        <th class="sortable" data-sort="horaSalidaReal" id="hora-real-header">Hora Salida Real</th>
                                        <th class="sortable" data-sort="cronoSalidaReal" id="crono-real-header">Crono Salida Real</th>
                                        <th class="sortable" data-sort="horaSalidaPrevista" id="hora-prevista-header">Hora Salida Prevista</th>
                                        <th class="sortable" data-sort="cronoSalidaPrevista" id="crono-prevista-header">Crono Salida Prevista</th>
                                        <th class="sortable" data-sort="horaSalidaImportado" id="hora-importado-header">Hora Salida Importado</th>
                                        <th class="sortable" data-sort="cronoSalidaImportado" id="crono-importado-header">Crono Salida Importado</th>
                                        <th class="sortable" data-sort="cronoSegundos" id="crono-segundos-header">Crono Segundos</th>
                                        <th class="sortable" data-sort="horaSegundos" id="hora-segundos-header">Hora Segundos</th>
                                    </tr>
                                </thead>
                                <tbody id="start-order-table-body">
                                    <!-- Las filas se agregarán aquí dinámicamente -->
                                </tbody>
                            </table>
                            <div id="start-order-empty" class="empty-state" style="display: none;">
                                <i class="fas fa-users"></i>
                                <p id="no-start-order-text">No hay corredores en el orden de salida</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =========================================== -->
            <!-- CONTENIDO DEL MODO SALIDA -->
            <!-- =========================================== -->
            <div id="mode-salida-content" class="mode-content active">
                <!-- Tarjeta de Configuración de Tiempos (Modo Salida) -->
                <div class="app-card time-config-card">
                    <div class="card-header">
                        <h2><i class="fas fa-clock"></i> <span id="card-time-title">Configuración de Tiempo para Salidas</span></h2>
                    </div>
                    <div class="card-body">
                        <div class="config-section">
                            <!-- Configuración de intervalo único -->
                            <div id="single-interval-config" class="time-inputs">
                                <div class="form-group">
                                    <div class="section-title">
                                        <i class="fas fa-stopwatch"></i>
                                        <span id="interval-time-label">Tiempo entre salidas</span>
                                    </div>
                                    <div class="form-row">
                                        <div class="input-with-unit">
                                            <input type="number" id="interval-minutes" class="form-control form-control-sm" min="0" value="1">
                                            <span class="unit" id="minutes-text">minutos</span>
                                        </div>
                                        <div class="input-with-unit">
                                            <input type="number" id="interval-seconds" class="form-control form-control-sm" min="0" max="59" value="0">
                                            <span class="unit" id="seconds-text">segundos</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Mensaje informativo -->
                            <div style="background: #f8f9fa; padding: 15px; border-radius: var(--border-radius); margin-top: 20px; border-left: 4px solid var(--secondary);">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <i class="fas fa-info-circle" style="color: var(--secondary); font-size: 1.2rem;"></i>
                                    <span style="font-weight: 600; color: var(--dark);">Modo simplificado</span>
                                </div>
                                <p style="color: var(--gray); font-size: 0.95rem; line-height: 1.5; margin: 0;">
                                    Todos los corredores saldrán con el mismo intervalo de tiempo configurado arriba. 
                                    Para configuraciones más complejas, puedes ajustar el tiempo del próximo corredor haciendo doble clic en el número durante la cuenta atrás.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tarjeta de Configuración de Audio (Modo Salida) -->
                <div class="app-card audio-config-card">
                    <div class="card-header">
                        <h2><i class="fas fa-volume-up"></i> <span id="audio-config-title">Configuración de Audio para Salidas</span></h2>
                    </div>
                    <div class="card-body">
                        <div class="config-section">
                            <div class="audio-config-section">
                                <div class="audio-options" id="audio-options">
                                    <div class="audio-option active" 
                                        data-audio-type="beep"
                                        title="Beeps electrónicos para cada segundo">
                                        <i class="fas fa-bell"></i>
                                        <div class="option-title" id="beep-option-title">Sonidos Beep</div>
                                    </div>
                                    
                                    <div class="audio-option" 
                                        data-audio-type="voice"
                                        title="Voz humana contando en tu idioma">
                                        <i class="fas fa-microphone-alt"></i>
                                        <div class="option-title" id="voice-option-title">Voz grabada</div>
                                    </div>
                                    
                                    <div class="audio-option" 
                                        data-audio-type="none"
                                        title="Solo efectos visuales">
                                        <i class="fas fa-volume-mute"></i>
                                        <div class="option-title" id="mute-option-title">Sin sonido</div>
                                    </div>
                                </div>
                                
                                <div style="text-align: center; margin-top: 15px;">
                                    <button class="audio-test-btn" id="test-audio-btn">
                                        <i class="fas fa-play-circle"></i>
                                        <span id="test-audio-text">Probar sonido actual</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botón principal de inicio (Modo Salida) -->
                <div class="start-main-btn-container">
                    <div class="system-time-container">
                        <div class="system-time-display">
                            <i class="fas fa-clock"> </i>
                            <span id="current-system-time"> 00:00:00</span>
                        </div>
                    </div>
                    <button class="btn btn-success btn-lg start-main-btn" id="start-countdown-btn">
                        <i class="fas fa-rocket"></i>
                        <span id="start-countdown-text">INICIAR CUENTA ATRÁS</span>
                    </button>
                    
                    <!-- Punto de inicio simplificado -->
                    <div class="start-point-simple">
                        <div class="form-inline-group">
                            <span id="start-from-x-text">Posición actual:</span>
                            <input type="number" id="start-position" class="form-control form-control-sm" min="1" value="1">
                        </div>
                    </div>
                    
                    <button class="btn btn-danger responsive-btn btn-block" id="exit-complete-btn" style="max-width: 400px; margin: 20px auto 0;">
                        <i class="fas fa-sign-out-alt"></i>
                        <span id="exit-complete-text">REINICIAR</span>
                    </button>
                </div>

                <!-- Tarjeta de Salidas Registradas (Modo Salida) -->
                <div class="app-card departures-card">
                    <div class="card-header">
                        <h2><i class="fas fa-history"></i> <span id="card-departures-title">Salidas Registradas</span></h2>
                    </div>
                    <div class="card-body">
                        <div class="config-section">
                            <div class="departures-header">
                                <div class="btn-group">
                                    <button class="btn btn-danger responsive-btn" id="clear-departures-btn">
                                        <i class="fas fa-broom"></i>
                                        <span id="clear-departures-text">Limpiar lista</span>
                                    </button>
                                    <button class="btn btn-success responsive-btn" id="export-excel-btn">
                                        <i class="fas fa-file-excel"></i>
                                        <span id="export-excel-text">Exportar Excel</span>
                                    </button>
                                </div>
                            </div>
                            <div id="departures-table-container" class="departures-table-container">
                                <table class="departures-table" id="departures-table">
                                    <thead>
                                        <tr>
                                            <th class="sortable" data-sort="dorsal" id="departure-header-dorsal">Salida</th>
                                            <th class="sortable" data-sort="timeValue" id="departure-header-time">Tiempo</th>
                                            <th class="sortable" data-sort="notes" id="departure-header-notes">Nota</th>
                                            <th class="sortable" data-sort="date" id="departure-header-date">Hora</th>
                                        </tr>
                                    </thead>
                                    <tbody id="departures-table-body">
                                        <!-- Las filas se agregarán aquí dinámicamente -->
                                    </tbody>
                                </table>
                                <div id="departures-empty" class="empty-state" style="display: none;">
                                    <i class="fas fa-clock"></i>
                                    <p id="no-departures-text">No hay salidas registradas</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =========================================== -->
            <!-- CONTENIDO DEL MODO LLEGADAS -->
            <!-- =========================================== -->
            <div id="mode-llegadas-content" class="mode-content">
                <!-- Cronómetro principal (Modo Llegadas) -->
                <div class="app-card llegadas-timer-card">
                    <div class="card-header">
                        <h2><i class="fas fa-stopwatch"></i> <span id="llegadas-timer-title">Cronómetro de Llegadas</span></h2>
                    </div>
                    <div class="card-body">
                        <div class="llegadas-main-timer">
                            <div class="llegadas-timer-label" id="llegadas-timer-label">
                                Tiempo desde salida del primer corredor:
                            </div>
                            <div class="llegadas-timer-display" id="llegadas-timer-display">00:00:00</div>
                            
                            <div class="llegadas-controls">
                                <button class="btn btn-success" id="start-llegadas-btn">
                                    <i class="fas fa-play"></i>
                                    <span id="start-llegadas-text">Iniciar Cronómetro</span>
                                </button>
                                <button class="btn btn-danger" id="stop-llegadas-btn">
                                    <i class="fas fa-stop"></i>
                                    <span id="stop-llegadas-text">Detener</span>
                                </button>
                                <button class="btn btn-primary" id="register-llegada-btn">
                                    <i class="fas fa-user-check"></i>
                                    <span id="register-llegada-text">Registrar Llegada</span>
                                </button>
                                <button class="btn btn-warning" id="import-llegadas-btn">
                                    <i class="fas fa-file-import"></i>
                                    <span id="import-llegadas-text">Importar Salidas</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de llegadas registradas (Modo Llegadas) -->
                <div class="app-card llegadas-list-card">
                    <div class="card-header">
                        <h2><i class="fas fa-list-ol"></i> <span id="llegadas-list-title">Llegadas Registradas</span></h2>
                    </div>
                    <div class="card-body">
                        <div class="llegadas-table-container">
                            <table class="llegadas-table" id="llegadas-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-sort="dorsal" id="llegada-header-dorsal">Dorsal</th>
                                        <th class="sortable" data-sort="nombre" id="llegada-header-nombre">Nombre</th>
                                        <th class="sortable" data-sort="horaSalida" id="llegada-header-salida">Hora Salida</th>
                                        <th class="sortable" data-sort="horaLlegada" id="llegada-header-llegada">Hora Llegada</th>
                                        <th class="sortable" data-sort="tiempoCrono" id="llegada-header-crono">Tiempo Crono</th>
                                        <th class="sortable" data-sort="notas" id="llegada-header-notas">Notas</th>
                                    </tr>
                                </thead>
                                <tbody id="llegadas-table-body">
                                    <!-- Las filas se agregarán aquí dinámicamente -->
                                </tbody>
                            </table>
                            <div id="llegadas-empty" class="empty-state">
                                <i class="fas fa-clock"></i>
                                <p id="no-llegadas-text">No hay llegadas registradas</p>
                            </div>
                        </div>
                        
                        <div class="llegadas-actions" style="margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap;">
                            <button class="btn btn-danger" id="clear-llegadas-btn">
                                <i class="fas fa-broom"></i>
                                <span id="clear-llegadas-text">Limpiar llegadas</span>
                            </button>
                            <button class="btn btn-success" id="export-llegadas-btn">
                                <i class="fas fa-file-excel"></i>
                                <span id="export-llegadas-text">Exportar Excel</span>
                            </button>
                            <button class="btn btn-info" id="show-ranking-btn">
                                <i class="fas fa-trophy"></i>
                                <span id="show-ranking-text">Ver Clasificación</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Botón flotante para registro rápido -->
                <button class="quick-register-btn" id="quick-register-btn" title="Registrar llegada rápida">
                    <i class="fas fa-flag-checkered"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- =========================================== -->
    <!-- PANTALLA DE EJECUCIÓN (REDISEÑADA) -->
    <!-- =========================================== -->
    <div class="countdown-screen" id="countdown-screen">
        <div class="config-toggle" id="config-toggle">
            <i class="fas fa-cog"></i>
        </div>

        <div class="countdown-container">
            <div class="countdown-label" id="countdown-label">Salida en</div>
            <div class="countdown-display" id="countdown-display">60</div>
        </div>

        <div class="info-corner top-left">
            <span class="info-label" id="total-time-label">Tiempo total</span>
            <div class="info-value" id="total-time-value">00:00:00</div>
            <div class="info-value" id="current-time-value">00:00:00</div>
        </div>
        
        <div class="info-corner bottom-left">
            <span class="info-label" id="next-corredor-label">Próximo sale a</span>
            <div class="info-value inline-edit" id="next-corredor-time">1:00</div>
        </div>
        
        <div class="info-corner bottom-right">
            <span class="info-label" id="departed-label">Salidos</span>
            <div class="info-value inline-edit" id="departed-count">0</div>
        </div>

        <div class="salida-display" id="salida-display">SALIDA</div>
    </div>

    <!-- =========================================== -->
    <!-- FOOTER -->
    <!-- =========================================== -->
    <footer class="app-footer hide-on-countdown">
        <div class="container">
            <div class="footer-content">
                <div class="footer-left">
                    <button class="footer-btn" id="footer-help-btn">
                        <i class="fas fa-question-circle"></i>
                        <span id="help-text">Ayuda</span>
                    </button>
                    <button class="footer-btn" id="suggestions-btn">
                        <i class="fas fa-lightbulb"></i>
                        <span id="suggestions-text">Sugerencias</span>
                    </button>
                    <button class="footer-btn" id="install-btn">
                        <i class="fas fa-download"></i>
                        <span id="install-text">Instalar App</span>
                    </button>
                    <button class="footer-btn" id="update-btn">
                        <i class="fas fa-sync-alt"></i>
                        <span id="update-text">Buscar actualizaciones</span>
                    </button>
                </div>
                <div class="copyright" id="copyright-text">
                    2025 © Copyright 
                    <a href="https://rbenet71.github.io/Web/" target="_blank" id="copyright-link">
                        Roberto Benet - rbenet71@gmail.com - V_19_12_2025
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- =========================================== -->
    <!-- MODALES -->
    <!-- =========================================== -->
    
    
    <!-- Modal de configuración de plantilla -->
    <div id="template-config-modal" class="modal">
        <div class="modal-content medium-modal">
            <div class="modal-header">
                <h3>Configurar Plantilla de Salida</h3>
                <span id="template-config-modal-close" class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="template-num-corredores">Número de corredores:</label>
                    <input type="number" id="template-num-corredores" 
                        min="1" max="1000" value="10" 
                        class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="template-intervalo">Intervalo entre salidas (HH:MM:SS):</label>
                    <input type="text" id="template-intervalo" 
                        value="00:01:00" 
                        placeholder="00:01:00"
                        class="form-control" 
                        pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
                    <small class="form-text">Ej: 00:01:00 para 1 minuto, 00:02:30 para 2 minutos y 30 segundos</small>
                </div>
                
                <div class="form-group">
                    <label for="template-hora-inicio">Hora de inicio (HH:MM:SS):</label>
                    <input type="text" id="template-hora-inicio" 
                        value="09:00:00" 
                        placeholder="09:00:00"
                        class="form-control" 
                        pattern="[0-9]{2}:[0-9]{2}:[0-9]{2}">
                    <small class="form-text">Ej: 09:00:00 para las 9 de la mañana</small>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancel-template-btn" class="btn btn-secondary">Cancelar</button>
                <button id="generate-template-btn" class="btn btn-primary">Generar Plantilla</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de ayuda -->
    <div class="modal" id="help-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="help-modal-title">Ayuda de Crono CRI</h3>
                <button class="modal-close" id="help-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="help-modal-text1">Crono CRI es una aplicación para controlar las salidas en carreras con cuenta atrás visual y sonora.</p>
                
                <h4 id="help-modal-subtitle1">Cómo usar:</h4>
                <ul id="help-modal-list">
                    <li><strong>Selecciona una carrera</strong> o crea una nueva</li>
                    <li><strong>Configura la cadencia de salida</strong> (siempre igual o por tramos)</li>
                    <li><strong>Inicia desde el corredor 1</strong> o desde una posición específica</li>
                    <li><strong>Pulsa "INICIAR CUENTA ATRÁS"</strong> para comenzar</li>
                    <li><strong>La pantalla cambiará</strong> mostrando la cuenta atrás grande</li>
                    <li><strong>Cuando llegue a cero</strong> se mostrará "SALIDA" y comenzará la cuenta para el siguiente</li>
                </ul>
                
                <h4 id="help-modal-subtitle2">Indicadores visuales:</h4>
                <ul>
                    <li><strong id="red-background-text">Fondo ROJO:</strong> <span id="countdown-normal-desc">Cuenta atrás normal</span></li>
                    <li><strong id="yellow-background-text">Fondo AMARILLO:</strong> <span id="countdown-warning-desc">Últimos 10 segundos</span></li>
                    <li><strong id="green-background-text">Fondo VERDE:</strong> <span id="countdown-salida-desc">Momento de salida (2 segundos)</span></li>
                    <li><strong id="red-numbers-text">Números ROJOS pulsantes:</strong> <span id="countdown-critical-desc">Últimos 5 segundos</span></li>
                </ul>
                
                <h4 id="help-modal-subtitle3">Sonidos:</h4>
                <ul>
                    <li><strong id="beep-high-text">Beep agudo:</strong> <span id="beep-high-desc">Al llegar a 10 segundos</span></li>
                    <li><strong id="beep-every-second-text">Beep cada segundo:</strong> <span id="beep-every-second-desc">Últimos 5 segundos</span></li>
                    <li><strong id="beep-low-text">Beep grave:</strong> <span id="beep-low-desc">Al llegar a cero</span></li>
                </ul>
                
                <p id="help-modal-text2">Los 2 segundos de "SALIDA" se restan automáticamente del tiempo de la siguiente cuenta atrás.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="help-modal-ok">Entendido</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación reiniciar/salir -->
    <div class="modal" id="restart-confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="restart-modal-title">Confirmar reinicio completo</h3>
                <button class="modal-close" id="restart-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="restart-modal-text">¿Estás seguro de que quieres reiniciar completamente? Esta acción:</p>
                <ul style="margin: 15px 0; padding-left: 20px;">
                    <li>Detendrá la cuenta atrás si está activa</li>
                    <li>Borrará todos los datos de la sesión actual</li>
                    <li>Reiniciará los contadores a cero</li>
                    <li>Volverá a la pantalla de configuración inicial</li>
                </ul>
                <p style="color: var(--danger); font-weight: 600;">
                    Esta acción no se puede deshacer.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="restart-confirm-btn">Sí, reiniciar completamente</button>
                <button class="btn" id="restart-cancel-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de configuración durante cuenta atrás -->
    <div class="modal" id="config-during-countdown-modal">
        <div class="modal-content config-modal-during-countdown">
            <div class="modal-header">
                <h3>Configuración</h3>
                <button class="modal-close" id="config-during-countdown-close">&times;</button>
            </div>
            <div class="modal-body">
                <p>La cuenta atrás continúa en segundo plano.</p>
                <div class="modal-buttons-container">
                    <button class="btn btn-success" id="resume-countdown-btn">
                        <i class="fas fa-play"></i> Continuar viendo
                    </button>
                    <button class="btn btn-warning" id="stop-countdown-btn">
                        <i class="fas fa-stop"></i> Detener cuenta atrás
                    </button>
                    <button class="btn btn-primary" id="adjust-times-btn">
                        <i class="fas fa-edit"></i> Ajustar tiempos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de ajuste de tiempos -->
    <div class="modal" id="adjust-times-modal">
        <div class="modal-content config-modal-during-countdown">
            <div class="modal-header">
                <h3>Ajustar Tiempos</h3>
                <button class="modal-close" id="adjust-times-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="config-line" style="flex-direction: column; align-items: stretch;">
                    <label for="adjust-next-time">Próximo tiempo (segundos):</label>
                    <input type="number" id="adjust-next-time" class="config-input" min="1" value="60">
                </div>
                <div class="config-line" style="flex-direction: column; align-items: stretch;">
                    <label for="adjust-departed">Corredores salidos:</label>
                    <input type="number" id="adjust-departed" class="config-input" min="0" value="0">
                </div>
                <div class="modal-buttons-container">
                    <button class="btn btn-success" id="save-adjustments-btn">
                        <i class="fas fa-save"></i> Guardar ajustes
                    </button>
                    <button class="btn" id="cancel-adjustments-btn">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación eliminar carrera -->
    <div class="modal" id="delete-race-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="delete-race-modal-title">Confirmar eliminación</h3>
                <button class="modal-close" id="delete-race-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="delete-race-modal-text">¿Estás seguro de que quieres eliminar esta carrera? Todos los datos se perderán.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="delete-race-confirm-btn">Eliminar</button>
                <button class="btn" id="delete-race-cancel-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de confirmación limpiar salidas -->
    <div class="modal" id="clear-departures-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="clear-departures-modal-title">Confirmar limpieza</h3>
                <button class="modal-close" id="clear-departures-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="clear-departures-modal-text">¿Estás seguro de que quieres limpiar la lista de salidas? Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" id="clear-departures-confirm-btn">Limpiar</button>
                <button class="btn" id="clear-departures-cancel-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de sugerencias -->
    <div class="modal" id="suggestions-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="suggestions-modal-title">Enviar sugerencias</h3>
                <button class="modal-close" id="suggestions-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="suggestion-form">
                    <div class="config-line" style="flex-direction: column; align-items: stretch;">
                        <label for="suggestion-email" id="suggestion-email-label">Email (opcional):</label>
                        <input type="email" id="suggestion-email" class="config-input" placeholder="tu@email.com">
                    </div>
                    <div class="config-line" style="flex-direction: column; align-items: stretch;">
                        <label for="suggestion-text" id="suggestion-text-label">Sugerencias:</label>
                        <textarea id="suggestion-text" class="config-input" rows="5" placeholder="Tus ideas para mejorar la aplicación..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="send-suggestion-btn">Enviar</button>
                <button class="btn" id="cancel-suggestion-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de nueva carrera -->
    <div class="modal" id="new-race-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="new-race-modal-title">Nueva carrera</h3>
                <button class="modal-close" id="new-race-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-race-name" id="new-race-name-label">Nombre de la carrera:</label>
                    <input type="text" 
                        id="new-race-name" 
                        class="form-control config-input" 
                        placeholder="Ej: Carrera MTB 2025"
                        maxlength="100">
                </div>
                <div class="form-group">
                    <label for="new-race-description" id="new-race-desc-label">Descripción (opcional):</label>
                    <textarea id="new-race-description" 
                            class="form-control config-input" 
                            rows="4" 
                            placeholder="Información adicional sobre la carrera..."
                            maxlength="500"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" id="create-race-btn">Crear carrera</button>
                <!-- Este ID es diferente en tu HTML y en las traducciones -->
                <button class="btn btn-outline" id="cancel-create-race-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para registro de llegada -->
    <div class="modal" id="register-llegada-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="register-llegada-modal-title">Registrar Llegada</h3>
                <button class="modal-close" id="register-llegada-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="llegada-form">
                    <div class="config-line" style="flex-direction: column; align-items: stretch;">
                        <label for="llegada-dorsal" id="llegada-dorsal-label">Dorsal del corredor:</label>
                        <input type="number" id="llegada-dorsal" class="config-input" min="1" placeholder="Ej: 101">
                    </div>
                    <div class="config-line" style="flex-direction: column; align-items: stretch;">
                        <label for="llegada-hora" id="llegada-hora-label">Hora de llegada:</label>
                        <input type="text" id="llegada-hora" class="config-input" value="00:00:00" readonly>
                    </div>
                    <div class="config-line" style="flex-direction: column; align-items: stretch;">
                        <label for="llegada-notas" id="llegada-notas-label">Notas (opcional):</label>
                        <textarea id="llegada-notas" class="config-input" rows="3" placeholder="Observaciones sobre la llegada..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" id="confirm-llegada-btn">Registrar Llegada</button>
                <button class="btn" id="cancel-llegada-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de importación de salidas para llegadas -->
    <div class="modal" id="import-salidas-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="import-salidas-modal-title">Importar Datos de Salidas</h3>
                <button class="modal-close" id="import-salidas-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="import-salidas-modal-text">Selecciona el archivo Excel con los datos de salidas de los corredores.</p>
                <input type="file" id="salidas-file-input" accept=".xlsx,.xls,.csv" style="width: 100%; padding: 10px; margin-top: 10px;">
                <div id="import-preview" style="margin-top: 20px; display: none;">
                    <h4>Vista previa de datos:</h4>
                    <div id="import-preview-content" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="confirm-import-salidas-btn">Importar</button>
                <button class="btn" id="cancel-import-salidas-btn">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de clasificación -->
    <div class="modal" id="ranking-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="ranking-modal-title">Clasificación de la Carrera</h3>
                <button class="modal-close" id="ranking-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="ranking-table-container">
                    <table class="llegadas-table" id="ranking-table">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Dorsal</th>
                                <th>Nombre</th>
                                <th>Tiempo Crono</th>
                                <th>Diferencia</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-table-body">
                            <!-- Las filas se agregarán aquí dinámicamente -->
                        </tbody>
                    </table>
                    <div id="ranking-empty" class="empty-state">
                        <i class="fas fa-trophy"></i>
                        <p id="no-ranking-text">No hay suficientes datos para generar la clasificación</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" id="export-ranking-btn">
                    <i class="fas fa-file-excel"></i> Exportar Clasificación
                </button>
                <button class="btn" id="close-ranking-btn">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Video oculto para mantener pantalla activa -->
    <video id="keep-alive-video" style="display: none;" muted playsinline>
        <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4">
    </video>

    <!-- Mensajes flotantes -->
    <div id="message" class="message"></div>

    <!-- =========================================== -->
    <!-- SCRIPT JAVASCRIPT CORREGIDO -->
    <!-- =========================================== -->
    <!-- Scripts -->
    <script src="Crono_CRI_traducciones.js"></script>
    <script src="Crono_CRI_ui.js"></script>
    <script src="Crono_CRI_utilidades.js"></script>
    <script src="Crono_CRI.js"></script>
    
    <!-- Script para XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>