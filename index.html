<!DOCTYPE html>
<html lang="es">
<head>
    <!-- ... todo el contenido anterior permanece igual hasta el script ... -->
</head>
<body>
    <!-- ... todo el contenido del body permanece igual ... -->

    <script>
        // ... todo el script anterior permanece igual hasta la parte del Service Worker ...

        // ========== SERVICE WORKER CORREGIDO ==========
        
        // Variables para prevenir bucle de actualización
        let reloadCount = 0;
        const maxReloads = 2;
        let lastUpdateTime = 0;
        const UPDATE_COOLDOWN = 60000; // 1 minuto entre actualizaciones
        
        // Registro del Service Worker para index.html
        if ('serviceWorker' in navigator) {
            // Solo registrar para la página principal
            if (window.location.pathname.endsWith('/') || 
                window.location.pathname.endsWith('index.html') ||
                !window.location.pathname.includes('Calculadora_Tiempos')) {
                
                navigator.serviceWorker.register('unified-sw.js')
                .then(function(registration) {
                    console.log('ServiceWorker Index registrado: ', registration.scope);
                    
                    // Verificar si hay actualizaciones disponibles (solo cuando se registra)
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('Nueva versión del Service Worker encontrada');
                        
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    // Hay una actualización disponible
                                    console.log('Nueva versión instalada, esperando activación');
                                    // No llamar automáticamente a showUpdateNotificationIndex()
                                }
                            }
                        });
                    });
                })
                .catch(function(error) {
                    console.log('Error al registrar ServiceWorker Index: ', error);
                });
            }
        }

        // Escuchar mensajes del Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data && event.data.type === 'SW_UPDATED') {
                    console.log('Service Worker actualizado a versión:', event.data.version);
                    // No actualizar automáticamente, solo mostrar notificación
                    setTimeout(() => {
                        showUpdateNotificationIndex();
                    }, 2000);
                }
            });
        }

        // Mostrar notificación de actualización para index.html
        function showUpdateNotificationIndex() {
            const now = Date.now();
            
            // Prevenir múltiples notificaciones en poco tiempo
            if (now - lastUpdateTime < UPDATE_COOLDOWN) {
                console.log('Ignorando notificación de actualización (en período de enfriamiento)');
                return;
            }
            
            lastUpdateTime = now;
            
            // Crear notificación para que el usuario decida
            const shouldUpdate = confirm('Hay una nueva versión disponible. ¿Quieres actualizar ahora?');
            
            if (shouldUpdate) {
                updateIndexApp();
            }
        }

        // Función para actualizar la aplicación index
        function updateIndexApp() {
            // Prevenir bucle
            reloadCount++;
            
            if (reloadCount > maxReloads) {
                console.log('Se detuvo el bucle de actualización - límite alcanzado');
                reloadCount = 0;
                return;
            }
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    // Enviar mensaje al SW para que se active
                    if (registration.waiting) {
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    }
                    
                    // Recargar la página después de un breve delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                });
            } else {
                window.location.reload();
            }
        }

        // Verificar actualización al cargar la página (con precaución)
        window.addEventListener('load', () => {
            if ('serviceWorker' in navigator) {
                // Esperar 3 segundos antes de verificar para estabilizar la página
                setTimeout(() => {
                    navigator.serviceWorker.ready.then(registration => {
                        if (registration.waiting) {
                            // Verificar cuándo fue la última actualización
                            const lastUpdate = localStorage.getItem('lastSWUpdateCheck');
                            const now = Date.now();
                            
                            // Solo verificar si pasó al menos 5 minutos desde la última verificación
                            if (!lastUpdate || (now - parseInt(lastUpdate)) > 300000) { // 5 minutos
                                console.log('Nueva versión encontrada en la espera');
                                // Mostrar notificación después de un delay
                                setTimeout(() => {
                                    showUpdateNotificationIndex();
                                }, 3000);
                                localStorage.setItem('lastSWUpdateCheck', now.toString());
                            }
                        }
                    });
                }, 3000);
            }
        });

        // Botón manual para buscar actualizaciones (mejorado)
        function addUpdateButtonToIndex() {
            if (!document.getElementById('manual-update-btn')) {
                const updateBtn = document.createElement('button');
                updateBtn.id = 'manual-update-btn';
                updateBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Buscar Actualizaciones';
                updateBtn.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 1000;
                    padding: 10px 15px;
                    background: linear-gradient(135deg, #2ecc71, #27ae60);
                    color: white;
                    border: none;
                    border-radius: 25px;
                    cursor: pointer;
                    font-size: 14px;
                    font-weight: 600;
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.3s ease;
                `;
                updateBtn.onmouseover = () => {
                    updateBtn.style.transform = 'translateY(-3px)';
                    updateBtn.style.boxShadow = '0 6px 12px rgba(0, 0, 0, 0.3)';
                };
                updateBtn.onmouseout = () => {
                    updateBtn.style.transform = 'translateY(0)';
                    updateBtn.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
                };
                updateBtn.onclick = checkForUpdatesIndex;
                document.body.appendChild(updateBtn);
            }
        }

        function checkForUpdatesIndex() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.update().then(() => {
                        // Mostrar mensaje de éxito
                        const successMsg = document.createElement('div');
                        successMsg.textContent = '✓ Búsqueda de actualizaciones completada';
                        successMsg.style.cssText = `
                            position: fixed;
                            bottom: 80px;
                            right: 20px;
                            background: #2ecc71;
                            color: white;
                            padding: 10px 15px;
                            border-radius: 5px;
                            z-index: 1000;
                            font-size: 14px;
                            animation: fadeInOut 3s ease;
                        `;
                        document.body.appendChild(successMsg);
                        
                        // Crear animación CSS temporal
                        const style = document.createElement('style');
                        style.textContent = `
                            @keyframes fadeInOut {
                                0% { opacity: 0; transform: translateY(10px); }
                                20% { opacity: 1; transform: translateY(0); }
                                80% { opacity: 1; transform: translateY(0); }
                                100% { opacity: 0; transform: translateY(10px); }
                            }
                        `;
                        document.head.appendChild(style);
                        
                        setTimeout(() => {
                            successMsg.remove();
                            style.remove();
                        }, 3000);
                    });
                });
            } else {
                console.log('Service Worker no disponible');
            }
        }

        // Añadir el botón de actualización manual después de que el DOM esté cargado
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                addUpdateButtonToIndex();
            }, 2000);
            
            // Resetear contador de recargas cada minuto
            setInterval(() => {
                reloadCount = 0;
            }, 60000);
        });

        // ... resto del script permanece igual ...
    </script>
</body>
</html>